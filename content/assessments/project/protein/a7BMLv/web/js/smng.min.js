function highlightSelectedResidues(){for(var e in document.querySelectorAll(".hoverResidue").forEach(e=>e.classList.remove("hoverResidue")),document.querySelectorAll(".selectResidue").forEach(e=>e.classList.remove("selectResidue")),chainMapping.structures)for(var t in chainMapping.structures[e]){var n=chainMapping.structures[e][t].filter(e=>e.selected).map(e=>e.resno);if(0<n.length){var i,a=document.querySelectorAll('.alignTbl tr[struc_id^="'+e+'"][chain="'+t+'"]');for(i of n)for(var s of a){s=s.querySelector('span[s="'+i+'"]');if(s){s.classList.add("selectResidue");break}}}}}function addSettingsPopover(){$("a[id^=options_]").css("visibility","visible").each(function(){$(this).popover({html:!0,placement:$(this).attr("pop-placement")?$(this).attr("pop-placement"):"auto",content:$("#alignmentOptions"),container:1==$(this).closest("#viewerWrapper").length?"#right-panel":"body"})}).on("show.bs.popover",function(e){let t=$(this).attr("id").substring(8);$("#currentAlignmentIndex").val(t),1==$("#exportOptions").length?($("#alignmentOptions").show(),""==t?$("#exportOptions").hide():$("#exportOptions").show()):$("a[id^=options_]").each(function(){$(this).data("bs.popover")&&$(this).data("bs.popover").$tip&&1==$(this).data("bs.popover").$tip.find("#exportOptions").length&&(""==t?$(this).data("bs.popover").$tip.find("#exportOptions").hide():$(this).data("bs.popover").$tip.find("#exportOptions").show())})})}function resetChainMappingColours(e){for(var t in chainMapping.structures)for(var n in chainMapping.structures[t])if(!e||e.includes(n))for(var i in chainMapping.structures[t][n])delete chainMapping.structures[t][n][i].rgb}!function(N){let e=!1,_=!1,x=null,g=!1,w=0,M=0,C=[[136,221,204],[213,178,64],[187,187,221],[255,136,119],[136,187,221],[255,187,102],[187,221,102],[255,204,238],[166,206,227],[187,136,187],[204,238,204],[166,206,227]],l={init:function(t){return e||(e=!0,N(document).on("keydown",function(e){if(_&&N(".fancybox-desktop:visible").length<1){var t=e;if(g)t.preventDefault();else{var n=N("span.cursor").closest(".alignTbl");if(32==t.keyCode)t.preventDefault(),m();else if(8==t.keyCode||46==t.keyCode)t.preventDefault(),v(8==t.keyCode);else{if(27==t.keyCode)return void(n.data("startEditRegion",null),n.data("endEditRegion",null),N(".shadowCursor").removeClass("shadowCursor"));if((t.ctrlKey||t.metaKey)&&90==t.keyCode)return void function(e){var t=N("body").data("editHistory");var n;null==t||t.length<1||(t=t.pop(),i(e,t,!0,!0),0<(n=N(".alignTbl").not(e)).length&&(i(n,t,!0,!1),N(".cursor").removeClass("cursor"),e.find("tr[seqno="+x.seqno+"]").find("span").eq(x.seqidx).addClass("cursor")))}(n)}E(null,t)}}else"Escape"===e.key&&(N(".hoverResidue").removeClass("hoverResidue"),N(".selectResidue").removeClass("selectResidue"),document.body.dispatchEvent(new CustomEvent("selectResidues",{detail:{src:"alignment"}})))})),this.each(function(){var e=N.extend({},{type:"target-template",chaingroups:[],keyseq_sequence:t.keyseq_sequence,keyseq_chain_name:t.keyseq_chain_name||["A"],keyseq_annotation:t.keyseq_annotation},t.templateData);t.nowrap&&(e.nowrap=!0),t.charts&&(e.qmLength=0,e.charts=t.charts,e.pageResidueCount=t.pageResidueCount),t.resetColourCycle&&(w=0),t.firstDraw=!0,N(this).data("templateData",e),B(N(this),null,t),l.toggleIdenticalSeqs.call(this,{chaingroups:e.chaingroups},!1),l.resizeToParent.call(N(this),{redrawAnnotation:!1}),z(N(this)),n(N(this))})},toggleIdenticalSeqs:function(t,e){return N(this).each(function(){var n=N(this),i=L(n);for(let e=0;e<t.chaingroups.length;e++){var a=t.chaingroups[e].filter(function(){return!0});if(!(a.length<2)){var s=a[0],r=i.find('tr[chain="'+s+'"]').first().text(),o=r.substring(0,r.lastIndexOf(".")+1)+"("+a.join("")+")",r=r.substring(0,r.lastIndexOf("."))+"."+s.charAt(0);let t="";for(let e=1;e<a.length;e++)t+="[chain="+a[e]+"]",e<a.length-1&&(t+=",");n.find("tr"+t).toggle(),i.find("tr"+t).toggle(),"none"==i.find("tr[chain="+a[1]+"]").css("display")?i.find("tr[chain="+s+"]").find("td").html(o):i.find("tr[chain="+s+"]").find("td").html(r)}}void 0!==e&&!e||z(n)})},drawAlignment:function(e){return this.each(function(){B(N(this),e?e.seqs:null,e||null),n(N(this))})},getFormattedAlignment:function(e){return t(N(this).attr("id").substring(8),e.format)},exportAlignment:function(e){return this.each(function(){N("#formattedAlignment").show(),N("#alignmentFormatSelect").val(e.format),s(),N("<a href='#formattedAlignment' title='Copy & Paste Alignment'/>'").fancybox({helpers:{title:{type:"inside"}}}).trigger("click"),N("#formattedAlignmentTextarea").focus(),N("#formattedAlignmentTextarea").select()})},html2image:function(e){N.fancybox&&N.fancybox.close(),N(".popover").hide();var e=function(e){$alignNameTbl=L(e);let t=e.closest(".alignTblContainer").outerWidth(),n=e.closest(".alignTblContainer").outerHeight(),a='<svg xmlns="http://www.w3.org/2000/svg"  width="'+(t+=10)+'" height="'+n+'"><rect x="0" y="0" fill="white" width="'+t+'" height="'+n+'"/>',s,i=$alignNameTbl.outerWidth()+10,r=$alignNameTbl.offset().left-10,o=e.find("td:visible:eq(0)"),l=o.outerWidth(),u=N("<div>").append(N("#"+e.attr("id")+"_features svg").first().clone()).html().replace(/name="[\d_]+" /g,"").replace(/r="4" /g,""),c=(a=(a=(a+='<defs><clipPath id="cp2"><rect x="0" y="0" width="'+l+'" height="'+n+'"/></clipPath></defs>')+'<g transform="translate('+i+',0)" clip-path="url(#cp2)">')+u.substring(u.indexOf("</defs>")+7,u.indexOf("</svg>"))+"</g>",e.find("tr:visible"));c.each(function(e,n){N(this).find("span.ligandContact").each(function(e,t){s=n.offsetTop+t.offsetTop,h||(h=N(t).outerWidth(),d=N(t).outerHeight()),a+='<rect style="fill:#CC4444;fill-opacity:0.8;" width="'+h+'" height="'+d+'" x="'+(N(t).offset().left-r)+'" y="'+s+'" />'})}),a+='<text text-anchor="end" font-size="'+o.css("font-size")+"\" font-family='"+o.css("font-family")+"'>",(c=$alignNameTbl.find("tr:visible")).each(function(e,t){let n=N(this).find("td").css("padding-top");n=parseInt(n.substring(0,n.length-2)),s=t.offsetTop+12+n,a+='<tspan x="'+(i-2)+'" y="'+s+'">'+t.textContent.replace("QMEAN","")+"</tspan>"}),a+="</text>",c=e.find("tr:visible");let h,d;return c.each(function(e,n){a+='<text text-anchor="middle" font-size="'+o.css("font-size")+"\" font-family='"+o.css("font-family")+"'>",N(this).find("span").each(function(e,t){if(h||(h=N(t).outerWidth(),d=N(t).outerHeight()),"relative"!=t.style.position){let e=N(t).css("color");e="fill:"+e+";","bold"==t.style.fontWeight&&(e+="font-weight:bold;"),0<e.length&&(e=' style="'+e+'" '),s=n.offsetTop+t.offsetTop+12,a+='<tspan x="'+(N(t).offset().left-r+h/2)+'" y="'+s+'"'+e+">"+t.textContent+"</tspan>"}}),a+="</text>",(td=N(this).find("td")[1])&&(a+='<text text-anchor="start" font-size="'+o.css("font-size")+"\" font-family='"+o.css("font-family")+"'><tspan x=\""+(N(td).offset().left-r+10)+'" y="'+s+'">'+td.textContent+"</tspan></text>")}),c.each(function(e,i){N(this).find("span").not(".ligandContact").each(function(e,t){s=i.offsetTop+t.offsetTop;var n=N(t).css("backgroundColor");n&&"transparent"!=n&&"rgb(255, 255, 255)"!=n&&(a+='<rect x="'+(N(t).offset().left-r)+'" y="'+s+'" width="'+h+'" height="'+d+'" style="fill:'+n+';"/>')})}),a+"</svg>"}(N("#"+(e&&e.alignId?e.alignId:"alignTbl"+N("#currentAlignmentIndex").val()))),e=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),e=(window.URL||window.webkitURL||window).createObjectURL(e),t=new Image;let n=document.createElement("canvas"),i=n.getContext("2d");t.onload=function(){n.width=this.naturalWidth,n.height=this.naturalHeight,i.drawImage(this,0,0),n.toBlob(function(e){saveAs(e,"alignment.png")},"image/png")},t.src=e},colourAllAlignments:function(i){resetChainMappingColours(i.onlyChains),i.features?N(i.alignmentIds?i.alignmentIds.map(e=>"#alignTbl"+e).join(","):".alignTbl").each(function(){let n=[];N(this).find("tr[struc_id]").each(function(e,t){t=t.getAttribute("struc_id");-1==n.indexOf(t)&&n.push(t)});var e,t={};for(e in i.features)-1<n.indexOf(e)?t[e]=i.features[e]:-1<n.indexOf(e+".dna")&&(t[e+".dna"]=i.features[e]);0==Object.keys(t).length?N(this).removeData("features"):N(this).data("features",t),D("features",N(this))}):(i.col?i.col!=chainMapping.defaultColourScheme&&i.col!=jQuery.cookie("colourScheme")&&jQuery.cookie("colourScheme",i.col,{expires:365,path:"/"}):(i.col=chainMapping.defaultColourScheme,i.col||(i.col=jQuery.cookie("colourScheme"))),N(i.alignmentIds?i.alignmentIds.map(e=>"#alignTbl"+e).join(","):".alignTbl").each(function(){N(this).removeData("features"),D(i.col,N(this))})),h()},changeExportFormat:function(e){return this.each(function(){s()})},secondaryStructure:function(e){e&&jQuery.cookie("secStruct",e.sstype,{expires:365,path:"/"});let l=null;null==(l=e?e.sstype:N.cookie("secStruct"))&&(l="dssp");var e=this.each(function(){N(this).data("templateData")&&(z(N(this)),"secstruc"==N.cookie("colourScheme"))&&D("secstruc",N(this))}),i=null;let a=null,t=null;if("undefined"!=typeof globalTemplateData?"undefined"!=typeof globalTemplateData&&(a=globalTemplateData):N(this).data("templateData")&&("model-template"==N(this).data("templateData").type?t=!0:(a=[],this.each(function(){N(this).data("templateData")&&(a=a.concat(N(this).data("templateData").templates))}))),0<N("#pv:visible",currentWin.document).length&&"undefined"!=typeof pv_viewer){if(t)this.each(function(){var a=N(this).data("templateData");if(a){var e=a.struc_id;if(pv_viewer.get(e)){var s=pv_viewer.get(e).structure();pv_viewer.rm(e);let i="none"==l;if(!i)for(let e=0;e<a.keyseq_chain_name.length;e++){var r=a.keyseq_chain_name[e];let t=a.templates[0].trg_offset,n=(t=t||1,a.keyseq_annotation[r][l+"_string"]);r=s.select({chain:r});n?r.eachResidue(function(e){e.full().setSS(n[e.num()-t])}):i=!0}i&&s.select("protein").eachResidue(function(e){e.full().setSS("")}),pv_viewer.cartoon(e,s,{color:pv.color.uniform("white")})}}});else for(let n=0;n<a.length;n++)if(a[n].selected){var s=a[n].struc_id,i=pv_viewer.get(s).structure();if(pv_viewer.rm(s),"none"==l)i.select("protein").eachResidue(function(e){e.full().setSS("")});else if(a[n].targets)for(let e=0;e<a[n].targets.length;e++){var r=a[n].targets[e];for(let e=0;e<r.chain.length;e++)annotation=(annotation=r.annotation[r.chain[e]][l+"_string"])||r.annotation[r.chain[e]][l],i.select({chain:r.chain[e]}).eachResidue(function(e){e.full().setSS(annotation[e.num()-1])})}else{let t=a[n].annotation[l+"_string"];t=t||a[n].annotation[l],i.select({chain:a[n].chain}).eachResidue(function(e){e.full().setSS(t?t[e.num()-1]:"")})}pv_viewer.cartoon(s,i,{color:pv.color.uniform("white")})}}else if(0<N("#ngl:visible",currentWin.document).length&&void 0!==ngl_stage)if(t)this.each(function(){var s=N(this).data("templateData");if(s){var r=s.struc_id;let a="none"==l;for(let e=0;e<s.keyseq_chain_name.length;e++){let t=s.keyseq_chain_name[e],n=s.templates[0].trg_offset,i=(n=n||1,s.keyseq_annotation[t][l+"_string"]);for(var o in i||(a=!0),ngl_stage.compList)if(ngl_stage.compList[o].name==r){ngl_stage.compList[o].structure.eachResidue(function(e){e.chainname==t&&(a?e.sstruc="":e.sstruc=i[e.resno-n].toLowerCase())});break}}}});else for(let i=0;i<a.length;i++)if(a[i].selected){if(ngl_stage.eachRepresentation(function(e){if(e.name&&!e.name.match(/(ligands|dna|over)/)){var t,n=e.name;for(t in ngl_stage.compList)ngl_stage.compList[t].name==n&&ngl_stage.compList[t].removeRepresentation(e)}}),"none"==l)for(var n in ngl_stage.compList)ngl_stage.compList[n].name==a[i].struc_id&&ngl_stage.compList[n].structure.eachResidue(function(e){e.sstruc=""});else if(a[i].targets)for(let e=0;e<a[i].targets.length;e++){let n=a[i].targets[e];for(let t=0;t<n.chain.length;t++)for(var o in annotation=(annotation=n.annotation[n.chain[t]][l+"_string"])||n.annotation[n.chain[t]][l],ngl_stage.compList)if(ngl_stage.compList[o].name==a[i].struc_id){ngl_stage.compList[o].structure.eachResidue(function(e){e.chainname==n.chain[t]&&(e.sstruc=annotation[e.resno-1].toLowerCase())});break}}else for(var u in annotation=a[i].annotation[l+"_string"]?a[i].annotation[l+"_string"]:a[i].annotation[l],ngl_stage.compList)if(ngl_stage.compList[u].name==a[i].struc_id){ngl_stage.compList[u].structure.eachResidue(function(e){e.chainname==a[i].chain&&(e.sstruc=annotation?annotation[e.resno-1].toLowerCase():"")});break}for(var c in struc_id=a[i].struc_id,ngl_stage.compList)ngl_stage.compList[c].name==struc_id&&ngl_stage.compList[c].addRepresentation("cartoon",{name:struc_id,sele:"not :_ and not nucleic and not :-",smoothSheet:!0,aspectRatio:6,roughness:1})}return changeRep(N.cookie("defaultRepr")),h(),e},targetMismatch:function(t){return t.match?jQuery.cookie("targetMismatch",t.match,{expires:365,path:"/"}):jQuery.removeCookie("targetMismatch",{path:"/"}),this.each(function(){var e;N(this).find("span.targetMismatch").removeClass("targetMismatch"),"fade"==t.match?(N("#enhanceMismatch_cb").prop("checked",!1),N(this).find("span[nm]").addClass("targetMismatch")):"enhance"==t.match&&(N("#fadeMismatch_cb").prop("checked",!1),(e=N(this).find("span")).not("[nm]").addClass("targetMismatch"),e.not("[s]").addClass("targetMismatch"))})},viewerInitialised:function(e){let t=null;t=chainMapping.defaultColourScheme||(N(this).data("features")?"features":N.cookie("colourScheme")),-1<["qmean_local","confClass","bfactor","bfactor_range","secstruc","lddt"].indexOf(t)?N(".alignTbl:first").alignment("colourAllAlignments",{col:t}):h(e)},updateColoursSingleResidue:function(e){h({singleResidue:e})},resizeToParent:function(e,o){return o=!e||e.redrawAnnotation,this.each(function(){var n=N(this);if(n.is(":visible")&&n.data("templateData")){var i=N(this).find("tr:visible td").first(),a=i.find("span").first()[0];if(a){var s=n.width()-i.width(),r=n.parent().closest("table").parent();let e=r.width()-(n.offset().left-r.offset().left)-s;r.css("maxHeight")&&(e-=8),n.data("templateData").nowrap&&(e=1e7);s=i.text().length;let t=Math.floor(e/a.getBoundingClientRect().width);n.data("options").textOnly&&(t=Math.floor(e/(i.width()/i.text().length))),(t-=t%5)<1&&(t=5);r=0<n.find("tr:hidden").length,a=n.data("templateData").chaingroups;t!=s?(n.attr("cols_cookie")&&N.cookie(n.attr("cols_cookie"),t,{expires:365,path:"/"}),B(n,null,{cols:t}),o&&z(n),r&&l.toggleIdenticalSeqs.call(n,{chaingroups:a})):(o&&z(n),N("#"+(i=n).attr("id")+"_features").css("top",i.position().top))}}})},toggleEditMode:function(e){(_=e&&null!=e.edit?e.edit:!_)?(N("a[id^=gapEdit_]").css("opacity",1),N(".hoverResidue").removeClass("hoverResidue"),null==x&&(x={seqno:1,seqidx:0}),N(this).find("tr[seqno="+x.seqno+"]").find("span").eq(x.seqidx).addClass("cursor")):(N("a[id^=gapEdit_]").css("opacity",.6),N(".cursor").removeClass("cursor"))},removeGappedColumns:function(e){var t=N(this).data("templateData").templates,n=function(t,n){let i="",a="";for(let e=0;e<t.length;e++)"-"==t.charAt(e)&&"-"==n.charAt(e)||(i+=t.charAt(e),a+=n.charAt(e));return[i,a]}(t[0].trg_seq,t[0].tpl_seq);t[0].trg_seq=n[0],t[0].tpl_seq=n[1],B(N(this))}};function L(e){return N("#alignNameTbl"+e.attr("id").substring(8))}function n(l){N(document).on("mouseup",function(){if(N.data(l,"downchain")){var t=N("#offscreen_selection span");if(window.getSelection&&0<t.length){var n,i=[];let e=null;for(n of document.querySelectorAll("tr[struc_id] span.selectResidue")){var a,s=n.closest("tr");e=s.getAttribute("struc_id"),s&&(a=s.getAttribute("chain"),i.push({chain:a||s.getAttribute("keyseqchain"),resno:parseInt(n.getAttribute("s"))}))}document.body.dispatchEvent(new CustomEvent("selectResidues",{detail:{src:"alignment",struc_id:e,residues:i}}));var r=window.getSelection(),o=document.createRange();o.setStart(t.get(0),0),o.setEndAfter(t.get(-1),0),r.addRange(o)}else document.selection&&document.selection.empty();N.data(l,"downchain",null)}l.data("mouseDragEdit",null)}),N(document).on("mousemove",function(){N.data(l,"downchain")&&(window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty())}),l.off(),l.data("templateData")&&l.data("templateData").charts?l.on("mouseover mousemove mousedown mouseup dblclick","td",function(e){var t,n,i=N(this).find("span");0!=i.length&&(t=i[0].getBoundingClientRect().width,n=e.pageX||e.pageY?e.pageX-N(this).offset().left:e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-N(this).offset().left,i=N(i[Math.floor(n/t)]),a(l,i,e))}):l.on("mouseover mousedown mouseup dblclick","span",function(e){a(l,N(this),e)}),l.on("mouseleave",e=>{document.querySelectorAll(".hoverResidue").forEach(e=>e.classList.remove("hoverResidue")),document.body.dispatchEvent(new CustomEvent("highlightResidue",{detail:{src:"alignment"}}))})}let f=null;function a(e,s,r){var o=s.text();if(_&&function(n,t){if(t.stopPropagation(),t.preventDefault(),!g){var i=n.closest(".alignTbl"),a=n.closest("tr"),s=n.closest("tr").attr("seqno"),r=a.attr("chain");if(r||(a.attr("keyseqtype"),keyseqchain=a.attr("keyseqchain")),"mouseover"!=t.type)if("dblclick"==t.type)!n.hasClass("shadowCursor")||i.data("mouseDragEdit")||("-"==n.text()?v:m)();else if("mousedown"==t.type){if(!n.hasClass("shadowCursor")){r=N(".shadowCursor").first();if(t.shiftKey&&r){if(r.closest("tr").attr("seqno")!=s)return;{N(".shadowCursor").removeClass("shadowCursor");var a=i.find("tr[seqno="+s+"]").find("span");let e=a.index(r),t=a.index(n);e<t?(i.data("startEditRegion",r),i.data("endEditRegion",n)):(o=e,e=t,t=o,i.data("startEditRegion",n),i.data("endEditRegion",r)),a.slice(e,t).each(function(){N(this).addClass("shadowCursor")}),i.data("mouseDragEdit",!1)}}else N(".shadowCursor").removeClass("shadowCursor"),n.addClass("shadowCursor"),i.data("mouseDragEdit",!0),i.data("startEditRegion",n),i.data("endEditRegion",n)}N(".cursor").removeClass("cursor"),n.addClass("cursor")}else if("mousemove"==t.type){var o=window.getSelection?window.getSelection():document.selection;if(o&&(o.removeAllRanges?o.removeAllRanges():o.empty&&o.empty()),i.data("mouseDragEdit")){r=i.data("startEditRegion");if(0!=r.length){let e=0;e=t.pageX>r.offset().left?(t.pageX-r.offset().left)/r.outerWidth()|0:(t.pageX-r.offset().left-r.outerWidth())/r.outerWidth()|0,N(".shadowCursor").removeClass("shadowCursor"),0<e?r.nextAll(":lt("+e+")").addClass("shadowCursor"):e<0&&r.prevAll().slice(0,Math.abs(e)).each(function(){N(this).addClass("shadowCursor")}),r.addClass("shadowCursor")}}}else"mouseup"==t.type&&i.data("startEditRegion")&&(a=i.find("tr[seqno="+s+"]").find("span"),x={seqno:s,seqidx:a.index(n)},i.data("startEditRegion",N("span.shadowCursor").first()),i.data("endEditRegion",N("span.shadowCursor").last()),i.data("mouseDragEdit",!1))}}(s,r),"-"!==o){var i=s.attr("s");if(i){var l=s.closest("tr");let n=l.attr("chain");n=n||(l.attr("keyseqchain")?l.attr("keyseqchain"):null);var u=l.attr("struc_id"),c=l.attr("seqno"),l=c+u+"_"+l.index()+"_"+s.index();if("mousemove"===r.type){if(f===l)return;r.type="mouseover"}else if("mouseup"===r.type){if(u&&n){N.data(e,"downspan")[0]===s[0]&&(s.hasClass("selectResidue")?s.removeClass("selectResidue"):s.addClass("selectResidue"));var t,a=[];for(t of document.querySelectorAll('tr[struc_id="'+u+'"] span.selectResidue')){var h,d=t.closest("tr");d&&(h=d.getAttribute("chain"),a.push({chain:h||d.getAttribute("keyseqchain"),resno:parseInt(t.getAttribute("s"))}))}document.body.dispatchEvent(new CustomEvent("selectResidues",{detail:{src:"alignment",struc_id:u,residues:a}}))}return}f=l;var p,l=e.data("templateData");if("mouseover"===r.type){if($[o.toUpperCase()]){let t=$[o.toUpperCase()].triplet+" "+i+(n?" "+n:"");if(s.attr("rx")&&(t+="\nResidue missing from template structure!\n"),chainMapping.structures[u])for(let e=0;e<chainMapping.annotations.length;e++)chainMapping.annotations[e].active&&null!=chainMapping.structures[u][n][i][chainMapping.annotations[e].key]&&(p=chainMapping.structures[u][n][i][chainMapping.annotations[e].key],t+="; "+chainMapping.annotations[e].label+": "+("number"==typeof p?p.toFixed("ramachandran"==chainMapping.annotations[e].key?4:2):p));s.attr("title",t),s[0]!==r.target&&r.target.setAttribute("title",t)}n&&document.body.dispatchEvent(new CustomEvent("highlightResidue",{detail:{src:"alignment",struc_id:u,chain:n,resno:parseInt(i),mouseDown:null!=N.data(e,"downchain")},bubbles:!0}))}if(!_&&l)if("mousedown"===r.type)N.data(e,"downspan",s),N.data(e,"downchain",c+u),N(".hoverResidue").removeClass("hoverResidue"),r.ctrlKey||r.metaKey||s.hasClass("selectResidue")||N(".selectResidue").removeClass("selectResidue");else if("mouseover"===r.type)if(N.data(e,"downchain")&&(window.getSelection?(window.getSelection().removeAllRanges(),document.createRange()):document.selection&&document.selection.empty()),u&&n&&(document.querySelectorAll(".hoverResidue").forEach(e=>e.classList.remove("hoverResidue")),null==N.data(e,"downchain"))&&s.addClass("hoverResidue"),u&&n&&N.data(e,"downchain")===c+u&&(null==N.data(e,"lastMouseDrag")||N.data(e,"lastMouseDrag")!==c+u+s.index())){N.data(e,"lastMouseDrag",c+u+s.index());o=e.find(`tr[seqno=${c}][struc_id="${u}"]`);let t=N.data(e,"downspan"),n=s,i=o.index(t.closest("tr")),a=o.index(n.closest("tr"));(i>a||i===a&&t.index()>n.index())&&(l=i,n=t,t=s,i=a,a=l),t.index()==n.index()&&i==a||(document.querySelectorAll(".hoverResidue").forEach(e=>e.classList.remove("hoverResidue")),r.ctrlKey||r.metaKey||document.querySelectorAll(".selectResidue").forEach(e=>e.classList.remove("selectResidue")),t.addClass("selectResidue"),n.addClass("selectResidue"),o.each(function(e){e<i||e>a||(e==i?t.nextUntil(n):e==a?n.prevUntil(n):N(this).find("span")).addClass("selectResidue")}));c=e.find(".selectResidue");0<c.length&&(N("#offscreen_selection").html(""),c.clone().appendTo(N("#offscreen_selection")),window.getSelection?(s=window.getSelection(),(l=document.createRange()).setStart(N("#offscreen_selection span").get(0),0),l.setEndAfter(N("#offscreen_selection span").get(-1),0),s.addRange(l)):document.selection&&document.selection.empty())}}}}function P(t,n){if(!(null==n||n.length<1)){let e=N("body").data("editHistory");(e=null==e?[]:e).push(n),N("body").data("editHistory",e);t=N(".alignTbl").not(t);return 0<t.length&&(i(t,n,!1),N(".cursor").removeClass("cursor")),1}}function i(e,t,r,o){e.each(function(){if(null!=N(this).data("templateData")){var i=N(this).data("templateData").templates,a=t;for(let n=0;n<a.length;n++){var s=a[n];for(let t=0;t<s.length;t++)for(let e=0;e<i.length;e++)if(i[e].id==s[t].template.id){r?(i[e].trg_seq=s[t].trg_seq,i[e].tpl_seq=s[t].tpl_seq):(i[e].trg_seq=s[t].template.trg_seq,i[e].tpl_seq=s[t].template.tpl_seq),o&&(x=s[t].currentCursor,n==a.length-1)&&k(i[e]);break}}N(this).is(":visible")&&B(N(this),null,{firstDraw:!1})}})}function k(i){if(!(N("#seqid_"+i.id).length<1)){let t=0,n=0;for(let e=0;e<i.trg_seq.length;e++)"-"==i.trg_seq.charAt(e)||"-"==i.tpl_seq.charAt(e)?t++:i.trg_seq.charAt(e)==i.tpl_seq.charAt(e)&&n++;N("#seqid_"+i.id).text((n/(i.trg_seq.length-t)*100).toFixed(2))}}function E(s,r){if(null==s&&(38==r.keyCode?s="up":40==r.keyCode?s="down":37==r.keyCode?s="left":39==r.keyCode&&(s="right")),null!=s){r&&r.preventDefault();var r=N("span.cursor").first(),o=r.closest("tr"),l=o.attr("seqno"),u=r.index();let e=u;var c,h=o.prevAll("[seqno="+l+"]");let t;0<h.length&&(t=h.find("span"),e+=t.length);let n,i=l,a=e;"up"==s&&0<o.index()?(c=o.prev(),i=c.attr("seqno"),n=c.find("span:eq("+u+")")):"down"==s&&0<o.next().length?(c=o.next(),i=c.attr("seqno"),n=c.find("span:eq(rowidx)"),n=(n=o.next().find("span")).length>u?n.eq(u):n.last()):"left"==s?0==r.prev().length?0<h.length&&(n=t.last(),a--):(n=r.prev(),a--):"right"==s&&(0<r.next().length?(n=r.next(),a++):0<(c=o.nextAll("[seqno="+l+"]:eq(0)")).length&&(n=c.find("span").first(),a++)),null!=n&&(r.removeClass("cursor"),n.addClass("cursor"),x={seqno:i,seqidx:a})}}function m(){var l=[],e=N("span.cursor").first(),u=e.closest("tr"),c=u.attr("seqno"),h=u.closest(".alignTbl");if(!e.hasClass("shadowCursor")){if(0!=h.find("span.shadowCursor").length)return;e.addClass("shadowCursor")}if(null!=h.data("templateData")){var d=h.find("span.shadowCursor").last();let t=d.index();var p=d[0]==e[0],g=h.find("tr");let n=d.closest("tr"),i=N(),a=0;g.filter("[seqno="+c+"]").each(function(){a++;var e=N(this).find("span");if(N(this)[0]==n[0])return i=i.add(e.slice(0,t+1)),!1;i=i.add(e)});var f=i.index(e),m=i.text(),v=h.data("templateData").templates,b=u.attr("keyseqchain")||u.attr("keyseqtype");let s,r="",o=b?null:g.filter("[seqno=1]").slice(0,a);d=e.nextAll(".shadowCursor").addBack();for(let e=0;e<v.length;e++)if(!(null==v[e].selected||v[e].selected<1)){if(b)s=v[e].trg_seq,r=v[e].tpl_seq,o=g.filter("[seqno="+(v[e].selected+1)+"]").slice(0,a);else{if(v[e].selected!=c-1)continue;s=v[e].tpl_seq,r=v[e].trg_seq}strEdit2=o.find("span").slice(0,m.length).text();let t="",n=!1,i=!1;for(let e=0;e<m.length;e++)if(e<f)t+=s.charAt(t.length);else if(n){if("-"==m.charAt(e)){t+=s.charAt(t.length-1),i=!0;break}t+=s.charAt(t.length-1)}else t+="-",n=!0;i?s=t+s.substring(t.length):n&&(s=t+s.substring(t.length-1),p||(r=r.substring(0,t.length-1)+"-"+r.substring(t.length-1))),s.length>r.length?r+=Array(s.length-r.length+1).join("-"):r.length>s.length&&(s+=Array(r.length-s.length+1).join("-"));var y={template:v[e],trg_seq:v[e].trg_seq,tpl_seq:v[e].tpl_seq,currentCursor:{seqno:x.seqno,seqidx:x.seqidx}};b?(v[e].trg_seq=s,v[e].tpl_seq=r):(v[e].trg_seq=r,v[e].tpl_seq=s),k(v[e]),l[l.length]=y}1==d.length&&N(".shadowCursor").removeClass("shadowCursor"),0<l.length?(E("right"),h.data("templateData"),p&&(h.data("startEditRegion",null),h.data("endEditRegion",null)),P(h,[l])&&B(h,null,{firstDraw:!1})):R(e,"The pairwise alignment already contains a gap at this position")}}function R(e,t){g=!0,e.removeAttr("title").popover({html:!0,content:t,container:"body"}).popover("show"),setTimeout(function(){e.popover("destroy"),g=!1},2e3)}function v(e){var u=[];let c=N("span.cursor").first();var h=c.closest("tr"),d=h.attr("seqno"),p=h.closest(".alignTbl"),g=p.find("span.shadowCursor").length<2;if(e){if("-"!=c.prev().text())return;g&&c.removeClass("shadowCursor"),(c=c.prev()).addClass("shadowCursor")}else if("-"!=c.text())return;if(null!=p.data("templateData")){if(!c.hasClass("shadowCursor")){if(0!=p.find("span.shadowCursor").length)return;c.addClass("shadowCursor")}var f=p.find("span.shadowCursor").last();let t=f.index();var m=p.find("tr");let n=f.closest("tr"),i=N(),a=0;m.filter("[seqno="+d+"]").each(function(){a++;var e=N(this).find("span");if(N(this)[0]==n[0])return i=i.add(e.slice(0,t+1)),!1;i=i.add(e)});var v=i.index(c),b=i.text(),y=p.data("templateData").templates,_=h.attr("keyseqchain")||h.attr("keyseqtype");let s,r,o="",l=_?null:m.filter("[seqno=1]").slice(0,a);for(let e=0;e<y.length;e++)if(!(null==y[e].selected||y[e].selected<1)){if(_)s=y[e].trg_seq,r=y[e].tpl_seq,l=m.filter("[seqno="+(y[e].selected+1)+"]").slice(0,a);else{if(y[e].selected!=d-1)continue;s=y[e].tpl_seq,r=y[e].trg_seq}o=l.find("span").slice(0,b.length).text();let t="",n=!0,i=!1;for(let e=0;e<b.length;e++)if(e!=v)if(e<v)t+=s.charAt(t.length);else if("-"==b.charAt(e)){if("-"!=o.charAt(e)){if(i){gapmoved=!0;break}t+="-",n=!1}}else i=!0,n,t+=s.charAt(t.length+1);(s=g?t+s.substring(t.length+1):t+"-"+s.substring(t.length+1)).length>r.length?r+=Array(s.length-r.length+1).join("-"):r.length>s.length&&(s+=Array(r.length-s.length+1).join("-"));var w={template:y[e],trg_seq:y[e].trg_seq,tpl_seq:y[e].tpl_seq,currentCursor:{seqno:x.seqno,seqidx:x.seqidx}};_?(y[e].trg_seq=s,y[e].tpl_seq=r):(y[e].trg_seq=r,y[e].tpl_seq=s),k(y[e]),u[u.length]=w}0<u.length?(e&&E("left"),g&&(p.data("startEditRegion",null),p.data("endEditRegion",null)),P(p,[u])&&B(p,null,{firstDraw:!1})):R(c,"<div>No valid gaps to be deleted in the selected range</div>")}}function A(t,n){let i=t.templates?function(t,n){let a=0,s=[],i=[],r=[],o=[],l="";if(N.each(t.templates,function(e,t){!t||n&&!t.selected||t.trg_seq&&(r[r.length]=t,s[s.length]="",i[s.length]=0,o[o.length]=0,a=Math.max(t.trg_seq.length,a))}),r.sort(function(e,t){return e.selected<t.selected?-1:e.selected>t.selected?1:0}),0!=r.length){let e=null,i=(t.keyseq_sequence?e=t.keyseq_sequence:(e=r[0].trg_seq,t.templates[0].up_res_num||(e=e.replace(/-/g,""))),0);for(;i<a;){let t=0,n=0;for(let e=0;e<r.length;e++){for(n=0;"-"==r[e].trg_seq.charAt(o[e]+n);)n++;t=Math.max(n,t)}for(n=0;n<t;)l+="-",n++;l+=e.charAt(i++);for(let e=0;e<r.length;e++)if(r[e].tpl_seq){for(n=0;"-"==r[e].trg_seq.charAt(o[e]);)s[e]+=r[e].tpl_seq.charAt(o[e]++),n++;for(;n<t;)s[e]+="-",n++;s[e]+=r[e].tpl_seq.charAt(o[e]++)}}return s.target=l,k((s.templates=r)[0]),s}}(t,!0):null;if(!i)if((i=[]).templates=["empty"],t.keyseq_sequence)i.target=t.keyseq_sequence;else for(let e=0;e<t.templates.length;e++)if(t.templates[e].trg_seq){i.target=t.templates[e].trg_seq.replace(/-/g,"");var a=t.templates[e].trg_seq.length-i.target.length;1===t.templates.length&&0<a&&N("#alignmentWarning_"+n.attr("id").substring(8)).html(`<div class="alert alert-warning">
                           <button type="button" class="close" data-dismiss="alert">&times;</button>
                           <strong>Note: </strong> ${a} gaps were removed from your target sequence
                         </div>`);break}return i}let S={};function B(a,l,u){var c=L(a);a.removeData("clustalColours");let h=a.data().templateData;if(h=h||N("#alignTbl").data().templateData){l=l||A(h,a);let t=0;for(let e=0;e<l.length;e++){var d=l[e].match(/[a-zA-Z]/g);d&&(t+=d.length)}var p,g={cols:60,fastDraw:!1,textOnly:2e4<t,showResiduePosition:!0},g=(0==(u=a.data("options")?N.extend(a.data("options"),u):(!(u=u||{}).cols&&a.attr("cols_cookie")&&N.cookie(a.attr("cols_cookie"))&&(u.cols=N.cookie(a.attr("cols_cookie"))),N.extend(g,u))).cols&&(u.cols=50),u.cols=parseInt(u.cols),a.attr("id").substring(8)),f=u.fastDraw;u.textOnly?(N("#alignTbl"+g+"_features").remove(),a.off()):f&&(N("#alignTbl"+g+"_features").html(""),(p=S["timer"+g])&&clearTimeout(p),u.fastDraw=!1,p=setTimeout(function(){B(a,l)},10),S["timer"+g]=p),a.data("options",u);let e=document.getElementById(a.attr("id"));for(;e.hasChildNodes();)e.removeChild(e.lastChild);for(e=document.getElementById(c.attr("id"));e&&e.hasChildNodes();)e.removeChild(e.lastChild);let s;var m="SEQRES"===(s=(s=h.target_name||("model-template"==h.type?h.struc_id:h.type.split("-")[0])).charAt(0).toUpperCase()+s.substring(1)).toUpperCase();let n,r=(n=(void 0!==h.templates&&h.templates[0].modelAtomSeqs?h.templates[0].modelAtomSeqs[0].seq:l.target).length,""),o="";if(h.nowrap){r='<tr><td style="padding-top:0px;">',o='<tr><td style="padding-top:0px;border-right:none">&nbsp;</td></tr>';for(let e=l.templates[0].trg_offset;e<n+l.templates[0].trg_offset;e++)0<e&&(0<e&&e%10==0?r+='<span style="position:relative;color:#A2A2A2;">&nbsp;<span style="position:absolute;left:0px;top:8px;font-size:.7em;">|</span>'+`<span style="position:absolute;left:0px;top:0px;font-size:.8em;">${e}</span></span>`:r+="<span>&nbsp;</span>")}r+="</td></tr>";var v={},b={};for(let a=0;a<n;a+=u.cols){let i=1;for(let n=0;n<h.keyseq_chain_name.length;n++){var y=[];let e;e=void 0!==h.templates&&h.templates[0].modelAtomSeqs?h.templates[0].modelAtomSeqs[n].seq:l.target;var _=h.keyseq_chain_name[n];o+='<tr seqno="'+i+'" '+I(h.keyseq_description)+"><td"+(0<a&&0==n||h.charts?' style="position:relative; padding-top:10px" ':"")+">"+s+(1<h.keyseq_chain_name.length?":"+_:"")+"</td></tr>";let t=l.templates[0].trg_offset||1;void 0!==h.templates&&h.templates[0].modelAtomSeqs&&(t=h.templates[0].modelAtomSeqs[n].trg_offset),r+=`<tr seqno="${i}" keyseqtype="${h.type}"`,!h.struc_id||u.textOnly&&u.fastDraw||(r+=` struc_id="${h.struc_id}" keyseqchain="${_}"`),r+=`><td${0<a&&0==n||h.charts?' style="padding-top:10px" ':""}>`,u.fastDraw?r+=T(e.substring(a,a+u.cols)):u.textOnly?r+=`<span>${e.substring(a,a+u.cols)}</span>`:(r+=V(e.substring(a,a+u.cols),{alIndex:a,pos:q(e.substring(0,a)),offset:t,annotation:h.keyseq_annotation?h.keyseq_annotation[_]:null,seqres:m,up_res_num:h.templates&&h.templates[n]&&h.templates[n].up_res_num?h.templates[n].up_res_num:null,resmap:y,keyseq:!0}),v[_]||(v[_]=[]),v[_]=v[_].concat(y)),r+="</td></tr>",i+=1}for(let e=0;e<l.length;e++){var w="model-template"!=h.type&&l.templates[e].struc_id?[]:null,x=h.templates[0].modelAtomSeqs?h.templates[0].modelAtomSeqs[e].seq:l.target;l.templates[e].tpl_seq?(o+=`<tr seqno="${i}" chain="${l.templates[e].chain}${I(l.templates[e].description)}"><td nowrap align="left">${l.templates[e].qname}</td></tr>`,r+=`<tr seqno="${i}" `+(u.textOnly&&u.fastDraw||"model-template"==h.type||!l.templates[e].struc_id?"":' struc_id="'+l.templates[e].struc_id+'"')+' qname="'+l.templates[e].qname+'" chain="'+l.templates[e].chain+'"><td nowrap align="left">',u.fastDraw?r+=T(l[e].substring(a,a+u.cols)):u.textOnly?r+="<span>"+l[e].substring(a,a+u.cols)+"</span>":(r+=V(l[e].substring(a,a+u.cols),{alIndex:a,pos:q(l[e].substring(0,a)),offset:l.templates[e].offset?l.templates[e].offset+1:1,seqres:m,annotation:l.templates[e].annotation,targetSeq:x.substring(a,a+u.cols),pdb_res_num:h.templates[e].pdb_res_num?h.templates[e].pdb_res_num.slice(a,a+u.cols):null,resmap:w,keyseq:!1}),w&&(b[l.templates[e].struc_id]||(b[l.templates[e].struc_id]={}),b[l.templates[e].struc_id][l.templates[e].chain]||(b[l.templates[e].struc_id][l.templates[e].chain]=[]),b[l.templates[e].struc_id][l.templates[e].chain]=b[l.templates[e].struc_id][l.templates[e].chain].concat(w))),r+="</td></tr>",i+=1):i+=1}}if(!chainMapping.alignments.includes(a.attr("id"))){if(h.modelLabel)if("model-template"==h.type)for(var M in v)chainMapping.chainMeta[h.struc_id]||(chainMapping.chainMeta[h.struc_id]={}),chainMapping.chainMeta[h.struc_id][M]||(chainMapping.chainMeta[h.struc_id][M]={display:h.modelLabel});else for(let e=0;e<h.templates.length;e++)chainMapping.chainMeta[h.templates[e].struc_id]||(chainMapping.chainMeta[h.templates[e].struc_id]={}),chainMapping.chainMeta[h.templates[e].struc_id][h.templates[e].chain]||(chainMapping.chainMeta[h.templates[e].struc_id][h.templates[e].chain]={display:h.modelLabel});if(chainMapping.alignments.push(a.attr("id")),"model-template"===h.type)for(var C in v){h.md5&&(chainMapping.targets[h.md5]||(chainMapping.targets[h.md5]={}),chainMapping.targets[h.md5][h.struc_id]||(chainMapping.targets[h.md5][h.struc_id]=[])),chainMapping.structures[h.struc_id]||(chainMapping.structures[h.struc_id]={}),chainMapping.structures[h.struc_id][C]||(chainMapping.structures[h.struc_id][C]=[]);for(let n=0;n<v[C].length;n++)if(v[C][n]){let e=!1,t={};chainMapping.structures[h.struc_id][C][v[C][n][1]]&&(e=!0,t=chainMapping.structures[h.struc_id][C][v[C][n][1]]),t.trgno=v[C][n][1],t.trgname=v[C][n][0],t.chn=C,t.resno=v[C][n][1],t.resname=v[C][n][0],3==v[C][n].length&&(v[C][n][2].qmean&&(t.qm=v[C][n][2].qmean),v[C][n][2].qmeanBrane&&(t.qmb=v[C][n][2].qmeanbrane),v[C][n][2].consistency)&&(t.c=v[C][n][2].consistency),e||(h.md5&&(chainMapping.targets[h.md5][h.struc_id][v[C][n][1]]||(chainMapping.targets[h.md5][h.struc_id][v[C][n][1]]=[]),chainMapping.targets[h.md5][h.struc_id][v[C][n][1]].push(t)),chainMapping.structures[h.struc_id][C][v[C][n][1]]=t)}}else for(var P in v)for(let n=0;n<v[P].length;n++)for(var k in b)for(var E in chainMapping.targets[h.md5]||(chainMapping.targets[h.md5]={}),chainMapping.targets[h.md5][k]||(chainMapping.targets[h.md5][k]=[]),chainMapping.structures[k]||(chainMapping.structures[k]={}),b[k])if(chainMapping.structures[k][E]||(chainMapping.structures[k][E]=[]),null!=b[k][E][n]){let e=!1,t={};chainMapping.structures[k][E][b[k][E][n][1]]&&(e=!0,t=chainMapping.structures[k][E][b[k][E][n][1]]),t.chn=E,[t.resname,t.resno]=b[k][E][n],v[P][n]&&(t.trgname=v[P][n][0],t.trgno=v[P][n][1]),3==b[k][E][n].length&&(b[k][E][n][2].qmean&&(t.qm=b[k][E][n][2].qmean),b[k][E][n][2].qmeanbrane&&(t.qmb=b[k][E][n][2].qmean),b[k][E][n][2].consistency)&&(t.c=b[k][E][n][2].consistency),e||(v[P][n]&&(chainMapping.targets[h.md5][k][v[P][n][1]]||(chainMapping.targets[h.md5][k][v[P][n][1]]=[]),chainMapping.targets[h.md5][k][v[P][n][1]].push(t)),chainMapping.structures[k][E][b[k][E][n][1]]=t)}}g=N.cookie("secStruct");g&&"none"===g||a.addClass("ss"),c.last().append(o),a.last().append(r);let i;!h.nowrap&&u.showResiduePosition&&a.find("tr:visible").each(function(e,t){i="";var n=N(this).find("span[s]").last().attr("s");n&&N(this).append(`<td style="padding-left:8px; font-size:.8em; text-align:right; ${i}">${n}</td>`)}),f||(chainMapping.defaultColourScheme?(N(`#${chainMapping.defaultColourScheme}Button`).prop("checked",!0),D(chainMapping.defaultColourScheme,a)):D(N.cookie("colourScheme"),a),l=null,highlightSelectedResidues(),u.firstDraw)||z(a)}}function q(e){e=e.match(/[^-]/g);return e?e.length:0}function I(e){return e?` title="${e}"`:""}function T(t){let n="";for(let e=0;e<t.length;e++)n+=`<span>${t.charAt(e)}</span>`;return n}function V(r,o){if(!r)return"";let t=o.pos;var l=o.alIndex,e=o.seqres,u=null!=o.targetSeq,c=[];let h=null;for(let s=0;s<r.length;s++){var d=r.charAt(s);let i=null,a=null;if("-"==d)c.push('<span nm="true">-</span>'),o.resmap&&o.resmap.push(null);else{if(o.pdb_res_num){i=o.pdb_res_num[s],a=i-o.offset;var n=o.pdb_res_num[s-1],p=o.pdb_res_num[s],g=o.pdb_res_num[s+1];null!=n&&n!=p-1&&n!=p?(0<s&&"-"==r.charAt(s-1)&&(c[s-1]=c[s-1].substring(0,c[s-1].length-9)+' class="insert_r">-</span>'),c.push(`<span s="${i}" r="${d.toUpperCase()}" ${u&&o.targetSeq.charAt(s)!=d?' nm="true"':""} class="insert_l">${d}</span>`)):g&&p!=g-1&&g!=p?(c.push(`<span s="${i}" r="${d.toUpperCase()}" ${u&&o.targetSeq.charAt(s)!=d?' nm="true"':""} class="insert_r">${d}</span>`),s<r.length-2&&"-"==r.charAt(s+1)&&(c.push('<span nm="true" class="insert_l">-</span>'),s++)):c.push(`<span s="${i}" r="${d.toUpperCase()}" ${u&&o.targetSeq.charAt(s)!=d?' nm="true"':""}>${d}</span>`)}else if(o.up_res_num){a=l+s;let e=o.up_res_num[l+s-1],t=o.up_res_num[l+s],n=o.up_res_num[l+s+1];null==t&&(h+=1,t=h),null==n&&(e=t-1,n=t+1),i=t,c.push(`<span ${0<l+s&&e!=t-1?'class="insert_l"':""} ${l+s<l+r.length-1&&t!=n-1?'class="insert_r"':""} s="${t}" r="${d.toUpperCase()}" ${u&&o.targetSeq.charAt(s)!=d?' nm="true"':""}>${d}</span>`),h=t}else if(e)a=l+s,i=l+s+o.offset,c.push(`<span s="${i}" r="${d.toUpperCase()}" ${u&&o.targetSeq.charAt(s)!=d?' nm="true"':""}>${d}</span>`);else{a=t,i=t+o.offset;let e=!1;o.annotation&&o.annotation.dssp&&(o.annotation.dssp_string?"X"===o.annotation.dssp_string.charAt(i-1)&&-1<o.annotation.dssp_string.search(/[^X\-]/)&&(e=!0):"X"===o.annotation.dssp.charAt(i-1)&&-1<o.annotation.dssp.search(/[^X\-]/)&&(e=!0)),c.push(`<span s="${i}" r="${d.toUpperCase()}"${u&&o.targetSeq.charAt(s)!=d?' nm="true"':""}${e?' rx="true"':""}>${d}</span>`),t++}if(o.resmap){n=[d.toUpperCase(),i];if(o.annotation){var f,m={};for(f in o.annotation)o.annotation[f]&&null!=o.annotation[f][a]&&(m[f]=o.annotation[f][a]),o.keyseq&&"qmean"===f&&null==o.annotation.qmean[a]&&(c[c.length-1]='<span nores="true" '+c[c.length-1].substring(6));n.push(m)}o.resmap.push(n)}}}return c.join("")}function H(e,t,n){e[n][t]?e[n][t]++:e[n][t]=1}const $={A:{name:"Alanine",triplet:"ALA",hydrophobic:.7,size:.11},C:{name:"Cysteine",triplet:"CYS",hydrophobic:.78,size:.35},D:{name:"Aspartate",triplet:"ASP",hydrophobic:.11,size:.45},E:{name:"Glutamate",triplet:"GLU",hydrophobic:.11,size:.56},F:{name:"Phenylalanine",triplet:"PHE",hydrophobic:.81,size:.7},G:{name:"Glycine",triplet:"GLY",hydrophobic:.46,size:0},H:{name:"Histidine",triplet:"HIS",hydrophobic:.14,size:.62},I:{name:"Isoleucine",triplet:"ILE",hydrophobic:1,size:.43},K:{name:"Lysine",triplet:"LYS",hydrophobic:.07,size:.55},L:{name:"Leucine",triplet:"LEU",hydrophobic:.92,size:.43},M:{name:"Methionine",triplet:"MET",hydrophobic:.71,size:.57},N:{name:"Asparagine",triplet:"ASN",hydrophobic:.11,size:.44},P:{name:"Proline",triplet:"PRO",hydrophobic:.32,size:.31},Q:{name:"Glutamine",triplet:"GLN",hydrophobic:.11,size:.55},R:{name:"Arginine",triplet:"ARG",hydrophobic:0,size:.77},S:{name:"Serine",triplet:"SER",hydrophobic:.41,size:.23},T:{name:"Threonine",triplet:"THR",hydrophobic:.42,size:.34},V:{name:"Valine",triplet:"VAL",hydrophobic:.97,size:.32},W:{name:"Tryptophan",triplet:"TRP",hydrophobic:.4,size:1},Y:{name:"Tyrosine",triplet:"TYR",hydrophobic:.36,size:.82},B:{name:"Aspartate or Asparagine",triplet:"ASX"},Z:{name:"Glutamate or Glutamine",triplet:"GLX"},J:{name:"Leucine or Isoleucine",triplet:"XLE"},X:{name:"Unknown",triplet:"UNK"},"?":{name:"Unknown",triplet:"UNK"},hydrophobic:"LIFWVM",polar:"STNQ",small:"TDN",large:"WYRFH",aliphatic:"ILV",charged:"HKRED",positive:"HKR",negative:"ED",tiny:"AGS",aromatic:"FYWH",proline:"P",serThr:"ST"};function D(u,c){var t=c.find("span");if(0!==t.length){if(N.each(t,function(e,t){t.style.backgroundColor&&(t.style.backgroundColor="")}),c.data("features")||c.removeData("features"),null==u&&(u="rainbow"),(-1<["clustal","hydrophobic","size","charged","cysteine"].indexOf(u)||$[u])&&c.data("templateData").is_nucleotide&&(u="base"),c.data("features"))for(let o in c.data("features")){let s=0,r=c.find("tr[struc_id]");r.filter(`[struc_id="${o}"]`).each(function(e,t){if(s>parseInt(t.getAttribute("seqno")))return!1;s=parseInt(t.getAttribute("seqno"));let i=t.getAttribute("chain");i=i||t.getAttribute("keyseqchain");t=r.filter("tr[seqno="+s+"]").find(" span[s]");for(let e=0;e<c.data("features")[o].length;e++){var n=c.data("features")[o][e],a=n.rgb.split(",").map(Number);if(n.frmChn!=n.toChn)console.error("THIS IS AN ERROR "+n);else if(-1!=n.frmChn.indexOf(i))for(let e=n.resStart;e<n.resEnd+1;e++)chainMapping.structures[o][i][e]&&(chainMapping.structures[o][i][e].rgb=a)}t.each(function(e,t){var n=parseInt(t.getAttribute("s"));chainMapping.structures[o][i][n]&&(t.style.backgroundColor="rgba("+chainMapping.structures[o][i][n].rgb+",.6)")})})}else if("chain"==u||"uniqueChain"==u||"template"==u){let l=null;if("undefined"!=typeof globalTemplateData){if(!(l=globalTemplateData).chainColoursAssigned){for(let e=0;e<globalTemplateData.length;e++){var n=globalTemplateData[e],i=(n.chainColours={chain:[],unique:[],template:C[e%C.length]},n.chain_name?"chain_name":"chain");for(let t=0;t<n[i].length;t++){n.chainColours.unique[1<n[i][t].length?n[i][t].join(""):n[i][t]]=C[M],M++,M%=12;for(let e=0;e<n[i][t].length;e++)n.chainColours.chain[n[i][t][e]]=C[w],w++,w%=C.length}}globalTemplateData.chainColoursAssigned=!0}}else l=c.data("templateData").templates,N(".alignTbl").each(function(){var n=N(this).data("templateData");if(n&&n.templates&&!n.chainColoursAssigned){for(let t=0;t<n.templates.length;t++)if(n.templates[t].chainColours={chain:[],unique:[]},"model-template"==n.type)for(let e=0;e<n.keyseq_chain_name.length;e++)n.templates[t].chainColours.chain[n.keyseq_chain_name[e]]=C[w],n.templates[t].chainColours.unique[n.keyseq_chain_name[e]]=C[M],w++,w%=C.length;else n.templates[t].chainColours.chain[n.templates[t].chain]=C[w],n.templates[t].chainColours.unique[n.templates[t].chain]=C[M],w++,w%=C.length;M++,M%=C.length,n.chainColoursAssigned=!0}});l?N.each(c.find("tr[struc_id]"),function(e,t){let i=t.getAttribute("struc_id"),a=t.getAttribute("keyseqchain");if(!(a=a||t.getAttribute("chain")))return!1;var s,r=N(this).find("span[s]");for(let e=0;e<l.length;e++)if(l[e].struc_id==i){s=l[e];let n;if("chain"==u)n=s.chainColours.chain[a];else if("template"==u)n=s.chainColours.template;else for(var o in s.chainColours.unique)if(-1<o.indexOf(a)){n=s.chainColours.unique[o];break}n&&r.each(function(e,t){t.style.backgroundColor="rgb("+n+",.6)",i&&(t=parseInt(t.getAttribute("s")),chainMapping.structures[i])&&chainMapping.structures[i][a]&&chainMapping.structures[i][a][t]&&(chainMapping.structures[i][a][t].rgb=n)})}}):c.find("span").each(function(e,t){t.style.backgroundColor="rgba("+C[N(".alignTbl").index(c)%C.length]+",.6)"})}else if("rainbow"===u){let o=!1,l=0,u=c.find("tr");u.each(function(e,t){var n=t.getAttribute("struc_id");let i=t.getAttribute("chain");i=i||t.getAttribute("keyseqchain"),0==e&&(o="model-template"==t.getAttribute("keyseqtype"));e=parseInt(t.getAttribute("seqno"));if(e<=l)return!1;if(l=e,!o||null!=t.getAttribute("keyseqtype")){var a=u.filter("[seqno="+l+"]").find("span[s]:not([nores])");for(let e=0;e<a.length;e++){var s,r=a[e].getAttribute("s");null!=r&&(s=e/a.length*(1.5*Math.PI-Math.PI/2)+Math.PI/2,s=[Math.round(127.5*(Math.sin(s+Math.PI)+1)),Math.round(255*Math.sin(s-Math.PI/2)),Math.round(127.5*(Math.sin(s)+1))],a[e].style.backgroundColor=`rgba(${s},.6)`,n&&chainMapping.structures[n]&&chainMapping.structures[n][i]&&(r=parseInt(r),chainMapping.structures[n][i][r]))&&(chainMapping.structures[n][i][r].rgb=s)}}})}else if("qmean_local"===u){let l="qm";"undefined"!=typeof qmeanbraneActive&&qmeanbraneActive&&(l="qmb"),c.find("tr[struc_id]").each(function(){let s=N(this).attr("struc_id"),r=N(this).attr("chain");if(!(r=r||N(this).attr("keyseqchain"))||!chainMapping.structures[s][r])return!0;var e,t=N(this).find("span[s]");let o=!0,n=!1;for(e in chainMapping.structures[s]){for(var i in chainMapping.structures[s][e])if(chainMapping.structures[s][e][i])if(chainMapping.structures[s][e][i][l]){if(1<chainMapping.structures[s][e][i][l]){o=!1;break}}else chainMapping.structures[s][e][i].bfactor&&(n=!0);if(!o)break}if(n)return O(c,"bfactor_range",N(this)),!0;N.each(t,function(e,t){var n=parseInt(t.getAttribute("s"));if(!chainMapping.structures[s][r][n])return!0;let i=chainMapping.structures[s][r][n][l];if(null==i)return!0;o||(i/=100);var a=qmeanLocalColour(i,.6),t=(t.style.backgroundColor=a).substring(5).split(",").slice(0,3).map(Number);chainMapping.structures[s][r][n].rgb=t})})}else if("confClass"==u)c.find("tr[struc_id]").each(function(){let a=N(this).attr("struc_id"),s=N(this).attr("chain");if(!(s=s||N(this).attr("keyseqchain"))||!chainMapping.structures[a][s])return!0;var e,t=N(this).find("span[s]");let r=!0,n=!1;for(e in chainMapping.structures[a]){for(var i in chainMapping.structures[a][e])if(chainMapping.structures[a][e][i])if(chainMapping.structures[a][e][i].qm){if(1<chainMapping.structures[a][e][i].qm){r=!1;break}}else chainMapping.structures[a][e][i].bfactor&&(n=!0);if(!r)break}if(n)return O(c,"bfactor_range",N(this)),!0;N.each(t,function(e,t){var n=parseInt(t.getAttribute("s"));if(!chainMapping.structures[a][s][n])return!0;let i=chainMapping.structures[a][s][n].qm;if(!i)return!0;r&&(i*=100),rgb=90<i?[0,83,214]:70<i?[101,203,243]:50<i?[255,219,19]:[255,125,69],t.style.backgroundColor="rgba("+rgb+",.6)",chainMapping.structures[a][s][n].rgb=rgb})});else if(-1<u.indexOf("consistency")){let o=0,l=1;"consistency"!=u&&(o=999,l=-99,c.find("tr[struc_id]").each(function(){var t=N(this).attr("struc_id");let n=N(this).attr("chain");if(!(n=n||N(this).attr("keyseqchain"))||!chainMapping.structures[t][n])return!0;for(let e=0;e<chainMapping.structures[t][n].length;e++)chainMapping.structures[t][n][e]&&chainMapping.structures[t][n][e].c&&(o=Math.min(o,chainMapping.structures[t][n][e].c),l=Math.max(l,chainMapping.structures[t][n][e].c))})),c.find("tr[struc_id]").each(function(){var t=N(this).attr("struc_id");let n=N(this).attr("chain");if(!(n=n||N(this).attr("keyseqchain"))||!chainMapping.structures[t][n])return!0;var i=N(this).find("span[s]").toArray();for(let e=0;e<i.length;e++){var a=[127,195,45],s=parseInt(i[e].getAttribute("s")),r=chainMapping.structures[t][n][s].c;r&&(l!=o&&((r=(parseFloat(r)-o)/(l-o))<.5?(a[0]=Math.round(255*(1-r)),a[1]=Math.round(160*r),a[2]=Math.round(90*r)):(a[0]=Math.round(127),a[1]=Math.round(20+175*r),a[2]=45)),i[e].style.backgroundColor="rgba("+a+",0.6)",t)&&(chainMapping.structures[t][n][s].rgb=a)}})}else if("clustal"==u){let s={red:[238,51,17],blue:[17,119,238],green:[17,204,17],orange:[255,102,0],cyan:[17,187,187],pink:[238,119,119],magenta:[204,68,204],yellow:[204,204,0]},r=c.data("clustalColours");r||(y=A(c.data("templateData"),c),r=function(n){let i,a,s=[];for(let t=0;t<n[0].length;t++){s[t]={};for(let e=i=0;e<n.length;e++)if("-"==(a=n[e].charAt(t).toUpperCase()))i++;else{H(s,a,t);for(var r of["QE","ED","WLVIMAFCYHP","KR","TS"])-1<r.indexOf(a)&&H(s,r,t)}s[t].gapCount=i;var e,o,l={};for(e in s[t])l[e+"_nogap"]=(s[t][e]/n.length).toFixed(2),s[t][e]=(s[t][e]/(n.length-i)).toFixed(2);for(o in l)s[t][o]=l[o]}return s}(y.concat(y.target)),c.data("clustalColours",r));let o,t=0;c.find("tr").each(function(){if(parseInt(N(this).attr("seqno"))<t)return!1;let i=N(this).attr("struc_id"),a=N(this).attr("chain");a=a||N(this).attr("keyseqchain"),t=parseInt(N(this).attr("seqno"));var e=c.find("tr[seqno="+t+"] span");N.each(e,function(t,n){if(null!=r[t]){let e=null;if(n.hasAttribute("r")){switch(o=n.getAttribute("r")){case"A":case"I":case"L":case"M":case"F":case"W":case"V":.6<r[t].WLVIMAFCYHP_nogap&&(e=s.blue);break;case"C":.6<r[t].WLVIMAFCYHP_nogap&&(e=s.blue),.85<r[t].C_nogap&&(e=s.pink);break;case"K":case"R":(.6<r[t].KR_nogap||.8<r[t].K_nogap||.8<r[t].R_nogap||.8<r[t].Q_nogap)&&(e=s.red);break;case"E":(.6<r[t].KR_nogap||.5<r[t].ED_nogap||.5<r[t].QE_nogap||.85<r[t].E_nogap||.85<r[t].Q_nogap||.85<r[t].D_nogap)&&(e=s.magenta);break;case"D":(.6<r[t].KR_nogap||.5<r[t].ED_nogap||.85<r[t].D_nogap||.85<r[t].E_nogap||.85<r[t].N_nogap)&&(e=s.magenta);break;case"N":(.5<r[t].N_nogap||.85<r[t].Y_nogap)&&(e=s.green);break;case"Q":(.6<r[t].KR_nogap||.5<r[t].QE_nogap||.85<r[t].Q_nogap||.85<r[t].E_nogap||.85<r[t].K_nogap||.85<r[t].R_nogap)&&(e=s.green);break;case"S":case"T":(.6<r[t].WLVIMAFCYHP_nogap||.5<r[t].TS_nogap||.85<r[t].S_nogap||.85<r[t].T_nogap)&&(e=s.green);break;case"G":e=s.orange;break;case"P":e=s.yellow;break;case"H":case"Y":(.6<r[t].WLVIMAFCYHP_nogap||.85<r[t].W_nogap||.85<r[t].Y_nogap||.85<r[t].A_nogap||.85<r[t].C_nogap||.85<r[t].P_nogap||.85<r[t].Q_nogap||.85<r[t].F_nogap||.85<r[t].H_nogap||.85<r[t].I_nogap||.85<r[t].L_nogap||.85<r[t].M_nogap||.85<r[t].V_nogap)&&(e=s.cyan)}e&&(n.style.backgroundColor="rgb("+e+",.5)",i)&&chainMapping.structures[i]&&chainMapping.structures[i][a]&&(n=parseInt(n.getAttribute("s")),chainMapping.structures[i][a][n])&&(chainMapping.structures[i][a][n].rgb=e)}}})})}else if("secstruc"==u){let t=N.cookie("secStruct");null==t&&(t="dssp");var o=c.data("templateData"),l=c.find("tr");let s,r;if(o.keyseq_annotation)for(let e=0;e<o.keyseq_chain_name.length;e++){r=o.struc_id;var a=o.keyseq_chain_name[e];if(o.keyseq_annotation[a]&&o.keyseq_annotation[a][t]){var h=W(o.keyseq_annotation[a],t).replace(/[GI]/g,"H").replace(/B/g,"E");for(let e=0;e<h.length;e++)chainMapping.structures[r][a][e+1]&&(chainMapping.structures[r][a][e+1].ss=h[e])}else if(chainMapping.structures[r])for(let e=0;e<chainMapping.structures[r][a].length;e++)chainMapping.structures[r][a][e]&&(chainMapping.structures[r][a][e].ss=null)}else if(o.templates)for(let e=0;e<o.templates.length;e++){var d=o.templates[e];if(d.annotation&&d.annotation[t]){var p=W(d.annotation,t).replace(/[GI]/g,"H").replace(/B/g,"E");if(chainMapping.structures[d.struc_id])for(let e=0;e<p.length;e++)chainMapping.structures[d.struc_id][d.chain]&&chainMapping.structures[d.struc_id][d.chain][e+1]&&(chainMapping.structures[d.struc_id][d.chain][e+1].ss=p[e]);else console.warn("no chain mapping found for "+d.struc_id+" "+d.chain)}else if(d.struc_id&&"none"!=t){let t=!1;for(let e=0;!t&&e<chainMapping.structures[d.struc_id][d.chain].length;e++)chainMapping.structures[d.struc_id][d.chain][e]&&chainMapping.structures[d.struc_id][d.chain][e].ss&&(t=!0);t||fetchSecStruc(d.struc_id)}}let n=0;for(let e=0;e<l.length;e++){var g=l.eq(e);if(parseInt(g.attr("seqno"))<n)break;n=parseInt(g.attr("seqno"));let i=g.attr("chain"),a=(i=i||g.attr("keyseqchain"),r=g.attr("struc_id"),null);if(!r){if("model-template"==o.type)for(let e=0;e<o.templates.length;e++)if(o.templates[e].chain==i){o.templates[e].annotation&&o.templates[e].annotation[t]&&(a=(a=W(o.templates[e].annotation,t)).replace(/[GI]/g,"H").replace(/B/g,"E"));break}if(!a)continue}g=l.filter('[seqno="'+n+'"]').find("span[s]").toArray();N.each(g,function(e,t){let n=null;s=parseInt(t.getAttribute("s")),a?"E"==a[s-1]?n=[51,204,51]:"H"==a[s-1]&&(n=[153,153,230]):chainMapping.structures[r]&&chainMapping.structures[r][i]&&chainMapping.structures[r][i][s]&&("E"==chainMapping.structures[r][i][s].ss?n=[51,204,51]:"H"==chainMapping.structures[r][i][s].ss&&(n=[153,153,230]),chainMapping.structures[r][i][s].rgb=n),t.style.backgroundColor="rgba("+n+",.6)"})}}else if(-1<["hydrophobic","size","charged","cysteine"].indexOf(u)||$[u])c.find("tr").each(function(){let i=N(this).attr("struc_id"),a=N(this).attr("chain");a=a||N(this).attr("keyseqchain");var e=N(this).find("span");N.each(e,function(e,t){if((res=t.getAttribute("r"))&&$[res]){var n=function(e,t){{var n;return"hydrophobic"!=e?"size"!=e?"charged"==e?-1<$.positive.indexOf(t)?[100,100,255]:-1<$.negative.indexOf(t)?[255,100,100]:void 0:"cysteine"==e?"C"==t?[202,168,14]:null:-1<$[e].indexOf(t)?[20,80,250]:null:null!=(n=$[t][e])?[Math.round(255*n),255-Math.round(255*n),0]:void 0:null!=(n=$[t][e])?[Math.round(255*n),0,255-Math.round(255*n)]:void 0}}(u,res);if(!n)return!0;t.style.backgroundColor="rgba("+n+",.6)",i&&chainMapping.structures[i]&&chainMapping.structures[i][a]&&(t=parseInt(t.getAttribute("s")),chainMapping.structures[i][a][t])&&(chainMapping.structures[i][a][t].rgb=n)}})});else if("base"==u)c.find("tr").each(function(){let i=N(this).attr("struc_id"),a=N(this).attr("chain");a=a||N(this).attr("keyseqchain");var e=N(this).find("span");N.each(e,function(e,t){var n;return!(res=t.getAttribute("r"))||!(n={A:[70,195,70],C:[195,195,70],G:[195,70,70],T:[70,70,195],U:[70,70,195]}[res])||(t.style.backgroundColor="rgba("+n+",.6)",void(i&&chainMapping.structures[i]&&chainMapping.structures[i][a]&&(t=parseInt(t.getAttribute("s")),chainMapping.structures[i][a][t])&&(chainMapping.structures[i][a][t].rgb=n)))})});else if("soa"==u)O(c,"soa");else if("lddt"==u)O(c,u);else if(-1<u.indexOf("bfactor"))O(c,u);else if("entropy"==u)O(c,"entropy");else if("indels"==u&&"model-template"==c.data("templateData").type&&c.data("templateData").templates[0].tpl_seq){var f=c.data("templateData");let a=f.struc_id,n=99999999,i=0;var m=[],v=[];for(let t=0;t<f.templates.length;t++)if(f.templates[t].struc_id==a){trgOffset=f.templates[t].trg_offset?f.templates[t].trg_offset-1:0,i=f.templates[t].residue_from?(n=Math.min(n,f.templates[t].residue_from),Math.max(i,f.templates[t].residue_to)):(n=0,99999999999);for(let e=0;e<f.templates[t].trg_seq.length;e++)"-"!=f.templates[t].trg_seq.charAt(e)&&(v[e]="X"),"-"!=f.templates[t].tpl_seq.charAt(e)&&(m[e]="X")}let t=null,s=1+trgOffset,r=[],o=[];for(let e=0;e<f.templates[0].trg_seq.length;e++){if(!m[e])for(let e=0;-1==r.indexOf(s)&&e<f.keyseq_chain_name.length;e++)s>=n&&s<=i&&r.push(s);if(v[e])t=s,s++;else if(null!=t)for(let e=0;-1==o.indexOf(s)&&e<f.keyseq_chain_name.length;e++){f.keyseq_chain_name[e];s>=n&&s<=i&&o.push(s),s-1>=n&&s<=i&&o.push(s-1)}}for(let e=0;e<f.keyseq_chain_name.length;e++){let i=f.keyseq_chain_name[e];var b=c.find("tr[keyseqchain="+i+"]");N.each(b.find("span[s]:not([nores])"),function(e,t){var n=parseInt(t.getAttribute("s"));if(-1<r.indexOf(n))rgb=[80,214,80];else{if(!(-1<o.indexOf(n)))return!0;rgb=[100,100,255]}t.style.backgroundColor="rgba("+rgb+",.6)",chainMapping.structures[a][i][n].rgb=rgb})}}if(!N.cookie("targetMismatch")||"fade"==N.cookie("targetMismatch")?t.filter("[nm]").addClass("targetMismatch"):"enhance"==N.cookie("targetMismatch")&&(t.not("[nm]").addClass("targetMismatch"),t.not("[s]").addClass("targetMismatch")),_&&(x&&c.find(`tr[seqno=${x.seqno}]`).find("span").eq(x.seqidx).addClass("cursor"),c.data("startEditRegion"))&&c.data("endEditRegion")){var y=c.data("startEditRegion"),t=c.data("endEditRegion"),s=y.closest("tr"),r=s.attr("seqno"),s=s.siblings("[seqno="+r+"]").addBack().find("span");let e=c.find("tr[seqno="+r+"]").find("span");e=e.slice(s.index(y),s.index(t)+1).addClass("shadowCursor"),c.data("startEditRegion",e.first()),c.data("endEditRegion",e.last())}}}function O(i,c,e){if(!i.data("options").textOnly){let o=!1,l=null,t=null,u="bfactor_range"==c;u&&(c="bfactor"),(e||i.find("tr[struc_id]")).each(function(){l=N(this).attr("struc_id"),t=N(this).attr("qname");let r=N(this).attr("chain");if(!(r=r||N(this).attr("keyseqchain")))return!0;var e=N(this).find("span[s]");N.each(e,function(e,t){var n,i=parseInt(t.getAttribute("s"));if(!(chainMapping.structures[l]&&chainMapping.structures[l][r]&&chainMapping.structures[l][r][i]&&c in chainMapping.structures[l][r][i]))return!0;o=!0;let a=chainMapping.structures[l][r][i][c],s=[0,200,0];"entropy"==c?s=a<1.9?[Math.floor(a/1.9*256),Math.floor(a/1.9*256),255]:[255,256-Math.floor((a-1.9)/1.9*256),256-Math.floor((a-1.9)/1.9*256)]:"soa"==c?(a=Math.max(0,Math.min(1,.01*a)),s=[Math.floor(255*(1-a)),0,255-Math.floor(255*(1-a))]):"lddt"==c?(a=(1-a)*(1.5*Math.PI-Math.PI/2)+Math.PI/2,s=[Math.round(127.5*(Math.sin(a+Math.PI)+1)),Math.round(255*Math.sin(a-Math.PI/2)),Math.round(127.5*(Math.sin(a)+1))]):"bfactor"==c&&(u?(n=chainMapping.annotations.map(e=>e.key).indexOf("bfactor_range"),chainMapping.annotations[n].rangeColours[l]&&chainMapping.annotations[n].rangeColours[l][r]&&(s=chainMapping.annotations[n].rangeColours[l][r][i])):s=a<=10?[0,0,255]:10<a&&a<=15?[115,115,255]:15<a&&a<=20?[170,170,255]:20<a&&a<=25?[215,215,255]:25<a&&a<=30?[255,215,215]:30<a&&a<=35?[255,170,170]:35<a&&a<=40?[255,115,115]:[255,0,0]),t.style.backgroundColor="rgba("+s+",.6)",chainMapping.structures[l][r][i].rgb=s})}),o||(!t||"soa"!=c&&"entropy"!=c||"undefined"==typeof SCORE_URL?"bfactor"==c&&fetchBFactors(l,"bfactor")&&O(i,c+(u?"_range":"")):N.getJSON(SCORE_URL.replace("xxxx.0",t.match(/\w{4}\.\d+/)[0])+c,function(t,e){if(t.error)console.error("Could not fetch "+c+" values");else{for(var n in t)for(let e=0;e<t[n].values.length;e++)null!=t[n].values[e]&&chainMapping.structures[l]&&chainMapping.structures[l][n]&&chainMapping.structures[l][n][e+t[n].offset+1]&&(chainMapping.structures[l][n][e+t[n].offset+1][c]=t[n].values[e]);D(c,i),h()}}))}}function h(n){if(n&&n.singleResidue||("function"==typeof colourRama&&colourRama(),"function"==typeof colourModelBars&&colourModelBars()),void 0!==currentWin){if("undefined"!=typeof pv_viewer&&0<N("#pv:visible",currentWin.document).length){let t=[];if(pv_viewer.forEach(function(e){t.push(e.name())}),0!=t.length){for(let i in chainMapping.structures)-1<t.indexOf(i)&&pv_viewer.get(i)&&pv_viewer.get(i).colorBy(new pv.color.ColorOp(function(e,t,n){e=e.residue();chainMapping.structures[i][e.chain().name()]&&chainMapping.structures[i][e.chain().name()][e.num()]&&chainMapping.structures[i][e.chain().name()][e.num()].rgb?(t[n]=chainMapping.structures[i][e.chain().name()][e.num()].rgb[0]/255,t[n+1]=chainMapping.structures[i][e.chain().name()][e.num()].rgb[1]/255,t[n+2]=chainMapping.structures[i][e.chain().name()][e.num()].rgb[2]/255):(t[n]=.9,t[n+1]=.9,t[n+2]=.9),t[n+3]=1}));pv_viewer.requestRedraw()}}if(null!=ngl_stage&&0<N("#ngl:visible",currentWin.document).length)if(n&&n.singleResidue){var s=n.singleResidue;for(let n in NGL.ColormakerRegistry.userSchemes)-1<n.indexOf("singleres")&&(NGL.ColormakerRegistry.removeScheme(n),ngl_stage.eachRepresentation(function(e){if(e.repr.colorScheme==n)for(var t in NGL.ColormakerRegistry.userSchemes)if(t.endsWith(e.name))return void e.setColor(t)}));if(s){let i=getNGLComponentByName(s.struc_id);i&&ngl_stage.eachRepresentation(function(e){let n=i.name;if(e.name!=n){if(!e.name.endsWith(".dna")||!i.name.startsWith(e.name.substring(0,5)))return;n=i.name+".dna"}var t;chainMapping.structures[n]&&(t=NGL.ColormakerRegistry.addScheme(function(e){for(var t in chainMapping.structures[n])" "===t&&N("#ngl_status").html("NGL cannot colour or select chains named whitespace!");this.atomColor=function(e){return ngl_picked_atom&&e.structure.name===ngl_picked_atom.structure.name&&e.index===ngl_picked_atom.index?16711680:chainMapping.structures[n][e.chainname]&&chainMapping.structures[n][e.chainname][e.resno]&&chainMapping.structures[n][e.chainname][e.resno].rgb?chainMapping.structures[n][e.chainname][e.resno].rgb[0]<<16|chainMapping.structures[n][e.chainname][e.resno].rgb[1]<<8|chainMapping.structures[n][e.chainname][e.resno].rgb[2]:16777215}},"singleres"),e.setColor(t))})}}else{var r,s=n;let t=[],e=(ngl_stage.eachRepresentation(function(e){t.push(e.name)}),s&&s.strucId?s.strucId:null),a={};for(r in ngl_stage.compList)if(void 0!==ngl_stage.compList[r].structure){let i=ngl_stage.compList[r].name;if(chainMapping.structures[i]&&(!e||i==e)){for(var o in NGL.ColormakerRegistry.userSchemes)-1<o.indexOf(i)&&-1==o.indexOf("membrane")&&NGL.ColormakerRegistry.removeScheme(o);ngl_stage.eachRepresentation(function(e){if(e.name==i||e.name.endsWith(".dna")||e.name.endsWith(".highlight")||"drug.surroundings"==e.name)if(a[e.name])e.setColor(a[e.name]);else{let n;if(e.name.endsWith(".dna")){if(!i.startsWith(e.name.substring(0,5)))return;if(!chainMapping.structures[i+".dna"])return;n=i+".dna"}else n=i;var t=NGL.ColormakerRegistry.addScheme(function(e){for(var t in chainMapping.structures[n])" "===t&&N("#ngl_status").html("NGL cannot colour or select chains named whitespace!");this.atomColor=function(e){return chainMapping.structures[n][e.chainname]&&chainMapping.structures[n][e.chainname][e.resno]&&chainMapping.structures[n][e.chainname][e.resno].rgb?chainMapping.structures[n][e.chainname][e.resno].rgb[0]<<16|chainMapping.structures[n][e.chainname][e.resno].rgb[1]<<8|chainMapping.structures[n][e.chainname][e.resno].rgb[2]:16777215}},n);a[e.name]=t,e.setColor(t)}})}}}}}window.requestIdleCallback=window.requestIdleCallback||function(e){let t=Date.now();return setTimeout(function(){e({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(e){clearTimeout(e)};const G={};function z(t){let u=N.cookie("secStruct");null==u&&(u="dssp");var e=t.attr("id")+"_features";if(N("#"+e).html(""),0==N("#"+e).length||u&&"none"==u)t.removeClass("ss"),L(t).removeClass("ss");else{t.addClass("ss"),L(t).addClass("ss");let o=t.position().top,l=t.find("td:visible").first().width();var n=t.find("span:visible");if(0!==n.length){let r=n[0].getBoundingClientRect().width;var c=n[0].getBoundingClientRect().height,h=t.position().left;if(!(l<1)){let a=Raphael(e,l,t.height()),s=(N("#"+e).css("top",t.position().top),t.data("templateData"));if(s){let i=t.find("tr:visible");if(s.keyseq_annotation){var d=s.templates[0].trg_offset||1;for(let e=0;e<s.keyseq_chain_name.length;e++){var p=s.keyseq_chain_name[e];s.keyseq_annotation[p]&&s.keyseq_annotation[p][u]&&U(a,F(s.keyseq_annotation[p],u,d),i.filter('[keyseqchain="'+p+'"]'),i.filter('[keyseqchain="'+p+'"]').find("span[s]").toArray(),o,h,l,r,c)}}if(s.charts)for(const _ of s.templates)_.struc_id&&_.annotation&&(G[_.qname]&&cancelIdleCallback(G[_.qname]),G[_.qname]=requestIdleCallback(()=>{var B=a,q=_.annotation,I=u,T=_.trg_offset||1,e=i.filter(`[struc_id="${_.struc_id}"][chain="${_.chain}"]`),t=o,V=l,$=r,n=s;if(n.charts){let y=n.charts.split("|"),_=0,w=5,x=(-1<y.indexOf("dssp")&&(w=2,_=12,y.splice(y.indexOf("dssp"),1)),n.pageResidueCount<5e3),M=(T=T||1,B.set()),C=B.set(),P=B.set(),k=null,E,L,R,A,S;e.each(function(e,n){var i=N(n).find("span").toArray();if(0!=i.length){var a=n.getAttribute("struc_id"),s=n.getAttribute("chain"),r=N(n).position().top-t+N(i[0]).position().top,o=n.getBoundingClientRect().left,n=i[i.length-1].getBoundingClientRect().right-o;if(0!=n){k=k||(r-_-w-10-6*(y.length-1))/(y.length||1);var l,u,c=[];let t="";for(let e=0;e<y.length;e++){var h=y[e];E="qm"===h?.3:0,A=r-k*e-w-_-6*e,R=A,(S=B.path(`M0,${R}L${V},${R}L${V},${R-k}L0,`+(R-k))).attr({"stroke-width":.4,stroke:"#888"});for(let e=Math.round(10*E);e<11;e++){L=R-k*((e-10*E)/(10-10*E));var d=B.path("M0,"+L+"L"+V+","+L);5==e?d.attr({"stroke-width":.7,opacity:.8,stroke:"#888","stroke-dasharray":"-"}):M.push(d)}c.push("")}for(let e=0;e<i.length;e++){var p=i[e],g=p.getAttribute("s");if(g){var f=p.getBoundingClientRect().left-o,m=parseInt(g),p=m-T;q[I+"_string"]&&q[I+"_string"][p]?t+=q[I+"_string"][p]:t+="-";for(let e=0;e<y.length;e++){var v=y[e],b=(E="qm"===v?.3:0,A=r-k*e-w-_-6*e,R=A,Math.max(E,chainMapping.structures[a][s][m][v]));if(L=R-k*((b-E)/(1-E)),x){let e;"qm"===v?e=.5<b?[Math.round(490*(1-b)),80,Math.round(255*b)]:"245,80,0":"lddt"===v&&(b=(1-b)*(1.5*Math.PI-Math.PI/2)+Math.PI/2,e=[Math.round(127.5*(Math.sin(b+Math.PI)+1)),Math.round(255*Math.sin(b-Math.PI/2)),Math.round(127.5*(Math.sin(b)+1))]);v=B.path(`M${f},${R}L${f},${L}L${f+$},${L}L${f+$},`+R);P.push(v),v.attr({fill:`rgba(${e},.6)`})}else c[e]+=`M${f} ${R}L${f} ${L}L${f+$} ${L}L${f+$} `+R}}else t+="-"}for(l of c)P.push(B.path(l));0<_&&(u=B.text(1.5,r-_-w+_/2,t),C.push(u),u.node.setAttribute("textLength",n-$/2+2+"px"),u.node.firstChild.setAttribute("textLength",n-$/2+1.5+"px"))}}}),C.attr({"text-anchor":"start","font-family":"monospace"}),P.attr({"stroke-width":.7,stroke:"#666"}),M.attr({"stroke-width":.9,stroke:"#888",opacity:.6,"stroke-dasharray":". "})}}));let e=null;for(var g of i){var g=N(g),f=parseInt(g.attr("seqno"));if(null!==e&&f<=e)break;if(null===e&&(e=f),!g.attr("keyseqtype")){var m=g.attr("chain"),v=g.attr("struc_id"),b=i.filter("[seqno="+f+"]"),y=b.find("span[s]").toArray();for(let e=0;e<s.templates.length;e++)s.templates[e].annotation&&F(s.templates[e].annotation,u),(v?s.templates[e].struc_id!=v:s.templates[e].chain!=m)||!v&&"target-template"==s.type&&s.templates[e].struc_id||s.templates[e].chain==m&&s.templates[e].annotation&&s.templates[e].annotation[u]&&U(a,F(s.templates[e].annotation,u),b,y,o,h,l,r,c)}}}}}}}function W(e,t){var n=e[t];return"string"==typeof n&&(e[t+"_string"]=n.replace(/[GI]/g,"H").replace(/B/g,"E")),e[t+"_string"]}function F(e,n,i){if(i=i||1,"string"==typeof e[n]){e[n+"_string"]=e[n];var a,s=e[n].replace(/[GI]/g,"H").replace(/B/g,"E");let t=null;for(let e=0;e<s.length;e++)"H"!==s[e]&&"E"!==s[e]||(a=e+i,null==t?t=[[a,a,s[e]]]:t[t.length-1][1]===a-1&&t[t.length-1][2]===s[e]?t[t.length-1][1]=a:t.push([a,a,s[e]]));e[n]=t}return e[n]}function U(o,l,u,c,h,e,d,p,g){if(l){let n=0;var f=c.length;for(let r=0;r<l.length;r++)if("E"==l[r][2]||"H"==l[r][2]){let i=null,a=null,s;for(let t=l[r][0];t<=l[r][1];t++)if(!(c[n].getAttribute("s")>t)){for(let e=n;e<f;e++)if(c[e].getAttribute("s")==t){n=e,i=N(c[e]);break}if(i)break}for(let t=l[r][1];t>=l[r][0];t--){for(let e=n;e<f;e++)if(c[e].getAttribute("s")==t){n=e,a=N(c[e]);break}if(a)break}if(null==i||null==a)n=0;else{let t=i.closest("tr");var m=u.index(t),v=u.index(a.closest("tr")),b=i.position(),y=b.left-e;let n=b.top;var _=a.position().left-e,w=t.width()-p-p;for(let e=m;e<v+1;e++)if(e>m&&(t=u.eq(e),n=t.find("span").first().position().top),s=t.position().top+n-h,"E"==l[r][2]){L=E=k=P=C=M=x=void 0;var x=o,M=s,C=y-(e-m)*d,P=_+(v-e)*d,k=p,E=g,L=w;M+=1,E-=2,C=Math.max(-k,Math.round(C)),P=Math.min(L,Math.round(P+k)),(L=x.path("M"+C+","+(M-2)+"L"+(P-6)+","+(1.5+M)+"L"+(P-6)+","+(M-2)+"L"+(P+2)+","+(E/2+M)+"L"+(P-6)+","+(E+M+2)+"L"+(P-6)+","+(E-1.5+M)+"L"+C+","+(E+M+2)+"L"+C+","+(M-2))).attr({"stroke-width":.7,fill:"#DDD","fill-opacity":.3,stroke:"#226","stroke-dasharray":"5 2"})}else{L=M=C=E=P=x=k=void 0;k=o,x=s,P=y-(e-m)*d,E=_+(v-e)*d,C=p,M=g,L=w;x+=2,M-=4,P=Math.max(-C,Math.round(P)),E=Math.min(L,Math.round(E+C)),(L=k.rect(P,x-2,E-P,M+4,4)).attr({"stroke-width":.7,fill:"#DDD","fill-opacity":.3,stroke:"#226"})}}}}}function s(){let e="";"Multi FASTA"==N("#alignmentFormatSelect").val()?N(".alignTbl:visible").each(function(){e=e+t(N(this).attr("id").substring(8),"FASTA")+"\n"}):e=t(N("#currentAlignmentIndex").val(),N("#alignmentFormatSelect").val()),N("#formattedAlignmentTextarea").val(e),N("#formattedAlignmentTextarea").focus(),N("#formattedAlignmentTextarea").select()}function t(e,t){t=t||"fasta";var n=N("#alignNameTbl"+e);let i=N("#alignTbl"+e),a=[],s=[],r=[],o=[];e=0<N("#alignTbl"+e+" :visible").first().length?":visible":"";if(n.find("tr[seqno]"+e).each(function(e,t){t=parseInt(t.getAttribute("seqno"));if(0<a.length&&t<=a[0])return!1;a.push(t),s.push(N(this).text()),o.push(N(this).attr("title")),breakCount=0;let n="";i.find(`tr[seqno=${t}]`).each(function(){n+=N(this).find("td").first().text(),breakCount+=N(this).find(".insert_l,.insert_r").length}),r.push(n),0<breakCount&&(s[e]=`MULTIPLE_SEGMENTS_OF_${s[e]} - WARNING - CONTAINS NON-SEQUENTIAL SEGMENTS`)}),-1<t.search(/fasta/i)){var l=s,u=r,c=o;if(!u||0==u.length)return"No templates selected";let n="";for(let t=0;t<l.length;t++){n+=">"+l[t]+(c&&c[t]?" "+c[t]:"")+"\n";for(let e=0;e<u[t].length;e+=72)n+=u[t].substring(e,e+72)+"\n"}return n}if(-1<t.search(/clustal/i)){var h=s,d=r;if(!d||0==d.length)return"No templates selected";let n=0;for(let e=0;e<h.length;e++)n=Math.max(n,h[e].length);n+=2;let i="CLUSTAL\n\n";for(let e=0;e<d[0].length;e+=60){for(let t=0;t<h.length;t++){i+=h[t];for(let e=h[t].length;e<n;e++)i+=" ";i+=d[t].substring(e,e+60)+"\n"}i+="\n"}return i=i.substring(0,i.length-2)}return""}N.fn.alignment=function(e){return l[e]?l[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void N.error("Method "+e+" does not exist on alignment.min.js"):l.init.apply(this,arguments)}}(jQuery),Object.keys||(Object.keys=function(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(t);return n}),$(document).on("click",".alignmentOptions input[name=csRadioGroup]",function(){delete chainMapping.defaultColourScheme,$(".alignTbl:first").alignment("colourAllAlignments",{col:$(this).val()})}),$(document).on("click","#viewerSelect input[name=3dRG]",function(){showViewer($(this).val())}),document.addEventListener("DOMContentLoaded",()=>{document.body.addEventListener("highlightResidue",e=>{if("alignment"!==e.detail.src){e.detail.multiple||document.querySelectorAll(".hoverResidue").forEach(e=>e.classList.remove("hoverResidue"));for(var t of document.querySelectorAll(`.alignTbl tr[struc_id^="${e.detail.struc_id}"]`))if((t.offsetWidth||t.offsetHeight||t.getClientRects().length)&&(t.hasAttribute("chain")&&t.getAttribute("chain")===e.detail.chain||t.hasAttribute("keyseqchain")&&t.getAttribute("keyseqchain")===e.detail.chain)){t=t.querySelector(`span[s="${e.detail.resno}"]`);if(t){t.classList.add("hoverResidue");break}}}}),document.body.addEventListener("selectResidues",n=>{if(["alignment","index","comparison","variance","features"].includes(n.detail.src))for(let t in chainMapping.structures[n.detail.struc_id]){var i=n.detail.residues.filter(e=>e.chain===t).map(e=>e.resno);for(let e=0;e<chainMapping.structures[n.detail.struc_id][t].length;e++){var a=chainMapping.structures[n.detail.struc_id][t][e];a&&(i.includes(e)?a.selected=!0:delete a.selected)}}["alignment","structure","rama","outlier","features"].includes(n.detail.src)||highlightSelectedResidues()}),document.body.addEventListener("selectResidues",e=>{if(0!==$("#annotate:visible").length&&!["structure","rama","outlier","features"].includes(e.detail.src)&&e.detail.struc_id&&e.detail.residues&&0!==e.detail.residues.length){var a=modelData[e.detail.struc_id.substring(6)];if(a){var s=[];for(let t of e.detail.residues){var n=s.find(e=>e.chain===t.chain&&(e.min-1===t.resno||e.max+1===t.resno)),r=chainMapping.structures[e.detail.struc_id][t.chain][t.resno];r&&(n?(n.max<t.resno&&(n.max=t.resno,n.sequence+=r.resname),n.min>t.resno&&(n.min=t.resno,n.sequence=r.resname+n.sequence)):s.push({chain:t.chain,min:t.resno,max:t.resno,sequence:r.resname}))}let i=document.getElementById("annotate").value;for(let n=0;n<a.targets.length;n++)for(let t of a.targets[n].id||a.targets[n].keyseq_chain_name)for(var o of s.filter(e=>e.chain===t)){let e=`motif=${o.sequence} start=${o.min} end=`+o.max;1<a.targets.length&&(e+=" target="+(n+1)),i.includes(e)||(0<i.length&&!i.endsWith("\n")&&(i+="\n"),i+=e+"\n")}document.getElementById("annotate").value=i,document.getElementById("annotate").scrollTop=document.getElementById("annotate").scrollHeight}}})}),$("body").on("click",function(e){$(".poponthis").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||((($(this).popover("hide").data("bs.popover")||{}).inState||{}).click=!1)})}),addSettingsPopover(),0<$("#bgColSlider").length&&$("#bgColSlider").slider({value:$.cookie("bg_r")?$.cookie("bg_r"):255,min:0,max:255,step:1,slide:function(e,t){pv_viewer.options("background",[t.value/255,t.value/255,t.value/255]),ngl_stage&&ngl_stage.setParameters({backgroundColor:"rgb("+t.value+","+t.value+","+t.value+")"}),jQuery.cookie("bg_r",t.value,{expires:365,path:"/"})},change:function(e,t){pv_viewer.options("background",[t.value/255,t.value/255,t.value/255]),ngl_stage&&ngl_stage.setParameters({backgroundColor:"rgb("+t.value+","+t.value+","+t.value+")"}),jQuery.cookie("bg_r",t.value,{expires:365,path:"/"}),t.value<180?$(".viewerStatus").addClass("status_dark"):$(".viewerStatus").removeClass("status_dark")}}),$.cookie("bg_r")&&$.cookie("bg_r")<180&&$(".viewerStatus").addClass("status_dark");var chainMapping={structures:{},targets:{},alignments:[],chainMeta:{},annotations:[{key:"qm",label:"Confidence",active:!0},{key:"qmb",label:"QMEANBrane",active:!1},{key:"c",label:"Consistency",active:!0},{key:"entropy",label:"Entropy",active:!0},{key:"soa",label:"Solvent Accessibility",active:!0},{key:"bfactor",label:"B-factor",active:!0},{key:"bfactor_range",label:"B-factor range",active:!0}]};function processAnnotations(g){if(0<$("#pv:visible",currentWin.document).length&&(pv_viewer.rm(`model_${g||"*"}.label`),pv_viewer.rm(`model_${g||"*"}.selected`)),0<$("#ngl:visible",currentWin.document).length)for(const i in modelData)if(!g||i==g){var t=getNGLComponentByName("model_"+i);if(t){var n=[];for(let e=0;e<t.reprList.length;e++)(-1<t.reprList[e].name.indexOf(".label")||-1<t.reprList[e].name.indexOf(".selected"))&&n.push(t.reprList[e]);for(let e=0;e<n.length;e++)t.removeRepresentation(n[e])}}var s,e,f=[],m=$("#annotate").val().split(/\r?\n/),v={};for(let i=0;i<m.length;i++){let a,r,t,o,l,u,c,h,d,p=!1,e=(m[i]=m[i].trim().replace(/\s{1,}/g," ").replace(/\s*= */g,"="),m[i]);-1<e.search(/label=\"(.+)\"/i)&&(s=e.match(/label=\"(.+)\" ?/i),c=s[1],e=e.replace(s[0],"").trim());let n=!1;var b=e.split(" ");for(let e=0;e<b.length;e++){var y=b[e].split("=");if(2!=y.length)n=!0;else switch(y[0].toUpperCase()){case"MOTIF":a=y[1];break;case"COLOUR":case"COLOR":r=255*(r=new NGL.Color(y[1].toLowerCase())).r+","+255*r.g+","+255*r.b;break;case"TARGET":t=parseInt(y[1]);break;case"CHAIN":o=y[1];break;case"START":l=parseInt(y[1]);break;case"END":u=parseInt(y[1]);break;case"LABEL":c=y[1];break;case"LABEL_SCALE":d=y[1];break;case"LABEL_COLOR":case"LABEL_COLOUR":h=255*(h=new NGL.Color(y[1].toLowerCase())).r+","+255*h.g+","+255*h.b;break;case"SIDECHAINS":p="on"==y[1];break;default:n=!0}}if(a){let e=!1;try{rxtest=RegExp(a,"g"),e=!0}catch(e){}e||(console.error("Motif regex is invalid"),n=!0)}if(n=null!=r||null!=c||p?n:!0)0<m[i].length&&"?"!=m[i].charAt(0)?f.push("?"+m[i]):f.push(m[i]);else{f.push(m[i]);for(const E in modelData)if(!modelData[E].status||"COMPLETED"==modelData[E].status){let s={};for(let e=0;e<modelData[E].targets.length;e++)if(!t||t==e+1){var _=modelData[E].targets[e];let t=_.target_sequence,n=_.id,i=(t||(t=_.templates[0].trg_seq,_.templates[0].tpl_seq&&(t=t.replaceAll("-","")),n=_.keyseq_chain_name,_.templates[0].trg_offset&&(t="-".repeat(_.templates[0].trg_offset-1)+t)),"string"!=typeof n&&(n=n.join("")),v["model_"+E]||(v["model_"+E]=[]),a);null==i&&(i=t.substring(l?l-1:0,u||t.length));for(let e=0;e<n.length;e++){var w=n.charAt(e);if(null==o||w==o){s[w]||(s[w]={labelled:[],selected:[]});var x=RegExp(i,"g");for(const L of t.matchAll(x)){let t=L.index+1,n=t+L[0].length-1;if(4==L.length&&(t+=L[1].length,n=t+L[2].length-1),!(l&&l>n)&&(!(u&&u<t)&&(l&&(t=Math.max(t,l)),u&&(n=Math.min(n,u)),r&&v["model_"+E].push({frmChn:w,toChn:w,resStart:t,resEnd:n,rgb:r}),c||p))){c&&"default"==c.toLowerCase()&&(c="default");var M=Math.floor((n-t)/2)+t;for(let e=t;e<=n;e++)p&&s[w].selected.push(e),"default"==c&&s[w].labelled.push(e);c&&"default"!=c&&s[w].labelled.push(M)}}}}}if((c||p)&&(null==g||g==E))if(0<$("#pv:visible",currentWin.document).length){var C=pv_viewer.get("model_"+E);C&&(C=C.structure().residueSelect(function(e){if(s[e.chain().name()]&&(-1<s[e.chain().name()].selected.indexOf(e.num())||-1<s[e.chain().name()].labelled.indexOf(e.num())))return-1<s[e.chain().name()].labelled.indexOf(e.num())&&e.eachAtom(function(e){var t=e.residue();"CA"==e.name()&&pv_viewer.label(`model_${E}.label`,"default"!=c?c:t.name()+" "+t.chain().name()+t.num(),e.pos(),{fontSize:12*(d||1),fontColor:h?`rgb(${h})`:"#CCC"})}),-1<s[e.chain().name()].selected.indexOf(e.num())}))&&pv_viewer.ballsAndSticks(`model_${E}.selected`,C)}else if(0<$("#ngl:visible",currentWin.document).length){C=getNGLComponentByName("model_"+E);if(C){let n="",i=!1;for(var P in s)if(0!=s[P].labelled.length){0<n.length&&(n+=" or "),n+="( :"+P+" and (";let t=null;for(let e=0;e<s[P].labelled.length;e++)i=!0,t=(t&&s[P].labelled[e]==t+1||(t&&(n+="-"+t),0<e&&(n+=" or "),n+=s[P].labelled[e]),s[P].labelled[e]);t&&(n+="-"+t),n+=") and .CA) "}i&&C.addRepresentation("label",{name:"model_"+E+".label",sele:n,labelType:"format",labelFormat:"default"!=c?c:"%(resname)s %(chainname)s%(resno)s",fontWeight:"bold",radiusScale:1.4*(d||1),xOffset:.3,color:h?`rgb(${h})`:"#909090"}),n="";let a=!1;for(var k in s)if(0!=s[k].selected.length){0<n.length&&(n+=" or "),n+="( :"+k+" and (";let t=null;for(let e=0;e<s[k].selected.length;e++)a=!0,t=(t&&s[k].selected[e]==t+1||(t&&(n+="-"+t),0<e&&(n+=" or "),n+=s[k].selected[e]),s[k].selected[e]);t&&(n+="-"+t),n+=")) "}a&&C.addRepresentation("ball+stick",{name:"model_"+E+".selected",sele:n,colorScheme:"element"})}}}}}g||(e=f.join("\n"),"undefined"!=typeof annotationsURL&&-1==e.search(/^\?/m)&&$.ajax({type:"POST",url:annotationsURL,data:{annotations:e,csrfmiddlewaretoken:$.cookie("csrftoken")},success:function(e){},error:function(e){console.error(e)}}),chainMapping.defaultColourScheme="features",$("#annotate").val()!=e&&$("#annotate").val(e),$(".alignTbl:first").alignment("colourAllAlignments",{features:v}))}$("#annotate").on("keyup",function(e){"Enter"===e.key&&processAnnotations()}),window.onload=()=>{const e={current:{}};document.body.addEventListener("selectResidues",function(i){if("index"!==i.detail.src)if(["structure","rama","outlier","features"].includes(i.detail.src)){let n={...e.current};if(n&&n[i.detail.struc_id]){let e=n[i.detail.struc_id].findIndex(e=>e.chain===i.detail.residues[0].chain&&e.resno===i.detail.residues[0].resno);if(i.detail.ctrl)if(-1===e)n[i.detail.struc_id]=n[i.detail.struc_id].concat(i.detail.residues);else for(let t of i.detail.residues)e=n[i.detail.struc_id].findIndex(e=>e.chain===t.chain&&e.resno===t.resno),n[i.detail.struc_id].splice(e,1);else-1===e?n[i.detail.struc_id]=i.detail.residues:n[i.detail.struc_id]=[]}else n={[i.detail.struc_id]:i.detail.residues};e.current=n,document.body.dispatchEvent(new CustomEvent("selectResidues",{detail:{src:"index",struc_id:i.detail.struc_id,residues:n[i.detail.struc_id]}}))}else e.current={[i.detail.struc_id]:i.detail.residues}})};var currentWin=window;let main_NGL_module=null,main_pv=null,main_ngl=null,plip_bond_num_dash=5,plip_bond_radius=.1,plip_higlight_factor=2,plip_higlight_bond_num_dash=1;var PLIP=PLIP||{};PLIP.AbstractViewer=null;let opacity_fadeout_ligand=.3,opacity_fadeout_protein=.3;function takeSnapshot(t,e){var n;".png"==t&&(t="structure.png"),0<$("#pv:visible",currentWin.document).length&&$("#pv canvas")[0].toBlob(function(e){saveAs(e,t)}),0<$("#ngl:visible",currentWin.document).length&&(e=e||1,n=$("#snapshot_bg_transparent_checkbox").is(":checked"),ngl_stage.makeImage({factor:e,antialias:!1,trim:!1,transparent:n}).then(function(e){NGL.download(e,t)}))}function resetStructure(){$(".hoverResidue").removeClass("hoverResidue"),$(".selectResidue").removeClass("selectResidue"),0<$("#pv:visible",currentWin.document).length&&(pv_viewer.show("*ligands"),pv_viewer.hide("*ligands_lines"),pv_viewer.rm("*res"),pv_viewer.autoZoom(),pv_viewer.requestRedraw()),0<$("#ngl:visible",currentWin.document).length&&(ngl_stage.eachRepresentation(function(e){-1<e.name.indexOf("hover")&&"none"!=e.repr.selection.string&&e.setSelection("none")}),ngl_stage.autoView(1200))}function spin(e){"undefined"!=typeof pv_viewer&&pv_viewer.spin(e),null!=ngl_stage&&(e?ngl_stage.setSpin([0,1,0],-.005):ngl_stage.setSpin(0))}function detach(e){if(currentWin==window){if(0<$("#pv:visible",currentWin.document).length)currentWin=window.open(e.replace("xx","pv"),"_blank","resizable=1,status=1,toolbar=1,location=1,height=700,width=700"),main_pv=pv_viewer;else{if(!(0<$("#ngl:visible",currentWin.document).length))return;main_ngl=ngl_stage,main_NGL_module=NGL,currentWin=window.open(e.replace("xx","ngl"),"_blank","resizable=1,status=1,toolbar=1,location=1,height=700,width=700")}$("#left-panel").is(".ui-resizable")&&$("#left-panel").resizable("destroy"),$("#left-panel").removeClass().addClass("detached"),$("#right-panel").hide(),$(window).trigger("resize")}}function attachPV(){pv_viewer=main_pv,attach()}function attachNGL(){var e=ngl_stage.viewerControls.getOrientation();NGL=main_NGL_module,(ngl_stage=main_ngl).removeAllComponents(),showNGL(e),attach()}function attach(){currentWin=window;let t=$("#right-panel").attr("class");if(t){t=t.split(/\s+/);for(let e=0;e<t.length;e++)3==(size=t[e].split("-")).length&&$("#left-panel").addClass(size[0]+"-"+size[1]+"-"+(12-parseInt(size[2])))}$("#left-panel").removeClass("detached").resizable({handles:"e",stop:function(){}}),$("#right-panel").show(),$(window).trigger("resize"),"undefined"!=typeof superposeTemplates&&superposeTemplates(!0),refreshBondsAndLigandHighlights()}function refreshBondsAndLigandHighlights(e){refreshHighlightLigands(e),refreshBonds(e)}function refreshBonds(e){void 0===e?plip_bonds.refreshAll():plip_bonds.refresh(e)}function refreshHighlightLigands(e){void 0===e?all_ligands.redrawAll():all_ligands.redraw(e)}function centerOnLigand(e,t){0<$("#pv:visible",currentWin.document).length&&centerOnLigandPV(e,t),0<$("#ngl:visible",currentWin.document).length&&centerOnLigandNGL(e,t)}function highlightLigand(e,t,n){$(".ligandContact").removeClass("ligandContact");for(var i={},a=0;a<t.length;a++)t[a]&&"_"!=t[a].charAt(0)&&(res=t[a].substring(1),i[chain=t[a].charAt(0)]||(i[chain]=[]),i[chain].push(res));var s,r=$(".alignTbl tr[struc_id="+n+"]"),o=r[0].hasAttribute("keyseqchain")?"keyseqchain":"chain";for(s in i)for(var l=r.filter("["+o+"="+s+"]").find("span").toArray(),a=0;a<i[s].length;a++)for(var u=0;u<l.length;u++)if(l[u].getAttribute("s")==i[s][a]){l[u].className="ligandContact";break}0<$("#pv:visible",currentWin.document).length&&highlightLigandPV(i,t,n),0<$("#ngl:visible",currentWin.document).length&&highlightLigandNGL(e,t,n)}function highlightResidues(e,t,n,i){if((null!=e||null!=t)&&null!=n)return 0<$("#pv:visible",currentWin.document).length?highlightResiduesPV(e,t,n,i):0<$("#ngl:visible",currentWin.document).length?highlightResiduesNGL(e,t,n,i):void 0;0<$("#pv:visible",currentWin.document).length&&(pv_viewer.rm("*_res"),pv_viewer.requestRedraw()),0<$("#ngl:visible",currentWin.document).length&&("undefined"!=typeof all_ligands&&"undefined"!=typeof plip_residues?highlightLigandNGL(all_ligands.getVisibleLigandIds(n),plip_residues.getVisibleResiduesResId(n),n,i):highlightResiduesNGL([],[],n,i))}function selectResidues(e){0<$("#pv:visible",currentWin.document).length&&selectResiduesPV(e),0<$("#ngl:visible",currentWin.document).length&&selectResiduesNGL(e)}function changeRep(e,t){e=e||"cartoon",0<$("#pv:visible",currentWin.document).length&&(changeRepPV(e,t),null!=pv_viewer)&&0<pv_viewer.all().length&&("undefined"!=typeof detached&&detached?window.opener.updatecols():updatecols()),0<$("#ngl:visible",currentWin.document).length&&(changeRepNGL(e,t),"undefined"!=typeof detached&&detached?window.opener.updatecols():updatecols())}function updatecolsSingleRes(e){$(".alignTbl:first").alignment("updateColoursSingleResidue",e)}function updatecols(){$(".alignTbl:first").alignment("viewerInitialised")}function fetchSecStruc(e){if(0<$("#pv:visible",currentWin.document).length&&"undefined"!=typeof pv_viewer&&null!==pv_viewer){if(pv_viewer.get(e))return fetchSecStrucPV(e,pv_viewer.get(e).structure())}else if(0<$("#ngl:visible",currentWin.document).length&&null!=ngl_stage&&getNGLComponentByName(e))return fetchSecStrucNGL(e,getNGLComponentByName(e).structure)}function fetchBFactors(e,t,n){if(0<$("#pv:visible",currentWin.document).length&&"undefined"!=typeof pv_viewer&&null!==pv_viewer){if(pv_viewer.get(e))return fetchBFactorsPV(e,pv_viewer.get(e).structure(),t,n)}else if(0<$("#ngl:visible",currentWin.document).length&&null!=ngl_stage&&getNGLComponentByName(e))return fetchBFactorsNGL(e,getNGLComponentByName(e).structure,t,n)}function setBFactorRange(e){let t=1e10,n=-1e10,i=0,a=0;for(chn in chainMapping.structures[e])for(res in chainMapping.structures[e][chn]){var s;chainMapping.structures[e][chn][res]&&chainMapping.structures[e][chn][res].bfactor&&(s=chainMapping.structures[e][chn][res].bfactor,t=Math.min(s,t),n=Math.max(s,n),i+=s*s,a++)}i/=a,i=Math.sqrt(i),n=2*i;var r=[];for(let e=0;e<256;e++)r.push([e,e,255]);for(let e=256;e<512;e++)r.push([255,512-e,512-e]);var o,l=chainMapping.annotations.map(e=>e.key).indexOf("bfactor_range");for(chn in chainMapping.annotations[l].rangeColours||(chainMapping.annotations[l].rangeColours={}),chainMapping.annotations[l].rangeColours[e]={},chainMapping.structures[e])for(res in chainMapping.annotations[l].rangeColours[e][chn]=[],chainMapping.structures[e][chn])chainMapping.structures[e][chn][res]&&chainMapping.structures[e][chn][res].bfactor&&(o=chainMapping.structures[e][chn][res].bfactor,o=Math.round(512*(o-t)/(n-t))-1,o=Math.max(o,0),o=Math.min(o,511),chainMapping.annotations[l].rangeColours[e][chn][res]=r[o])}document.addEventListener("DOMContentLoaded",()=>{document.body.addEventListener("highlightResidue",e=>{["structure","varianceChart"].includes(e.detail.src)||highlightResidues(e.detail.chain,e.detail.resno,e.detail.struc_id,e.detail.multiple)}),document.body.addEventListener("selectResidues",e=>{["structure","rama","outlier"].includes(e.detail.src)||selectResidues(e)}),document.body.addEventListener("centerResRange",e=>{0<$("#pv:visible",currentWin.document).length&&centerResRangePV(e.detail.chain,e.detail.min,e.detail.max,e.detail.struc_id,e.detail.isDisulfid,e.detail.secondChain),0<$("#ngl:visible",currentWin.document).length&&centerResRangeNGL(e.detail.chain,e.detail.min,e.detail.max,e.detail.struc_id,e.detail.isDisulfid,e.detail.secondChain)}),document.body.addEventListener("connectResidues",e=>{0<$("#pv:visible",currentWin.document).length&&connectResiduesPV(e.detail.residuePairs),0<$("#ngl:visible",currentWin.document).length&&connectResiduesNGL(e.detail.residuePairs)}),document.body.addEventListener("mousemove",e=>e.target.matches("#pv canvas")?doPVMouse(e):null,!0),document.body.addEventListener("click",e=>e.target.matches("#pv canvas")?doPVMouse(e):null,!0)});var ngl_stage=null,ngl_picked_atom=!1,ngl_picked_component=!1;function getNGL(){let e="white";var t,n;if($.cookie("bg_r")&&(e="rgb("+$.cookie("bg_r")+","+$.cookie("bg_r")+","+$.cookie("bg_r")+")"),(ngl_stage=new NGL.Stage("ngl",{backgroundColor:e,hoverTimeout:.005,sampleLevel:2,tooltip:!1})).viewerControls)return t=(new NGL.Matrix4).makeRotationX(Math.PI/2),n=(new NGL.Quaternion).setFromRotationMatrix(t),ngl_stage.viewerControls.rotate(n),t=(new NGL.Matrix4).makeRotationY(Math.PI),n=(new NGL.Quaternion).setFromRotationMatrix(t),ngl_stage.viewerControls.rotate(n),ngl_stage.signals.clicked.add(function(e,t){var n;e&&(e.atom||e.bond)?((n=e.atom||e.closestBondAtom).resno&&n.chainname&&e.component.autoView(n.resno+":"+n.chainname,1e3),document.body.dispatchEvent(new CustomEvent("selectResidues",{detail:{src:"structure",struc_id:e.component.name,residues:n.resno&&n.chainname?[{chain:n.chainname,resno:n.resno,...""!==n.inscode&&{insCode:n.inscode}}]:[],ctrl:e.ctrlKey||e.metaKey}}))):ngl_stage.autoView(1200)}),ngl_stage.signals.hovered.add(function(t){if(!ngl_stage.mouseObserver.pressed)if(t&&(t.atom||t.bond)){var n=t.atom||t.closestBondAtom;if(!ngl_picked_atom||n.structure.name!=ngl_picked_atom.structure.name||n.index!=ngl_picked_atom.index){var i=getNGLRepresentationByName(t.component.name);ngl_picked_atom=n,ngl_picked_component=t.component;let e=n.resname+" "+n.resno+n.inscode;"_"!=n.chainname&&(e+=" "+n.chainname),"_"!=n.chainname&&["cartoon","tube","rope"].includes(i.repr.type)&&"CA"==n.atomname||(e+=" "+n.atomname),e+=resAnnoLabel(t.component.name,n.chainname,n.resno),document.getElementById("ngl_status").innerHTML=e,document.body.dispatchEvent(new CustomEvent("highlightResidue",{detail:{src:"structure",struc_id:t.component.name,chain:n.chainname,resno:n.resno,...""!==n.inscode&&{insCode:n.inscode}},bubbles:!0})),"undefined"!=typeof detached&&detached?(window.opener.ngl_picked_atom=ngl_picked_atom,window.opener.updatecolsSingleRes({struc_id:t.component.name,chain:n.chainname,resno:n.resno})):updatecolsSingleRes({struc_id:t.component.name,chain:n.chainname,resno:n.resno})}}else ngl_picked_atom&&(ngl_picked_atom=!1,document.getElementById("ngl_status").innerHTML="","undefined"!=typeof detached&&detached?(window.opener.ngl_picked_atom=ngl_picked_atom,window.opener.updatecolsSingleRes()):updatecolsSingleRes())}),ngl_stage;throw new Error("NGL viewerControls not initialised. How is that possible!?")}function getNGLComponentByName(e){return ngl_stage.getComponentsByName(e).list[0]}function getNGLRepresentationByName(e){return ngl_stage.getRepresentationsByName(e).list[0]}function removeNGLComponentByName(e){e=getNGLComponentByName(e);ngl_stage.removeComponent(e)}function highlightResiduesNGL(i,a,s,t){let r="";if(s&&s.endsWith(".dna")&&(s=s.replace(".dna","")),!a){var o=getNGLComponentByName(s);let t="";if(o){if(1==i.length)t=(a||"")+":"+i;else for(let e=0;e<i.length;e++)t+=(a||"")+":"+i[e]+" ";o.autoView(t,1e3)}return t}ngl_stage.eachRepresentation(function(e){-1<e.name.indexOf("hover")&&-1==e.name.indexOf(s)&&"none"!=e.repr.selection.string&&e.setVisibility(!1)});o=getNGLRepresentationByName(s+".hover");if(o){o.setVisibility(!0),t&&(r=o.repr.selection.string+" ").startsWith("none")&&(r=r.substring(5));var l=getNGLComponentByName(s).structure;let n="";for(let t=0;t<i.length;t++)if(a.length)for(let e=0;e<a.length;e++)a[e][0]==a[e][1]?isResidueInStructureNGL(l,i[t],a[e][0])&&(n+=a[e][0]+":"+i[t]+" "):(console.warn("Not checking if the selection is part of the structure"),n+=a[e][0]+"-"+a[e][1]+":"+i[t]+" ");else isResidueInStructureNGL(l,i[t],a)&&(n+=a+":"+i[t]+" ");let e=r+n;return""===e&&(e="none"),o.setSelection(e),e}}function selectResiduesNGL(e){var t=e.detail.struc_id;if(null==t||null==e.detail.residues||0===e.detail.residues.length)ngl_stage.eachRepresentation(e=>{(e.name.endsWith(".select")||e.name.endsWith(".hover"))&&e.setVisibility(!1)});else{var n=getNGLRepresentationByName(t+".select");if(n)return n.setVisibility(!0),e=e.detail.residues.map(e=>e.resno+":"+e.chain).join(" "),n.setSelection(e),getNGLComponentByName(t).autoView(e,1e3),e}}function centerResRangeNGL(n,i,a,e,s,r){let o="";var l=getNGLComponentByName(e=e.replace(".dna",""));if(l){l=l.structure;for(let t=0;t<n.length;t++){var u=r?i:a;for(let e=i;e<=u;e++)s&&e!=i&&e!=u||isResidueInStructureNGL(l,n[t],e)&&(o+=e+":"+n[t]+" ")}if(r)for(let e=0;e<r.length;e++)isResidueInStructureNGL(l,r[e],a)&&(o+=a+":"+r[e]+" ");""!=o&&getNGLComponentByName(e).autoView(o,1e3)}}function centerOnLigandNGL(t,e){let n=t[0]+":_";for(let e=1;e<t.length;e++)n+=" "+t[e]+":_";for(var i in ngl_stage.compList)if(ngl_stage.compList[i].name==e){ngl_stage.compList[i].autoView(n,1e3);break}}function contactListToNGLSelection(e,t,n){var i={};let a=null;var s;if(void 0!==n&&null!=n||(n=[]),t&&0<t.length){var r=getNGLComponentByName(e).structure;for(let e=0;e<t.length;e++)t[e]&&(a=t[e].charAt(0),s=parseInt(t[e].substring(1)),"_"==a&&-1==n.indexOf(s)&&n.push(s),isResidueInStructureNGL(r,a,s))&&"-"!=a&&(i[a]||(i[a]=[]),i[a][s]=1)}let o="",l="";for(a in i){o+=" ( (",l+=" ( (";let t=!0;for(let e=0;e<i[a].length;e++)if(i[a][e]){for(t?t=!1:(o+=" or ",l+=" or "),o+=e,l+=e-2,start=e;e++,i[a][e];);1<e-start&&(o+="-"+(e-1)),l+="-"+(e+1)}o+=") AND :"+a+") ",l+=") AND :"+a+") "}return[o,l,n]}function isResidueInStructureNGL(e,t,n){let i={};try{e.eachChain(function(e){e.chainname==t&&e.eachResidue(function(e){if(e.resno==n)throw i})})}catch(e){if(e===i)return!0}return!1}function highlightLigandNGL(e,t,n,i,a){removeNGLComponentByName(n+"ligandBondsHL"),void 0===i&&(i="undefined"==typeof extra_residues_selection?[]:extra_residues_selection),void 0===a&&(a="undefined"==typeof extra_ranges_selection?[]:extra_ranges_selection),residue_contacts=t.concat(i),ranges_contacts=residue_contacts.concat(a);var s,t=contactListToNGLSelection(n,residue_contacts,e),r=(e=t[2],contactListToNGLSelection(n,ranges_contacts));let o=t[0],l=r[1];for(s in""==o&&(o="none"),""==l?(l="none",fadeOutRepresentationNGL(n,n,1)):fadeOutRepresentationNGL(n,n,opacity_fadeout_protein),ngl_stage.compList)if(ngl_stage.compList[s].name==n){for(var u in ngl_stage.compList[s].reprList)ngl_stage.compList[s].reprList[u].name==n+".residuesHighlight"&&ngl_stage.compList[s].reprList[u].setSelection(o),ngl_stage.compList[s].reprList[u].name==n+".highlight"&&(protein_residue_sele_string="protein AND ("+l+")",ngl_stage.compList[s].reprList[u].setSelection(protein_residue_sele_string));break}let c;e&&0<e.length?(c=":_ and ("+e.join(" or ")+")",fadeOutRepresentationNGL(n,n+".ligands",opacity_fadeout_ligand)):0<i.length||0<a.length?(c="none",fadeOutRepresentationNGL(n,n+".ligands",opacity_fadeout_ligand)):(c="none",fadeOutRepresentationNGL(n,n+".ligands",1));t=getNGLRepresentationByName(n+".ligandsHighlight");t&&t.setSelection(c)}function fadeOutRepresentationNGL(e,t,n){(repr=getNGLRepresentationByName(t))&&repr.setParameters({opacity:n})}function connectResiduesNGL(t){let n=[];ngl_stage.compList.forEach(function(e){-1<e.name.indexOf("connect")&&n.push(e)});for(let e=0;e<n.length;e++)ngl_stage.removeComponent(n[e]);if(t)for(let e=0;e<t.length;e++){var i,a=getNGLComponentByName(t[e][0].struc_id),s=new NGL.Shape("connect."+e+".line",{disableImpostor:!0});a&&(i=a.structure.getView(new NGL.Selection(t[e][0].res_num+":"+t[e][0].chain+".CA")).getAtomData().position,a=a.structure.getView(new NGL.Selection(t[e][1].res_num+":"+t[e][1].chain+".CA")).getAtomData().position,0<i.length)&&0<a.length&&(score=Math.min(1,2*t[e][2]),s.addCylinder(i,a,[.9,1-score,1-score],.2),ngl_stage.addComponentFromObject(s).addRepresentation("buffer"))}}function changeRepNGL(a,e){if("fog"===a)e?ngl_stage.setParameters({fogNear:40,fogFar:60}):ngl_stage.setParameters({forNear:50,fogFar:100}),jQuery.cookie("fog",e,{expires:365,path:"/"});else{switch($("#repBtnLbl").text(a.charAt(0).toUpperCase()+a.substring(1)),jQuery.cookie("defaultRepr",a,{expires:365,path:"/"}),a){case"lines":a="line";break;case"ballAndStick":a="ball+stick";break;case"outline":return}let n,i=null;ngl_stage.eachRepresentation(function(e){if(!e.name.match(/(ligands|dna|over|buffer|membrane|select)/))for(var t in n=e.name.split(".")[0],ngl_stage.compList)if((comp=ngl_stage.compList[t]).name==n){if("surface"==(i=null===i?e.repr.type:i)&&"surface"!=a){console.debug("Adding residuesHighlight representation"),comp.addRepresentation(a,{name:n+".residuesHighlight",sele:"none",smoothSheet:!0,roughness:1,surfaceType:"sas",probeRadius:1.4,side:"front",opacity:e.getParameters().opacity,scaleFactor:Math.min(1.5,Math.max(.1,5e4/comp.structure.atomCount))});try{refreshBondsAndLigandHighlights()}catch(e){}}comp.removeRepresentation(e),"surface"==a&&e.name==n+".residuesHighlight"?console.debug("Removing surface residuesHighlight"):comp.addRepresentation(a,{name:e.name,sele:e.getParameters().sele,smoothSheet:!0,surfaceType:"sas",probeRadius:1.4,scaleFactor:Math.min(1.5,Math.max(.1,5e4/comp.structure.atomCount)),roughness:1,side:"front",opacity:e.getParameters().opacity})}})}}function setupNGLRepresentations(t,n,e,i,a,s){a&&ngl_stage.viewerControls.orient(a),void 0===e&&(e=!1);let r=$.cookie("defaultRepr");r?"ballAndStick"===r?r="ball+stick":"lines"===r&&(r="line"):r="cartoon",t.setName(n),t.addRepresentation(r,{name:n,sele:"not :_ and not nucleic and not :-"+(s?" and not ligand":""),smoothSheet:!0,roughness:1,surfaceType:"sas",probeRadius:1.4,scaleFactor:Math.min(1.5,Math.max(.1,5e4/t.structure.atomCount)),side:"front"}),t.addRepresentation("ball+stick",{name:n+".ligands",colorScheme:"element",sele:":_"+(s?" or ligand":""),side:"front"}),t.addRepresentation("ball+stick",{name:n+".residuesHighlight",colorScheme:"element",sele:"none",aspectRatio:1}),t.addRepresentation("ball+stick",{name:n+".hover",sele:"none"});const o=t.addRepresentation("ball+stick",{name:n+".select",colorScheme:"element",sele:"@0",aspectRatio:1});setTimeout(function(){o.setVisibility(!1)},0),e&&(t.addRepresentation("ball+stick",{name:n+".ligandsHighlight",colorScheme:"element",sele:"none"}),"surface"!=r)&&t.addRepresentation(r,{name:n+".highlight",sele:"none",smoothSheet:!0,roughness:1,surfaceType:"sas",probeRadius:1.4,scaleFactor:Math.min(1.5,Math.max(.1,5e4/t.structure.atomCount)),side:"front"}),i&&i.forEach(function(e){scheme="line"==e?"element":"base"==e?"resname":"moleculetype",t.addRepresentation(e,{name:n+".dna",colorScheme:scheme,sele:"nucleic and not :_"})}),a?ngl_stage.autoView():"function"==typeof on_viewer_ready_function?on_viewer_ready_function(n,t):t.autoView(1e3),updatecols(),e&&refreshBondsAndLigandHighlights()}function resAnnoLabel(e,i,a){let s="";return[e,e+".dna"].forEach(n=>{if(chainMapping.structures[n]&&chainMapping.structures[n][i]&&chainMapping.structures[n][i][a]){chainMapping.chainMeta[n]&&chainMapping.chainMeta[n][i]&&(s+=" ("+chainMapping.chainMeta[n][i].display+")");for(let t=0;t<chainMapping.annotations.length;t++)if(chainMapping.annotations[t].active&&null!=chainMapping.structures[n][i][a][chainMapping.annotations[t].key]){let e=chainMapping.structures[n][i][a][chainMapping.annotations[t].key];s+="<br><small>"+chainMapping.annotations[t].label+": "+("number"==typeof e?e.toFixed("ramachandran"==chainMapping.annotations[t].key?4:2):e),"qm"==chainMapping.annotations[t].key&&"confClass"==$.cookie("colourScheme")&&(e<1&&(e*=100),90<e?s+=" (Very high)":70<e?s+=" (Confident)":50<e?s+=" (Low)":s+=" (Very low)"),s+="</small>"}}}),s}function fetchBFactorsNGL(i,e,a,s){let r=0,o=0;return chainMapping.structures[i]||(chainMapping.structures[i]={}),e.eachResidue(function(e){var n=e.chainname;if(!n.match(/(_|-)/)){let t=0;if(!e.isProtein()&&!e.isNucleic())return!1;e.eachAtom(function(e){t+=e.bfactor}),r+=t/e.atomCount,o++,coloursAssigned=!0,chainMapping.structures[i][n]||(chainMapping.structures[i][n]=[]),chainMapping.structures[i][n][e.resno]||(chainMapping.structures[i][n][e.resno]={}),s&&!chainMapping.structures[i].invalidMapping&&chainMapping.structures[i][n][e.resno].resname&&residueProperties[chainMapping.structures[i][n][e.resno].resname].triplet!=e.resname&&(chainMapping.structures[i].invalidMapping=!0),chainMapping.structures[i][n][e.resno][a]=t/e.atomCount}}),"bfactor"==a&&setBFactorRange(i),0<r?r/o:0}function fetchSecStrucNGL(t,e){let n;return e.eachResidue(function(e){(n=e.chainname).match(/(_|-)/)||(chainMapping.structures[t]||(chainMapping.structures[t]={}),chainMapping.structures[t][n]||(chainMapping.structures[t][n]=[]),chainMapping.structures[t][n][e.resno]||(chainMapping.structures[t][n][e.resno]={}),chainMapping.structures[t][n][e.resno].ss=e.sstruc.toUpperCase(),""==chainMapping.structures[t][n][e.resno].ss&&(chainMapping.structures[t][n][e.resno].ss="C"))}),!0}function setColorForAtom(e,t,n){var i=e.structure().createEmptyView();i.addAtom(t),e.colorBy(pv.color.uniform(n),i)}let prevPicked=null;function doPVMouse(e){var t,n,i,a,s,r,o;pv_viewer._mouseHandler._lastMouseDownTime&&(null==pv_viewer._mouseHandler._lastMouseDownTime||pv_viewer._mouseHandler._lastMouseUpTime<pv_viewer._mouseHandler._lastMouseDownTime)||(t="click"===e.type&&pv_viewer._mouseHandler._lastMouseUpTime-pv_viewer._mouseHandler._lastMouseDownTime<300,n=pv_viewer.boundingClientRect(),n=pv_viewer.pick({x:e.clientX-n.left,y:e.clientY-n.top}),null!==prevPicked&&null!==n&&n.target()===prevPicked.atom?"click"===e.type&&("_"!==(i=(a=prevPicked.atom).qualifiedName().split("."))[0].charAt(0)&&a.residue()._isAminoacid&&document.body.dispatchEvent(new CustomEvent("selectResidues",{detail:{src:"structure",struc_id:n.object().geom.name(),residues:[{chain:i[0],resno:a.residue().num(),..."\0"!==a.residue().insCode()&&{insCode:a.residue().insCode()}}],ctrl:e.ctrlKey||e.metaKey}})),pv_viewer.fitTo(a.residue())):(null!==prevPicked&&setColorForAtom(prevPicked.node,prevPicked.atom,prevPicked.color),null!==n?"_"===(a=(i=n.target()).qualifiedName().split("."))[0].charAt(0)||!i.residue().isAminoacid()&&!i.residue().isNucleotide()?document.getElementById("pv_status").innerHTML=i.residue().name()+" "+i.residue().num():(o=[0,0,0,0],n.node().getColorForAtom(i,o),prevPicked={atom:i,color:o,node:n.node()},setColorForAtom(n.node(),i,"red"),o=n.object().geom.name(),o=i.residue().name()+" "+(s=i.residue().num())+(r=i.residue().insCode())+" "+a[0]+resAnnoLabel(o,a[0],s),document.getElementById("pv_status").innerHTML=o,e.target.dispatchEvent(new CustomEvent("highlightResidue",{detail:{src:"structure",struc_id:n.object().geom.name(),chain:a[0],resno:i.residue().num(),..."\0"!==r&&{insCode:r}},bubbles:!0}))):(document.getElementById("pv_status").innerHTML="",prevPicked=null,t&&pv_viewer.autoZoom()),pv_viewer.requestRedraw()))}function highlightResiduesPV(t,n,i,e){e||pv_viewer.rm("*_res"),chainMapping.structures&&chainMapping.structures[i]&&!chainMapping.structures[i][t]&&chainMapping.structures[i+".dna"]&&chainMapping.structures[i][t+".dna"]&&(i+=".dna");let a=pv_viewer.get(i);if(null!=a){if(a=a.structure(),n){let e=null;return e=n.length?a.select({cnames:t.split("")}).residueSelect(function(t){for(let e=0;e<n.length;e++)if(t.num()>=n[e][0]&&t.num()<=n[e][1])return!0;return!1}):a.select({cnames:t.split("")}).residueSelect(function(e){return e.num()==n}),pv_viewer.ballsAndSticks((i?i+"_":"")+"res",e),e}pv_viewer.fitTo(a.select({cnames:t.split("")})),pv_viewer.requestRedraw()}}function selectResiduesPV(n){if(pv_viewer.rm("*select"),pv_viewer.rm("*res"),null==n.detail||null==n.detail.residues||0===n.detail.residues.length)pv_viewer.requestRedraw();else{var t,i=n.detail.struc_id;let e=pv_viewer.get(i);if(null!=e)return t=null,t=(e=e.structure()).select({cnames:Array.from(new Set(n.detail.residues.map(e=>e.chain)))}).residueSelect(e=>{for(var t of n.detail.residues)if(e.chain().name()===t.chain&&e.num()>=t.resno&&e.num()<=t.resno)return!0;return!1}),pv_viewer.ballsAndSticks(i+".select",t),n.detail.centerOnThis?centerResRangePV(n.detail.centerOnThis.chain,n.detail.centerOnThis.min,n.detail.centerOnThis.max):pv_viewer.fitTo(t),pv_viewer.requestRedraw(),t}}function centerResRangePV(t,n,i,e,a,s){chainMapping.structures&&chainMapping.structures[e]&&!chainMapping.structures[e][t]&&chainMapping.structures[e+".dna"]&&chainMapping.structures[e][t+".dna"]&&(e+=".dna");let r=null;for(;;){var o=pv_viewer.get(e);if(null==o)return;if(0<(r=1===t.length?o.structure().residueSelect(e=>s?e.num()===n&&t.includes(e.chain().name())||e.num()===i&&e.chain().name()===s:a?(e.num()===n||e.num()===i)&&t.includes(e.chain().name()):e.num()>=n&&e.num()<=i&&t.includes(e.chain().name())):o.structure().residueSelect(function(e){return a?(e.num()==n||e.num()==i)&&-1<t.indexOf(e.chain().name()):e.num()>=n&&e.num()<=i&&-1<t.indexOf(e.chain().name())})).chains().length||e.endsWith(".ligands"))break;e=e.replace(".dna","")+".ligands"}pv_viewer.fitTo(r),pv_viewer.requestRedraw()}function centerOnLigandPV(n,e){let t=pv_viewer.get(e+".ligands");null!=t&&(e=(t=t.structure()).residueSelect(function(t){for(let e=0;e<n.length;e++)if(t.num()==n[e])return!0}),pv_viewer.fitTo(e),pv_viewer.requestRedraw())}function highlightLigandPV(a,e,t){var n;pv_viewer.rm("*ligandContactsHL"),null!=pv_viewer.get(t+".ligands")&&a&&(n=pv_viewer.get(t).structure().residueSelect(function(e){var t=e.chain().name(),n=e.num(),i=a[t];if(i)for(let e=0;e<i.length;e++)if(n==i[e])return!0}),pv_viewer.lines(t+"ligandContactsHL",n),pv_viewer.requestRedraw())}function connectResiduesPV(n){if(pv_viewer.rm("connect.*"),n)for(let t=0;t<n.length;t++){var i,a,s,r=pv_viewer.customMesh("connect."+t+".line");let e=pv_viewer.get(n[t][0].struc_id);e&&(i=(e=e.structure()).atom(n[t][0].chain+"."+n[t][0].res_num+".CA"),a=e.atom(n[t][1].chain+"."+n[t][1].res_num+".CA"),i)&&a&&(s=pv.vec3.clone(i.pos()),pv.vec3.add(s,s,a.pos()),pv.vec3.scale(s,s,.5),score=Math.min(1,2*n[t][2]),r.addTube(i.pos(),a.pos(),.1,{color:[.9,1-score,1-score]}))}pv_viewer.requestRedraw()}function changeRepPV(t,e){if("outline"==(t=t.match(/(cartoon|tube|trace|lines|outline|fog)/)?t:"cartoon"))jQuery.cookie("pv_outline",!pv_viewer.options("outline"),{expires:365,path:"/"}),pv_viewer.options("outline",!pv_viewer.options("outline"));else if("fog"===t){e=void 0!==e?e:!pv_viewer.options("fog");jQuery.cookie("fog",e,{expires:365,path:"/"}),pv_viewer.options("fog",e)}else if(t.match(/(cartoon|tube|trace|lines|ballAndStick)/)){$("#repBtnLbl").text(t.charAt(0).toUpperCase()+t.substring(1)),jQuery.cookie("defaultRepr",t,{expires:365,path:"/"});let n=[],i=[];pv_viewer.forEach(function(e){var t=e.name();t.match(/(ligand|dna|res|LigandBond|membrane|label|select)/)||(n.push(t),i.push(e.structure()))});for(let e=0;e<n.length;e++)pv_viewer.rm(n[e]);for(let e=0;e<i.length;e++){var a=n[e],s=i[e];switch(t){case"cartoon":pv_viewer.cartoon(a,s,{color:pv.color.uniform("white")});break;case"tube":pv_viewer.tube(a,s,{color:pv.color.uniform("white")});break;case"trace":pv_viewer.trace(a,s,{color:pv.color.uniform("white")});break;case"lines":pv_viewer.lines(a,s,{color:pv.color.uniform("white")});break;case"ballAndstick":pv_viewer.ballsAndSticks(a,s,{color:pv.color.uniform("white")})}}}}function normalize(e){var t=[],n=e[0],i=e[1],a=e[2],n=n*n+i*i+a*a;return 0<n&&(n=1/Math.sqrt(n),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n),t}function cross(e,t){var n=[],i=e[0],a=e[1],e=e[2],s=t[0],r=t[1],t=t[2];return n[0]=a*t-e*r,n[1]=e*s-i*t,n[2]=i*r-a*s,n}function showMembrane(n,r){var o=membraneData[n];if(o){let e=null;if(0<$("#pv:visible",currentWin.document).length){if(!pv_viewer.get(n))return;if(e="pv",!r)return pv_viewer.hide(n+".membrane"),void pv_viewer.requestRedraw();if(pv_viewer.get(n+".membrane"))return pv_viewer.show(n+".membrane"),void pv_viewer.requestRedraw()}if(0<$("#ngl:visible",currentWin.document).length){if(e="ngl",!getNGLComponentByName(n))return;var l=getNGLComponentByName(n+".membrane");if(l)return void l.setVisibility(r);if(!r)return}var u=(e,t)=>{var n=t[0]-e[0],i=t[1]-e[1],t=t[2]-e[2];return Math.sqrt(n*n+i*i+t*t)};let t=[0,1,0];Math.abs(1-Math.abs((l=o.axis,r=t,l[0]*r[0]+l[1]*r[1]+l[2]*r[2])))<=1e-5&&(t=[0,0,1]),plane_x=normalize(cross(o.axis,t)),plane_y=normalize(cross(o.axis,plane_x));var c=[],h=[];let i=[];"pv"==e?pv_viewer.get(n).structure().eachAtom(function(e){"CA"==e.name()&&i.push(e.pos())}):"ngl"==e&&getNGLComponentByName(n).structure.eachResidue(function(e){e.eachAtom(function(e){"CA"==e.atomname&&i.push([e.x,e.y,e.z])})});var d=[];let a="",s=1;var p=1.5,g=o.radius/2+24;for(let n=-g;n<g;n+=p)for(let t=-g;t<g;t+=p)if(!(u(pos=[o.plane_one_center[0]+n*p*plane_x[0]+t*p*plane_y[0],o.plane_one_center[1]+n*p*plane_x[1]+t*p*plane_y[1],o.plane_one_center[2]+n*p*plane_x[2]+t*p*plane_y[2]],o.plane_one_center)>o.radius+8)){pos2=[o.plane_two_center[0]+n*p*plane_x[0]+t*p*plane_y[0],o.plane_two_center[1]+n*p*plane_x[1]+t*p*plane_y[1],o.plane_two_center[2]+n*p*plane_x[2]+t*p*plane_y[2]];let e=0;for(;e<i.length;)u(pos,i[e])<5?c.push(i.splice(e,1)[0]):u(pos2,i[e])<5?h.push(i.splice(e,1)[0]):e++;d.push([pos,pos2])}for(let i=0;i<d.length;i++){let n=c,e=0;do{let t=!1;var f=d[i][e++];for(let e=0;e<n.length;e++)if(u(f,n[e])<5){t=!0;break}t||(a+="ATOM  "+("     "+s++).slice(-5)+"   -  MEM M   1    "+("        "+f[0].toFixed(3)).slice(-8)+("        "+f[1].toFixed(3)).slice(-8)+("        "+f[2].toFixed(3)).slice(-8)+"  1.00  0.00    \n"),n=h}while(e<2)}if(a+="END","pv"==e)pv_viewer.points(n+".membrane",pv.io.pdb(a),{color:pv.color.uniform("#8b8b8b"),pointSize:2}),o.viewTransform&&pv_viewer.setRotation(o.viewTransform);else if("ngl"==e){for(schemeId in NGL.ColormakerRegistry.userSchemes)-1<schemeId.indexOf(n+".membrane")&&NGL.ColormakerRegistry.removeScheme(schemeId);membraneData[n].viewTransform&&ngl_stage.viewerControls.orient(membraneData[n].viewTransform),schemeId=NGL.ColormakerRegistry.addScheme(function(e){this.atomColor=function(){return 9868950}},n+".membrane");r=new Blob([a],{type:"text/plain"});ngl_stage.loadFile(r,{ext:"pdb"}).then(function(e){e.setName(n+".membrane"),e.addRepresentation("point",{name:n+".membrane",pointSize:2,useTexture:!0,forceTransparent:!0,edgeBleach:.6,color:schemeId}),membraneData[n].viewTransform&&ngl_stage.viewerControls.spin([0,1,0],Math.PI),ngl_stage.autoView()})}}}function fetchBFactorsPV(i,e,a,s){let r=0,o=0;return e.eachChain(function(e){(chn=e.name()).match(/(_|-)/)||(chainMapping.structures[i]||(chainMapping.structures[i]={}),chainMapping.structures[i][chn]||(chainMapping.structures[i][chn]=[]),e.eachResidue(function(e){if(e.isAminoacid()||e.isNucleotide()){let t=0,n=0;e.eachAtom(function(e){t+=e.tempFactor(),n++}),r+=t/n,o++,chainMapping.structures[i][chn][e.num()]||(chainMapping.structures[i][chn][e.num()]={}),s&&!chainMapping.structures[i].invalidMapping&&chainMapping.structures[i][chn][e.num()].resname&&residueProperties[chainMapping.structures[i][chn][e.num()].resname].triplet!=e.name()&&(chainMapping.structures[i].invalidMapping=!0),chainMapping.structures[i][chn][e.num()][a]=t/n}}))}),"bfactor"==a&&setBFactorRange(i),0<r?r/o:0}function fetchSecStrucPV(t,e){return e.eachResidue(function(e){(chn=e.chain().name()).match(/(_|-)/)||(chainMapping.structures[t]||(chainMapping.structures[t]={}),chainMapping.structures[t][chn]||(chainMapping.structures[t][chn]=[]),chainMapping.structures[t][chn][e.num()]||(chainMapping.structures[t][chn][e.num()]={}),chainMapping.structures[t][chn][e.num()].ss=e.ss())}),!0}function midpoint1d(e,t,n){return e+(t-e)*n}function midpoint3d(e,t,n){return[midpoint1d(e[0],t[0],n),midpoint1d(e[1],t[1],n),midpoint1d(e[2],t[2],n)]}function showWaterPV(){pv_viewer.ballsAndSticks("water",pv_viewer.get("template").structure().select({rnames:["HOH"]}))}function showWaterNGL(){log.console("showWaterNGL not implemented")}function showWater(){0<$("#pv:visible",currentWin.document).length&&showWaterPV(),0<$("#ngl:visible",currentWin.document).length&&showWaterNGL()}function toggleBond(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&(plip_bonds.getBondById(e,t).toggle(),deHighlightBond(e,t,!0))}function highlightBond(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&plip_bonds.getBondById(e,t).highlight()}function deHighlightBond(e,t,n){PLIP.AbstractViewer.isStructureEnabled(e)&&(null==n&&(n=!0),plip_bonds.getBondById(e,t).dehighlight(!0,n))}function highlightBonds(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&(plip_bonds.getBondsById(e,t).forEach(function(e){e.highlight(!1)}),plip_residues.redraw(e))}function deHighlightBonds(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&(plip_bonds.getBondsById(e,t).forEach(function(e){e.dehighlight(!1)}),plip_residues.redraw(e))}function clickBonds(e,t,n){toggleBonds(e,t,n),$("#plip_bonds_"+n).prop("checked")&&fitToBonds(e,t,n)}function toggleBonds(e,t,n){var n=$("#plip_bonds_"+n),i=n.prop("checked");n.prop("checked",!i),n.trigger("change")}function changeBondsCheckbox(e,t,n){var i=$("#plip_bonds_"+n),a=i.prop("checked");PLIP.AbstractViewer.isStructureEnabled(e)?(plip_bonds.getBondsById(e,t).forEach(function(e){a?e.show(!1):e.hide(!1),e.dehighlight(!1,!0)}),plip_residues.redraw(e),a&&plip_interactions_fit_bonds&&fitToBonds(e,t,n)):i.prop("checked",!1)}function showBonds(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&(plip_bonds.getBondsById(e,t).forEach(function(e){e.show(!1),e.dehighlight(!1,!0)}),plip_residues.redraw(e))}function hideBonds(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&(plip_bonds.getBondsById(e,t).forEach(function(e){e.hide(!1),e.dehighlight(!1,!0)}),plip_residues.redraw(e))}function fitToBond(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&plip_bonds.getBondById(e,t).fitView()}function fitToResidue(e,t,n){PLIP.AbstractViewer.isStructureEnabled(e)&&(residue=plip_residues.getResidue(e,t),n?(ligand=all_ligands.getLigandById(e,n),PLIP.AbstractViewer.fitView(e,[ligand],[residue])):PLIP.AbstractViewer.fitView(e,null,[residue]))}function fitToBonds(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&plip_bonds.fitViewBonds(e,t)}function showResidues(e,t,n){PLIP.AbstractViewer.isStructureEnabled(e)&&(plip_residues.getResiduesByResId(e,t).forEach(function(e){e.show(!1)}),plip_residues.redraw(e))}function hideResidues(e,t,n){PLIP.AbstractViewer.isStructureEnabled(e)&&(plip_residues.getResiduesByResId(e,t).forEach(function(e){e.hide(!1)}),plip_residues.redraw(e))}function showLigands(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&(all_ligands.getLigandsById(e,t).forEach(function(e){e.show(!1,!0)}),all_ligands.redraw(e))}function hideLigands(e,t){PLIP.AbstractViewer.isStructureEnabled(e)&&(all_ligands.getLigandsById(e,t).forEach(function(e){e.hide(!1,null,!0)}),all_ligands.redraw(e))}function togglePLIPLigandContacts(e,t,n){($("#togglePLIPLigandContacts_"+e).hasClass("glyphicon-chevron-down")?showPLIPLigandContacts:hidePLIPLigandContacts)(e,t,n)}function showPLIPLigandContacts(e,t,n){$("#PLIPligandContacts_"+e).show(100),setTimeout(function(){$("#togglePLIPLigandContacts_"+e).addClass("glyphicon-chevron-up").removeClass("glyphicon-chevron-down")},100),void 0!==n&&(showBonds(t,n),fitToBonds(t,n))}function hidePLIPLigandContacts(e,t,n){$("#PLIPligandContacts_"+e).hide(100),setTimeout(function(){$("#togglePLIPLigandContacts_"+e).addClass("glyphicon-chevron-down").removeClass("glyphicon-chevron-up")},100),void 0!==n&&hideBonds(t,n)}PLIP.Bonds=function(){var i={};this.hasStruc=function(e){return e in i},this.removeStruc=function(e){e in i&&delete i[e]},this.addStruc=function(e){this.hasStruc(e)||(i[e]=[])},this.listStruc=function(){return Object.keys(i)},this.listVisible=function(e){if(this.hasStruc(e))return i[e].filter(function(e){return e.isVisible()});console.error("listVisible: no strucId "+e)},this.getBondById=function(e,t){if(e in i)return i[e].find(function(e){return e.id===t});console.error("getBondById: no strucId "+e),console.trace()},this.getBondsById=function(e,t){if(e in i)return i[e].filter(function(e){return t.includes(e.id)});console.error("getBondsById: no strucId "+e)},this.add=function(e){this.addStruc(e.strucId),i[e.strucId].push(e)};this.showAll=function(e){for(var t=i[e],n=0;n<t.length;n++)t[n].isVisible()||t[n].show(!1);plip_residues.redraw(e)},this.hideAll=function(e){for(var t=i[e],n=0;n<t.length;n++)t[n].isVisible()&&t[n].hide(!1);plip_residues.redraw(e)},this.fitViewBonds=function(e,t){var t=this.getBondsById(e,t),n=t.map(function(e){return e.ligand}).filter(function(e,t,n){return n.indexOf(e)==t}),t=t.map(function(e){return e.residue}).filter(function(e,t,n){return n.indexOf(e)==t});PLIP.AbstractViewer.fitView(e,n,t)},this.refresh=function(e){for(var t=0;t<i[e].length;t++)i[e][t].refresh()},this.refreshAll=function(){for(var e in i)PLIP.AbstractViewer.isStructureEnabled(e)&&this.refresh(e)}},PLIP.Bond=function(e,t,n,i,a,s,r,o,l){let u=!1,c=!1,h=void 0,d="LigandBond"+e,p=void 0,g="LigandBondHighlight"+e;this.show=function(e){null==e&&(e=!0),this.isVisible()?console.info("Bond already visible"):PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(this.draw(),void 0!==this.residue&&this.residue.show(!1),this.ligand.show(e),u=!0,e)&&pv_viewer.requestRedraw()},this.hide=function(e){null==e&&(e=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&this.isVisible()&&(this.destroy(),u=!1,void 0!==this.residue&&this.residue.hide(!1),this.ligand.hide(e),e)&&pv_viewer.requestRedraw()},this.draw=function(){null==this.coo3?PLIP.AbstractViewer.addBondLine(this.getBondMesh(),this.coo1,this.coo2,plip_bond_num_dash,plip_bond_radius,this.color,!0):(PLIP.AbstractViewer.addBondLine(this.getBondMesh(),this.coo1,this.coo3,plip_bond_num_dash,plip_bond_radius,this.color,!1),PLIP.AbstractViewer.addBondLine(this.getBondMesh(),this.coo2,this.coo3,plip_bond_num_dash,plip_bond_radius,this.color,!1),PLIP.AbstractViewer.addWaterCircle(this.getBondMesh(),this.coo3,2*plip_bond_radius,this.color,!0))},this.destroy=function(){h=PLIP.AbstractViewer.removeMesh(d)},this.refresh=function(){this.destroy(),this.isVisible()&&this.draw(),this.destroyHighlight(),this.isHighlighted()&&this.drawHighlight()},this.toggle=function(){this.isVisible()?this.hide():this.show()},this.isVisible=function(){return u},this.getBondMesh=function(){return h=null==h?PLIP.AbstractViewer.newBondMesh(d):h},this.highlight=function(e){null==e&&(e=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&!this.isHighlighted()&&(this.drawHighlight(),void 0!==this.residue&&this.residue.show(!1),this.ligand.show(e),c=!0)},this.drawHighlight=function(){null==this.coo3?PLIP.AbstractViewer.addBondLine(this.getBondMeshHighlight(),this.coo1,this.coo2,plip_higlight_bond_num_dash,plip_bond_radius*plip_higlight_factor,this.color,!0):(PLIP.AbstractViewer.addBondLine(this.getBondMeshHighlight(),this.coo1,this.coo3,plip_higlight_bond_num_dash,plip_bond_radius*plip_higlight_factor,this.color,!1),PLIP.AbstractViewer.addBondLine(this.getBondMeshHighlight(),this.coo2,this.coo3,plip_higlight_bond_num_dash,plip_bond_radius*plip_higlight_factor,this.color,!1),PLIP.AbstractViewer.addWaterCircle(this.getBondMeshHighlight(),this.coo3,plip_bond_radius*plip_higlight_factor*2,this.color,!0))},this.destroyHighlight=function(){p=PLIP.AbstractViewer.removeMesh(g)},this.dehighlight=function(e){null==e&&(e=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&this.isHighlighted()&&this.isHighlighted()&&(this.destroyHighlight(),void 0!==this.residue&&this.residue.hide(!1),this.ligand.hide(e),c=!1,e)&&pv_viewer.requestRedraw()},this.toggleHighlight=function(){this.isHighlighted()?this.dehighlight():this.highlight()},this.isHighlighted=function(){return c},this.getBondMeshHighlight=function(){return p=null==p?PLIP.AbstractViewer.newBondMesh(g):p},this.fitView=function(){PLIP.AbstractViewer.fitView(this.strucId,[this.ligand],[this.residue])},this.getLigand=function(){return this.ligand},this.residue=plip_residues.addResidue(t,o[0],o[1],o[2]),this.residue.addBond(this),this.id=e,this.strucId=t,this.ligand=n,this.coo1=i,this.coo2=a,this.coo3=s,this.color=r,l&&this.show()},PLIP.makeResidueId=function(e,t,n){return e+":"+t+n},PLIP.Residue=function(e,t,n,i){var a=0,s=[];this.show=function(e){null==e&&(e=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&0<++a&&e&&plip_residues.redraw(this.strucId)},this.hide=function(e,t){null==e&&(e=!0),null==t&&(t=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(t?a=Math.max(a-1,0):alert("Did not decrement counter! "+this.id+": "+a),0==a)&&e&&plip_residues.redraw(this.strucId)},this.isVisible=function(){return 0<a},this.getOldResId=function(){return this.chain+this.position},this.addBond=function(e){s.push(e)},this.getBonds=function(){return s},this.strucId=e,this.id=PLIP.makeResidueId(t,n,i),this.chain=t,this.one_letter=n,this.position=i},PLIP.Residues=function(){var n={};this.hasStruc=function(e){return e in n},this.removeStruc=function(e){e in n&&delete n[e]},this.addStruc=function(e){this.hasStruc(e)||(n[e]=[])},this.listStruc=function(){return Object.keys(n)},this.getStruc=function(e){if(e in n)return n[e];void 0===e?console.error("StrucId is undefined"):console.error("No such strucId: '"+e+"'"),console.trace()},this.addResidue=function(e,t,n,i){this.addStruc(e);var a=PLIP.makeResidueId(t,n,i),a=this.getResidue(e,a);return void 0===a&&(a=new PLIP.Residue(e,t,n,i),this.getStruc(e).push(a)),a},this.getResidue=function(e,t){if(e in n)return this.getStruc(e).find(function(e){return e.id==t})},this.getResidueByOldResId=function(e,t){if(e in n)return this.getStruc(e).find(function(e){return e.getOldResId()==t})},this.getResiduesByResId=function(e,t){if(e in n)return n[e].filter(function(e){return t.includes(e.id)})},this.getVisibleResidues=function(e){return this.hasStruc(e)?this.getStruc(e).filter(function(e){return e.isVisible()}):[]},this.getVisibleResiduesResId=function(e){return this.getVisibleResidues(e).map(function(e){return e.getOldResId()})},this.redraw=function(e){highlightLigand(all_ligands.getVisibleLigandIds(e),this.getVisibleResiduesResId(e),e),pv_viewer.requestRedraw()},this.redrawAll=function(){for(var e in n)PLIP.AbstractViewer.isStructureEnabled(e)&&this.redraw(e)}},PLIP.Ligands=function(){var n={};this.hasStruc=function(e){return e in n},this.removeStruc=function(e){this.hasStruc(e)&&delete n[e]},this.addStruc=function(e){this.hasStruc(e)||(n[e]=[])},this.listStruc=function(){return Object.keys(n)},this.getStruc=function(e){if(this.hasStruc(e))return n[e];void 0===e?console.error("StrucId "+e+" is undefined"):console.error("No such strucId: '"+e+"'"),console.trace()},this.getLigandById=function(e,t){if(this.hasStruc(e))return n[e].find(function(e){return e.id===t});console.error("getLigandById: no strucId "+e),console.trace()},this.getLigandsById=function(e,t){if(this.hasStruc(e))return n[e].filter(function(e){return t.includes(e.id)});console.error("getLigandsById: no strucId "+e)},this.addLigand=function(e,t){this.addStruc(e);var n=this.getLigandById(e,t);return void 0===n&&(n=new PLIP.Ligand(e,t),this.getStruc(e).push(n)),n},this.getVisibleLigands=function(e){return this.hasStruc(e)?this.getStruc(e).filter(function(e){return e.isVisible()}):[]},this.getVisibleLigandIds=function(e){return this.getVisibleLigands(e).map(function(e){return e.getLigandId()})},this.redraw=function(e){highlightLigand(this.getVisibleLigandIds(e),plip_residues.getVisibleResiduesResId(e),e),pv_viewer.requestRedraw()},this.redrawAll=function(){for(var e in n)PLIP.AbstractViewer.isStructureEnabled(e)&&this.redraw(e)}},PLIP.Ligand=function(e,t){var i=0,a=[],n=[];this.show=function(e,t){null==e&&(e=!0),null==t&&(t=!1),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(i++,t&&a.forEach(function(e){e.show(!1)}),0<i)&&e&&all_ligands.redraw(this.strucId)},this.hide=function(e,t,n){null==e&&(e=!0),null==n&&(n=!1),null==t&&(t=!0),PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(t?i=Math.max(i-1,0):alert("Did not decrement counter! "+this.id+": "+i),n&&a.forEach(function(e){e.hide(!1)}),0==i)&&e&&all_ligands.redraw(this.strucId)},this.addResidue=function(e){-1==a.indexOf(e)&&a.push(e)},this.addBond=function(e){-1==n.indexOf(e)&&n.push(e)},this.isVisible=function(){return 0<i},this.getLigandId=function(){return this.id},this.getResidues=function(){return a},this.strucId=e,this.id=t,this.position=t},PLIP.AbstractViewerPV={newBondMesh:function(e){return pv_viewer.customMesh(e)},addWaterCircle:function(e,t,n,i,a){e.addSphere(t,n,{cap:!0,color:i})},addBondLine:function(e,t,n,i,a,s,r){for(var o=1;o<=i;o++)e.addTube(midpoint3d(t,n,(2*o-2)/(2*i-1)),midpoint3d(t,n,(2*o-1)/(2*i-1)),a,{cap:!0,color:s})},removeMesh:function(e){pv_viewer.rm(e)},fitView:function(e,i,t){var a,s;this.isStructureEnabled(e)&&(a=t.map(function(e){return void 0===e?null:e.chain}),s=t.map(function(e){return void 0===e?null:e.position}),a.length!=s.length&&console.error("queryResidue -Chains and -Positions array lengths don't match: "+a.length+" != "+s.length),t=pv_viewer.get(e).structure().residueSelect(function(e){var t=e.chain().name();if("_"===t){if(!i)return!1;if((ligand_positions=i.map(function(e){return e.position})).includes(e.num()))return!0}for(var n=0;n<a.length;n++)if(a[n]===t&&s[n]===e.num())return!0;return!1}),pv_viewer.fitTo(t),pv_viewer.requestRedraw())},isStructureEnabled:function(e){return!!pv_viewer.get(e)}},PLIP.AbstractViewerNGL={newBondMesh:function(e){return new NGL.Shape(e,{disableImpostor:!0})},addWaterCircle:function(e,t,n,i,a){e.addEllipsoid(t,i,n,[n,0,0],[0,n,0]),a&&ngl_stage.addComponentFromObject(e).addRepresentation("buffer")},addBondLine:function(t,n,i,a,s,r,e){for(let e=1;e<=a;e++)t.addCylinder(midpoint3d(n,i,(2*e-2)/(2*a-1)),midpoint3d(n,i,(2*e-1)/(2*a-1)),r,s);e&&ngl_stage.addComponentFromObject(t).addRepresentation("buffer")},removeMesh:function(e){removeNGLComponentByName(e)},fitView:function(e,t,n){if(this.isStructureEnabled(e)){var i="";if(t&&(i+="(("+(ligand_positions=t.map(function(e){return e.position})).join(" or ")+") and :_)"),void 0!==n[0]){var a,s={};for(a in n){var r,o=n[a];"-"!=(r=o.chain)&&(o=o.position,s[r]?s[r].push(o):s[r]=[o])}for(r in s)""!=i&&(i+=" or "),i+="(("+s[r].join(" or ")+") and :"+r+")"}getNGLComponentByName(e).autoView(i,1e3)}},isStructureEnabled:function(e){return!!getNGLComponentByName(e)}};var plip_interactions_fit_bonds=!0;function togglePlipInteractions(e,t,n){$("#togglePlipInteractions_"+e).hasClass("glyphicon-chevron-down")?($("#togglePlipInteractions_"+e).removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$("#plipInteractions_"+e).show(),PLIP.AbstractViewer.isStructureEnabled(t)&&(plip_interactions_fit_bonds=!1,$.when($("#plipInteractions_"+e+" input").each(function(e,t){$(t).prop("checked",!0).trigger("change")})).done(function(){fitToBonds(t,n)}),plip_interactions_fit_bonds=!0)):($("#togglePlipInteractions_"+e).addClass("glyphicon-chevron-down").removeClass("glyphicon-chevron-up"),$("#plipInteractions_"+e).hide(),$("#plipInteractions_"+e+" input").each(function(e,t){$(t).prop("checked",!1).trigger("change")}))}function changeLigandContacts4Checkbox(e,t,n,i){var i=$("#chainContacts4_"+i),a=i.prop("checked");PLIP.AbstractViewer.isStructureEnabled(e)?(plip_residues.getResiduesByResId(e,n).forEach(function(e){a?e.show(!1):e.hide(!1)}),n=all_ligands.getLigandById(e,t),a?n.show(!0,!1):n.hide(!0,null,!1),plip_residues.redraw(e)):i.prop("checked",!1)}function clickLigandContacts4Checkbox(e,t,n,i){PLIP.AbstractViewer.isStructureEnabled(e)&&($("#chainContacts4_"+i).each(function(e,t){$(t).prop("checked",!$(t).prop("checked")).trigger("change")}),$("#chainContacts4_"+i).prop("checked"))&&PLIP.AbstractViewer.fitView(e,[all_ligands.getLigandById(e,t)],plip_residues.getResiduesByResId(e,n))}function toggleResidueContacts(e,t,n){$("#toggleResidueContacts4_"+e).hasClass("glyphicon-chevron-down")?($("#toggleResidueContacts4_"+e).removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$("#residueContacts4_"+e).show(),PLIP.AbstractViewer.isStructureEnabled(n)&&($("#residueContacts4_"+e+" input").each(function(e,t){$(t).prop("checked",!0).trigger("change")}),ligand=all_ligands.getLigandById(n,t),PLIP.AbstractViewer.fitView(n,[ligand],ligand.getResidues()))):($("#toggleResidueContacts4_"+e).removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"),$("#residueContacts4_"+e).hide(),PLIP.AbstractViewer.isStructureEnabled(n)&&$("#residueContacts4_"+e+" input").each(function(e,t){$(t).prop("checked",!1).trigger("change")})),updatecols()}function toggleLigandGroup(e,t,n){$("#toggleLigandGroup_"+e).hasClass("glyphicon-chevron-down")?($("#toggleLigandGroup_"+e).addClass("glyphicon-chevron-up").removeClass("glyphicon-chevron-down"),$("#ligandGroup_"+e).show(),centerOnLigand(t,n)):($("#toggleLigandGroup_"+e).addClass("glyphicon-chevron-down").removeClass("glyphicon-chevron-up"),$("#ligandGroup_"+e+" .glyphicon-chevron-up").each(function(e,t){$(t).trigger("click")}),$("#ligandGroup_"+e).hide()),updatecols()}function toggleAllLigands(e){$("#toggleAllLink").hasClass("glyphicon-chevron-down")?($("#toggleAllLink,span[id^=toggleLigandGroup_]").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$("div[id^=ligandGroup_]").show()):($("#toggleAllLink,span[id^=toggleLigandGroup_]").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"),$("div[id^=ligandGroup_]").hide())}function RGBColor(e){this.ok=!1,e=(e=(e="#"==e.charAt(0)?e.substr(1,6):e).replace(/ /g,"")).toLowerCase();var t,c={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(t in c)e==t&&(e=c[t]);for(var h=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(e){return[parseInt(e[1]),parseInt(e[2]),parseInt(e[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}],n=0;n<h.length;n++){var i=h[n].re,a=h[n].process,i=i.exec(e);i&&(channels=a(i),this.r=channels[0],this.g=channels[1],this.b=channels[2],this.ok=!0)}this.r=this.r<0||isNaN(this.r)?0:255<this.r?255:this.r,this.g=this.g<0||isNaN(this.g)?0:255<this.g?255:this.g,this.b=this.b<0||isNaN(this.b)?0:255<this.b?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var e=this.r.toString(16),t=this.g.toString(16),n=this.b.toString(16);return"#"+(e=1==e.length?"0"+e:e)+(t=1==t.length?"0"+t:t)+(n=1==n.length?"0"+n:n)},this.getHelpXML=function(){for(var e,t=new Array,n=0;n<h.length;n++)for(var i=h[n].example,a=0;a<i.length;a++)t[t.length]=i[a];for(e in c)t[t.length]=e;var s=document.createElement("ul");s.setAttribute("id","rgbcolor-examples");for(n=0;n<t.length;n++)try{var r=document.createElement("li"),o=new RGBColor(t[n]),l=document.createElement("div"),u=(l.style.cssText="margin: 3px; border: 1px solid black; background:"+o.toHex()+"; color:"+o.toHex(),l.appendChild(document.createTextNode("test")),document.createTextNode(" "+t[n]+" -> "+o.toRGB()+" -> "+o.toHex()));r.appendChild(l),r.appendChild(u),s.appendChild(r)}catch(e){}return s}}!function(){this.canvg=function(e,t,n){if(null==e&&null==t&&null==n)for(var a=document.querySelectorAll("svg"),s=0;s<a.length;s++){var r=a[s],o=document.createElement("canvas"),l=(o.width=r.clientWidth,o.height=r.clientHeight,r.parentNode.insertBefore(o,r),r.parentNode.removeChild(r),document.createElement("div"));l.appendChild(r),canvg(o,l.innerHTML)}else{null!=(e="string"==typeof e?document.getElementById(e):e).svg&&e.svg.stop();n=function(e){var M={opts:e,FRAMERATE:30,MAX_VIRTUAL_PIXELS:3e4,log:function(e){}};1==M.opts.log&&"undefined"!=typeof console&&(M.log=function(e){console.log(e)});M.init=function(e){var t=0;M.UniqueId=function(){return"canvg"+ ++t},M.Definitions={},M.Styles={},M.StylesSpecificity={},M.Animations=[],M.Images=[],M.ctx=e,M.ViewPort=new function(){this.viewPorts=[],this.Clear=function(){this.viewPorts=[]},this.SetCurrent=function(e,t){this.viewPorts.push({width:e,height:t})},this.RemoveCurrent=function(){this.viewPorts.pop()},this.Current=function(){return this.viewPorts[this.viewPorts.length-1]},this.width=function(){return this.Current().width},this.height=function(){return this.Current().height},this.ComputeSize=function(e){return null!=e&&"number"==typeof e?e:"x"==e?this.width():"y"==e?this.height():Math.sqrt(Math.pow(this.width(),2)+Math.pow(this.height(),2))/Math.sqrt(2)}}},M.init(),M.ImagesLoaded=function(){for(var e=0;e<M.Images.length;e++)if(!M.Images[e].loaded)return!1;return!0},M.trim=function(e){return e.replace(/^\s+|\s+$/g,"")},M.compressSpaces=function(e){return e.replace(/[\s\r\t\n]+/gm," ")},M.ajax=function(e){var t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return t?(t.open("GET",e,!1),t.send(null),t.responseText):null},M.parseXml=function(e){var t,n;return"undefined"!=typeof Windows&&void 0!==Windows.Data&&void 0!==Windows.Data.Xml?(n=new Windows.Data.Xml.Dom.XmlDocument,(t=new Windows.Data.Xml.Dom.XmlLoadSettings).prohibitDtd=!1,n.loadXml(e,t),n):window.DOMParser?(new DOMParser).parseFromString(e,"text/xml"):(e=e.replace(/<!DOCTYPE svg[^>]*>/,""),(n=new ActiveXObject("Microsoft.XMLDOM")).async="false",n.loadXML(e),n)},M.Property=function(e,t){this.name=e,this.value=t},M.Property.prototype.getValue=function(){return this.value},M.Property.prototype.hasValue=function(){return null!=this.value&&""!==this.value},M.Property.prototype.numValue=function(){var e;return this.hasValue()?(e=parseFloat(this.value),(this.value+"").match(/%$/)&&(e/=100),e):0},M.Property.prototype.valueOrDefault=function(e){return this.hasValue()?this.value:e},M.Property.prototype.numValueOrDefault=function(e){return this.hasValue()?this.numValue():e},M.Property.prototype.addOpacity=function(e){var t,n=this.value;return null!=e.value&&""!=e.value&&"string"==typeof this.value&&(t=new RGBColor(this.value)).ok&&(n="rgba("+t.r+", "+t.g+", "+t.b+", "+e.numValue()+")"),new M.Property(this.name,n)},M.Property.prototype.getDefinition=function(){var e=this.value.match(/#([^\)'"]+)/);return e=(e=e&&e[1])||this.value,M.Definitions[e]},M.Property.prototype.isUrlDefinition=function(){return 0==this.value.indexOf("url(")},M.Property.prototype.getFillStyleDefinition=function(e,t){var n=this.getDefinition();return null!=n&&n.createGradient?n.createGradient(M.ctx,e,t):null!=n&&n.createPattern?(n.getHrefAttribute().hasValue()&&(t=n.attribute("patternTransform"),n=n.getHrefAttribute().getDefinition(),t.hasValue())&&(n.attribute("patternTransform",!0).value=t.value),n.createPattern(M.ctx,e)):null},M.Property.prototype.getDPI=function(e){return 96},M.Property.prototype.getEM=function(e){var t=12,n=new M.Property("fontSize",M.Font.Parse(M.ctx.font).fontSize);return t=n.hasValue()?n.toPixels(e):t},M.Property.prototype.getUnits=function(){return(this.value+"").replace(/[0-9\.\-]/g,"")},M.Property.prototype.toPixels=function(e,t){var n;return this.hasValue()?(n=this.value+"").match(/em$/)?this.numValue()*this.getEM(e):n.match(/ex$/)?this.numValue()*this.getEM(e)/2:n.match(/px$/)?this.numValue():n.match(/pt$/)?this.numValue()*this.getDPI(e)*(1/72):n.match(/pc$/)?15*this.numValue():n.match(/cm$/)?this.numValue()*this.getDPI(e)/2.54:n.match(/mm$/)?this.numValue()*this.getDPI(e)/25.4:n.match(/in$/)?this.numValue()*this.getDPI(e):n.match(/%$/)?this.numValue()*M.ViewPort.ComputeSize(e):(n=this.numValue(),t&&n<1?n*M.ViewPort.ComputeSize(e):n):0},M.Property.prototype.toMilliseconds=function(){var e;return this.hasValue()?(e=this.value+"").match(/s$/)?1e3*this.numValue():(e.match(/ms$/),this.numValue()):0},M.Property.prototype.toRadians=function(){var e;return this.hasValue()?(e=this.value+"").match(/deg$/)?this.numValue()*(Math.PI/180):e.match(/grad$/)?this.numValue()*(Math.PI/200):e.match(/rad$/)?this.numValue():this.numValue()*(Math.PI/180):0};var t={baseline:"alphabetic","before-edge":"top","text-before-edge":"top",middle:"middle",central:"middle","after-edge":"bottom","text-after-edge":"bottom",ideographic:"ideographic",alphabetic:"alphabetic",hanging:"hanging",mathematical:"alphabetic"};return M.Property.prototype.toTextBaseline=function(){return this.hasValue()?t[this.value]:null},M.Font=new function(){this.Styles="normal|italic|oblique|inherit",this.Variants="normal|small-caps|inherit",this.Weights="normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900|inherit",this.CreateFont=function(e,t,n,i,a,s){s=null!=s?this.Parse(s):this.CreateFont("","","","","",M.ctx.font);return{fontFamily:a||s.fontFamily,fontSize:i||s.fontSize,fontStyle:e||s.fontStyle,fontWeight:n||s.fontWeight,fontVariant:t||s.fontVariant,toString:function(){return[this.fontStyle,this.fontVariant,this.fontWeight,this.fontSize,this.fontFamily].join(" ")}}};var r=this;this.Parse=function(e){for(var t={},n=M.trim(M.compressSpaces(e||"")).split(" "),i={fontSize:!1,fontStyle:!1,fontWeight:!1,fontVariant:!1},a="",s=0;s<n.length;s++)i.fontStyle||-1==r.Styles.indexOf(n[s])?i.fontVariant||-1==r.Variants.indexOf(n[s])?i.fontWeight||-1==r.Weights.indexOf(n[s])?i.fontSize?"inherit"!=n[s]&&(a+=n[s]):("inherit"!=n[s]&&(t.fontSize=n[s].split("/")[0]),i.fontStyle=i.fontVariant=i.fontWeight=i.fontSize=!0):("inherit"!=n[s]&&(t.fontWeight=n[s]),i.fontStyle=i.fontVariant=i.fontWeight=!0):("inherit"!=n[s]&&(t.fontVariant=n[s]),i.fontStyle=i.fontVariant=!0):("inherit"!=n[s]&&(t.fontStyle=n[s]),i.fontStyle=!0);return""!=a&&(t.fontFamily=a),t}},M.ToNumberArray=function(e){for(var t=M.trim(M.compressSpaces((e||"").replace(/,/g," "))).split(" "),n=0;n<t.length;n++)t[n]=parseFloat(t[n]);return t},M.Point=function(e,t){this.x=e,this.y=t},M.Point.prototype.angleTo=function(e){return Math.atan2(e.y-this.y,e.x-this.x)},M.Point.prototype.applyTransform=function(e){var t=this.x*e[0]+this.y*e[2]+e[4],e=this.x*e[1]+this.y*e[3]+e[5];this.x=t,this.y=e},M.CreatePoint=function(e){e=M.ToNumberArray(e);return new M.Point(e[0],e[1])},M.CreatePath=function(e){for(var t=M.ToNumberArray(e),n=[],i=0;i<t.length;i+=2)n.push(new M.Point(t[i],t[i+1]));return n},M.BoundingBox=function(e,t,n,a){this.x1=Number.NaN,this.y1=Number.NaN,this.x2=Number.NaN,this.y2=Number.NaN,this.x=function(){return this.x1},this.y=function(){return this.y1},this.width=function(){return this.x2-this.x1},this.height=function(){return this.y2-this.y1},this.addPoint=function(e,t){null!=e&&((isNaN(this.x1)||isNaN(this.x2))&&(this.x1=e,this.x2=e),e<this.x1&&(this.x1=e),e>this.x2)&&(this.x2=e),null!=t&&((isNaN(this.y1)||isNaN(this.y2))&&(this.y1=t,this.y2=t),t<this.y1&&(this.y1=t),t>this.y2)&&(this.y2=t)},this.addX=function(e){this.addPoint(e,null)},this.addY=function(e){this.addPoint(null,e)},this.addBoundingBox=function(e){this.addPoint(e.x1,e.y1),this.addPoint(e.x2,e.y2)},this.addQuadraticCurve=function(e,t,n,i,a,s){n=e+2/3*(n-e),i=t+2/3*(i-t);this.addBezierCurve(e,t,n,n+1/3*(a-e),i,i+1/3*(s-t),a,s)},this.addBezierCurve=function(e,t,n,a,s,r,o,l){var u=[e,t],c=[n,a],h=[s,r],d=[o,l];for(this.addPoint(u[0],u[1]),this.addPoint(d[0],d[1]),i=0;i<=1;i++){function p(e){return Math.pow(1-e,3)*u[i]+3*Math.pow(1-e,2)*e*c[i]+3*(1-e)*Math.pow(e,2)*h[i]+Math.pow(e,3)*d[i]}var g,f=6*u[i]-12*c[i]+6*h[i],m=-3*u[i]+9*c[i]-9*h[i]+3*d[i],v=3*c[i]-3*u[i];0==m?0!=f&&(0<(g=-v/f)&&g<1&&(0==i&&this.addX(p(g)),1==i))&&this.addY(p(g)):(g=Math.pow(f,2)-4*v*m)<0||(0<(v=(-f+Math.sqrt(g))/(2*m))&&v<1&&(0==i&&this.addX(p(v)),1==i)&&this.addY(p(v)),0<(v=(-f-Math.sqrt(g))/(2*m))&&v<1&&(0==i&&this.addX(p(v)),1==i)&&this.addY(p(v)))}},this.isPointInBox=function(e,t){return this.x1<=e&&e<=this.x2&&this.y1<=t&&t<=this.y2},this.addPoint(e,t),this.addPoint(n,a)},M.Transform=function(e){for(var t=this,n=(this.Type={},this.Type.translate=function(e){this.p=M.CreatePoint(e),this.apply=function(e){e.translate(this.p.x||0,this.p.y||0)},this.unapply=function(e){e.translate(-1*this.p.x||0,-1*this.p.y||0)},this.applyToPoint=function(e){e.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0])}},this.Type.rotate=function(e){e=M.ToNumberArray(e);this.angle=new M.Property("angle",e[0]),this.cx=e[1]||0,this.cy=e[2]||0,this.apply=function(e){e.translate(this.cx,this.cy),e.rotate(this.angle.toRadians()),e.translate(-this.cx,-this.cy)},this.unapply=function(e){e.translate(this.cx,this.cy),e.rotate(-1*this.angle.toRadians()),e.translate(-this.cx,-this.cy)},this.applyToPoint=function(e){var t=this.angle.toRadians();e.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0]),e.applyTransform([Math.cos(t),Math.sin(t),-Math.sin(t),Math.cos(t),0,0]),e.applyTransform([1,0,0,1,-this.p.x||0,-this.p.y||0])}},this.Type.scale=function(e){this.p=M.CreatePoint(e),this.apply=function(e){e.scale(this.p.x||1,this.p.y||this.p.x||1)},this.unapply=function(e){e.scale(1/this.p.x||1,1/this.p.y||this.p.x||1)},this.applyToPoint=function(e){e.applyTransform([this.p.x||0,0,0,this.p.y||0,0,0])}},this.Type.matrix=function(e){this.m=M.ToNumberArray(e),this.apply=function(e){e.transform(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5])},this.unapply=function(e){var t=this.m[0],n=this.m[2],i=this.m[4],a=this.m[1],s=this.m[3],r=this.m[5],o=1/(t*(+s-0*r)-n*(+a-0*r)+i*(0*a-0*s));e.transform(o*(+s-0*r),o*(0*r-+a),o*(0*i-+n),o*(+t-0*i),o*(n*r-i*s),o*(i*a-t*r))},this.applyToPoint=function(e){e.applyTransform(this.m)}},this.Type.SkewBase=function(e){this.base=t.Type.matrix,this.base(e),this.angle=new M.Property("angle",e)},this.Type.SkewBase.prototype=new this.Type.matrix,this.Type.skewX=function(e){this.base=t.Type.SkewBase,this.base(e),this.m=[1,0,Math.tan(this.angle.toRadians()),1,0,0]},this.Type.skewX.prototype=new this.Type.SkewBase,this.Type.skewY=function(e){this.base=t.Type.SkewBase,this.base(e),this.m=[1,Math.tan(this.angle.toRadians()),0,1,0,0]},this.Type.skewY.prototype=new this.Type.SkewBase,this.transforms=[],this.apply=function(e){for(var t=0;t<this.transforms.length;t++)this.transforms[t].apply(e)},this.unapply=function(e){for(var t=this.transforms.length-1;0<=t;t--)this.transforms[t].unapply(e)},this.applyToPoint=function(e){for(var t=0;t<this.transforms.length;t++)this.transforms[t].applyToPoint(e)},M.trim(M.compressSpaces(e)).replace(/\)([a-zA-Z])/g,") $1").replace(/\)(\s?,\s?)/g,") ").split(/\s(?=[a-z])/)),i=0;i<n.length;i++){var a=M.trim(n[i].split("(")[0]),s=n[i].split("(")[1].replace(")",""),s=new this.Type[a](s);s.type=a,this.transforms.push(s)}},M.AspectRatio=function(e,t,n,i,a,s,r,o,l,u){var c=(t=(t=M.compressSpaces(t)).replace(/^defer\s/,"")).split(" ")[0]||"xMidYMid",t=t.split(" ")[1]||"meet",h=n/i,d=a/s,p=Math.min(h,d),g=Math.max(h,d);"meet"==t&&(i*=p,s*=p),"slice"==t&&(i*=g,s*=g),l=new M.Property("refX",l),u=new M.Property("refY",u),l.hasValue()&&u.hasValue()?e.translate(-p*l.toPixels("x"),-p*u.toPixels("y")):(c.match(/^xMid/)&&("meet"==t&&p==d||"slice"==t&&g==d)&&e.translate(n/2-i/2,0),c.match(/YMid$/)&&("meet"==t&&p==h||"slice"==t&&g==h)&&e.translate(0,a/2-s/2),c.match(/^xMax/)&&("meet"==t&&p==d||"slice"==t&&g==d)&&e.translate(n-i,0),c.match(/YMax$/)&&("meet"==t&&p==h||"slice"==t&&g==h)&&e.translate(0,a-s)),"none"==c?e.scale(h,d):"meet"==t?e.scale(p,p):"slice"==t&&e.scale(g,g),e.translate(null==r?0:-r,null==o?0:-o)},M.Element={},M.EmptyProperty=new M.Property("EMPTY",""),M.Element.ElementBase=function(s){if(this.attributes={},this.styles={},this.stylesSpecificity={},this.children=[],this.attribute=function(e,t){var n=this.attributes[e];return null!=n?n:(1==t&&(n=new M.Property(e,""),this.attributes[e]=n),n||M.EmptyProperty)},this.getHrefAttribute=function(){for(var e in this.attributes)if("href"==e||e.match(/:href$/))return this.attributes[e];return M.EmptyProperty},this.style=function(e,t,n){var i=this.styles[e];if(null!=i)return i;var a=this.attribute(e);if(null!=a&&a.hasValue())return this.styles[e]=a;if(1!=n){a=this.parent;if(null!=a){n=a.style(e);if(null!=n&&n.hasValue())return n}}return 1==t&&(i=new M.Property(e,""),this.styles[e]=i),i||M.EmptyProperty},this.render=function(e){var t;"none"!=this.style("display").value&&"hidden"!=this.style("visibility").value&&(e.save(),this.attribute("mask").hasValue()?null!=(t=this.attribute("mask").getDefinition())&&t.apply(e,this):this.style("filter").hasValue()?null!=(t=this.style("filter").getDefinition())&&t.apply(e,this):(this.setContext(e),this.renderChildren(e),this.clearContext(e)),e.restore())},this.setContext=function(e){},this.clearContext=function(e){},this.renderChildren=function(e){for(var t=0;t<this.children.length;t++)this.children[t].render(e)},this.addChild=function(e,t){var n=e;(n=t?M.CreateElement(e):n).parent=this,"title"!=n.type&&this.children.push(n)},this.addStylesFromStyleDefinition=function(){for(var e in M.Styles)if("@"!=e[0]&&u(s,e)){var t=M.Styles[e],n=M.StylesSpecificity[e];if(null!=t)for(var i in t){var a=this.stylesSpecificity[i];(a=void 0===a?"000":a)<n&&(this.styles[i]=t[i],this.stylesSpecificity[i]=n)}}},null!=s&&1==s.nodeType){for(var e=0;e<s.attributes.length;e++){var t=s.attributes[e];this.attributes[t.nodeName]=new M.Property(t.nodeName,t.value)}if(this.addStylesFromStyleDefinition(),this.attribute("style").hasValue())for(var n,i,a=this.attribute("style").value.split(";"),e=0;e<a.length;e++)""!=M.trim(a[e])&&(i=a[e].split(":"),n=M.trim(i[0]),i=M.trim(i[1]),this.styles[n]=new M.Property(n,i));this.attribute("id").hasValue()&&null==M.Definitions[this.attribute("id").value]&&(M.Definitions[this.attribute("id").value]=this);for(e=0;e<s.childNodes.length;e++){var r,o=s.childNodes[e];1==o.nodeType&&this.addChild(o,!0),!this.captureTextNodes||3!=o.nodeType&&4!=o.nodeType||(r=o.value||o.text||o.textContent||"",""!=M.compressSpaces(r)&&this.addChild(new M.Element.tspan(o),!1))}}},M.Element.RenderedElementBase=function(e){this.base=M.Element.ElementBase,this.base(e),this.setContext=function(e){var t,n,i;this.style("fill").isUrlDefinition()?null!=(t=this.style("fill").getFillStyleDefinition(this,this.style("fill-opacity")))&&(e.fillStyle=t):this.style("fill").hasValue()&&("currentColor"==(i=this.style("fill")).value&&(i.value=this.style("color").value),"inherit"!=i.value)&&(e.fillStyle="none"==i.value?"rgba(0,0,0,0)":i.value),this.style("fill-opacity").hasValue()&&(i=(i=new M.Property("fill",e.fillStyle)).addOpacity(this.style("fill-opacity")),e.fillStyle=i.value),this.style("stroke").isUrlDefinition()?null!=(t=this.style("stroke").getFillStyleDefinition(this,this.style("stroke-opacity")))&&(e.strokeStyle=t):this.style("stroke").hasValue()&&("currentColor"==(n=this.style("stroke")).value&&(n.value=this.style("color").value),"inherit"!=n.value)&&(e.strokeStyle="none"==n.value?"rgba(0,0,0,0)":n.value),this.style("stroke-opacity").hasValue()&&(n=(n=new M.Property("stroke",e.strokeStyle)).addOpacity(this.style("stroke-opacity")),e.strokeStyle=n.value),this.style("stroke-width").hasValue()&&(i=this.style("stroke-width").toPixels(),e.lineWidth=0==i?.001:i),this.style("stroke-linecap").hasValue()&&(e.lineCap=this.style("stroke-linecap").value),this.style("stroke-linejoin").hasValue()&&(e.lineJoin=this.style("stroke-linejoin").value),this.style("stroke-miterlimit").hasValue()&&(e.miterLimit=this.style("stroke-miterlimit").value),this.style("stroke-dasharray").hasValue()&&"none"!=this.style("stroke-dasharray").value&&(t=M.ToNumberArray(this.style("stroke-dasharray").value),void 0!==e.setLineDash?e.setLineDash(t):void 0!==e.webkitLineDash?e.webkitLineDash=t:void 0===e.mozDash||1==t.length&&0==t[0]||(e.mozDash=t),n=this.style("stroke-dashoffset").numValueOrDefault(1),void 0!==e.lineDashOffset?e.lineDashOffset=n:void 0!==e.webkitLineDashOffset?e.webkitLineDashOffset=n:void 0!==e.mozDashOffset&&(e.mozDashOffset=n)),void 0!==e.font&&(e.font=M.Font.CreateFont(this.style("font-style").value,this.style("font-variant").value,this.style("font-weight").value,this.style("font-size").hasValue()?this.style("font-size").toPixels()+"px":"",this.style("font-family").value).toString()),this.style("transform",!1,!0).hasValue()&&new M.Transform(this.style("transform",!1,!0).value).apply(e),this.attribute("clip-path",!1,!0).hasValue()&&null!=(i=this.attribute("clip-path",!1,!0).getDefinition())&&i.apply(e),this.style("opacity").hasValue()&&(e.globalAlpha=this.style("opacity").numValue())}},M.Element.RenderedElementBase.prototype=new M.Element.ElementBase,M.Element.PathElementBase=function(e){this.base=M.Element.RenderedElementBase,this.base(e),this.path=function(e){return null!=e&&e.beginPath(),new M.BoundingBox},this.renderChildren=function(e){this.path(e),M.Mouse.checkPath(this,e),""!=e.fillStyle&&("inherit"!=this.style("fill-rule").valueOrDefault("inherit")?e.fill(this.style("fill-rule").value):e.fill()),""!=e.strokeStyle&&e.stroke();var t=this.getMarkers();if(null!=t){if(this.style("marker-start").isUrlDefinition()&&(n=this.style("marker-start").getDefinition()).render(e,t[0][0],t[0][1]),this.style("marker-mid").isUrlDefinition())for(var n=this.style("marker-mid").getDefinition(),i=1;i<t.length-1;i++)n.render(e,t[i][0],t[i][1]);this.style("marker-end").isUrlDefinition()&&(n=this.style("marker-end").getDefinition()).render(e,t[t.length-1][0],t[t.length-1][1])}},this.getBoundingBox=function(){return this.path()},this.getMarkers=function(){return null}},M.Element.PathElementBase.prototype=new M.Element.RenderedElementBase,M.Element.svg=function(e){this.base=M.Element.RenderedElementBase,this.base(e),this.baseClearContext=this.clearContext,this.clearContext=function(e){this.baseClearContext(e),M.ViewPort.RemoveCurrent()},this.baseSetContext=this.setContext,this.setContext=function(e){e.strokeStyle="rgba(0,0,0,0)",e.lineCap="butt",e.lineJoin="miter",e.miterLimit=4,void 0!==e.font&&void 0!==window.getComputedStyle&&(e.font=window.getComputedStyle(e.canvas).getPropertyValue("font")),this.baseSetContext(e),this.attribute("x").hasValue()||(this.attribute("x",!0).value=0),this.attribute("y").hasValue()||(this.attribute("y",!0).value=0),e.translate(this.attribute("x").toPixels("x"),this.attribute("y").toPixels("y"));var t,n,i,a=M.ViewPort.width(),s=M.ViewPort.height();this.attribute("width").hasValue()||(this.attribute("width",!0).value="100%"),this.attribute("height").hasValue()||(this.attribute("height",!0).value="100%"),void 0===this.root&&(a=this.attribute("width").toPixels("x"),s=this.attribute("height").toPixels("y"),t=n=0,this.attribute("refX").hasValue()&&this.attribute("refY").hasValue()&&(n=-this.attribute("refX").toPixels("x"),t=-this.attribute("refY").toPixels("y")),"visible"!=this.attribute("overflow").valueOrDefault("hidden"))&&(e.beginPath(),e.moveTo(n,t),e.lineTo(a,t),e.lineTo(a,s),e.lineTo(n,s),e.closePath(),e.clip()),M.ViewPort.SetCurrent(a,s),this.attribute("viewBox").hasValue()&&(n=(t=M.ToNumberArray(this.attribute("viewBox").value))[0],i=t[1],a=t[2],s=t[3],M.AspectRatio(e,this.attribute("preserveAspectRatio").value,M.ViewPort.width(),a,M.ViewPort.height(),s,n,i,this.attribute("refX").value,this.attribute("refY").value),M.ViewPort.RemoveCurrent(),M.ViewPort.SetCurrent(t[2],t[3]))}},M.Element.svg.prototype=new M.Element.RenderedElementBase,M.Element.rect=function(e){this.base=M.Element.PathElementBase,this.base(e),this.path=function(e){var t=this.attribute("x").toPixels("x"),n=this.attribute("y").toPixels("y"),i=this.attribute("width").toPixels("x"),a=this.attribute("height").toPixels("y"),s=this.attribute("rx").toPixels("x"),r=this.attribute("ry").toPixels("y");return this.attribute("rx").hasValue()&&!this.attribute("ry").hasValue()&&(r=s),this.attribute("ry").hasValue()&&!this.attribute("rx").hasValue()&&(s=r),s=Math.min(s,i/2),r=Math.min(r,a/2),null!=e&&(e.beginPath(),e.moveTo(t+s,n),e.lineTo(t+i-s,n),e.quadraticCurveTo(t+i,n,t+i,n+r),e.lineTo(t+i,n+a-r),e.quadraticCurveTo(t+i,n+a,t+i-s,n+a),e.lineTo(t+s,n+a),e.quadraticCurveTo(t,n+a,t,n+a-r),e.lineTo(t,n+r),e.quadraticCurveTo(t,n,t+s,n),e.closePath()),new M.BoundingBox(t,n,t+i,n+a)}},M.Element.rect.prototype=new M.Element.PathElementBase,M.Element.circle=function(e){this.base=M.Element.PathElementBase,this.base(e),this.path=function(e){var t=this.attribute("cx").toPixels("x"),n=this.attribute("cy").toPixels("y"),i=this.attribute("r").toPixels();return null!=e&&(e.beginPath(),e.arc(t,n,i,0,2*Math.PI,!0),e.closePath()),new M.BoundingBox(t-i,n-i,t+i,n+i)}},M.Element.circle.prototype=new M.Element.PathElementBase,M.Element.ellipse=function(e){this.base=M.Element.PathElementBase,this.base(e),this.path=function(e){var t=(Math.sqrt(2)-1)/3*4,n=this.attribute("rx").toPixels("x"),i=this.attribute("ry").toPixels("y"),a=this.attribute("cx").toPixels("x"),s=this.attribute("cy").toPixels("y");return null!=e&&(e.beginPath(),e.moveTo(a,s-i),e.bezierCurveTo(a+t*n,s-i,a+n,s-t*i,a+n,s),e.bezierCurveTo(a+n,s+t*i,a+t*n,s+i,a,s+i),e.bezierCurveTo(a-t*n,s+i,a-n,s+t*i,a-n,s),e.bezierCurveTo(a-n,s-t*i,a-t*n,s-i,a,s-i),e.closePath()),new M.BoundingBox(a-n,s-i,a+n,s+i)}},M.Element.ellipse.prototype=new M.Element.PathElementBase,M.Element.line=function(e){this.base=M.Element.PathElementBase,this.base(e),this.getPoints=function(){return[new M.Point(this.attribute("x1").toPixels("x"),this.attribute("y1").toPixels("y")),new M.Point(this.attribute("x2").toPixels("x"),this.attribute("y2").toPixels("y"))]},this.path=function(e){var t=this.getPoints();return null!=e&&(e.beginPath(),e.moveTo(t[0].x,t[0].y),e.lineTo(t[1].x,t[1].y)),new M.BoundingBox(t[0].x,t[0].y,t[1].x,t[1].y)},this.getMarkers=function(){var e=this.getPoints(),t=e[0].angleTo(e[1]);return[[e[0],t],[e[1],t]]}},M.Element.line.prototype=new M.Element.PathElementBase,M.Element.polyline=function(e){this.base=M.Element.PathElementBase,this.base(e),this.points=M.CreatePath(this.attribute("points").value),this.path=function(e){var t=new M.BoundingBox(this.points[0].x,this.points[0].y);null!=e&&(e.beginPath(),e.moveTo(this.points[0].x,this.points[0].y));for(var n=1;n<this.points.length;n++)t.addPoint(this.points[n].x,this.points[n].y),null!=e&&e.lineTo(this.points[n].x,this.points[n].y);return t},this.getMarkers=function(){for(var e=[],t=0;t<this.points.length-1;t++)e.push([this.points[t],this.points[t].angleTo(this.points[t+1])]);return e.push([this.points[this.points.length-1],e[e.length-1][1]]),e}},M.Element.polyline.prototype=new M.Element.PathElementBase,M.Element.polygon=function(e){this.base=M.Element.polyline,this.base(e),this.basePath=this.path,this.path=function(e){var t=this.basePath(e);return null!=e&&(e.lineTo(this.points[0].x,this.points[0].y),e.closePath()),t}},M.Element.polygon.prototype=new M.Element.polyline,M.Element.path=function(e){this.base=M.Element.PathElementBase,this.base(e);for(var t=(t=this.attribute("d").value).replace(/,/gm," "),n=0;n<2;n++)t=t.replace(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm,"$1 $2");t=(t=t.replace(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2")).replace(/([0-9])([+\-])/gm,"$1 $2");for(n=0;n<2;n++)t=t.replace(/(\.[0-9]*)(\.)/gm,"$1 $2");t=t.replace(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm,"$1 $3 $4 "),t=M.compressSpaces(t),t=M.trim(t),this.PathParser=new function(e){this.tokens=e.split(" "),this.reset=function(){this.i=-1,this.command="",this.previousCommand="",this.start=new M.Point(0,0),this.control=new M.Point(0,0),this.current=new M.Point(0,0),this.points=[],this.angles=[]},this.isEnd=function(){return this.i>=this.tokens.length-1},this.isCommandOrEnd=function(){return!!this.isEnd()||null!=this.tokens[this.i+1].match(/^[A-Za-z]$/)},this.isRelativeCommand=function(){switch(this.command){case"m":case"l":case"h":case"v":case"c":case"s":case"q":case"t":case"a":case"z":return!0}return!1},this.getToken=function(){return this.i++,this.tokens[this.i]},this.getScalar=function(){return parseFloat(this.getToken())},this.nextCommand=function(){this.previousCommand=this.command,this.command=this.getToken()},this.getPoint=function(){var e=new M.Point(this.getScalar(),this.getScalar());return this.makeAbsolute(e)},this.getAsControlPoint=function(){var e=this.getPoint();return this.control=e},this.getAsCurrentPoint=function(){var e=this.getPoint();return this.current=e},this.getReflectedControlPoint=function(){return"c"!=this.previousCommand.toLowerCase()&&"s"!=this.previousCommand.toLowerCase()&&"q"!=this.previousCommand.toLowerCase()&&"t"!=this.previousCommand.toLowerCase()?this.current:new M.Point(2*this.current.x-this.control.x,2*this.current.y-this.control.y)},this.makeAbsolute=function(e){return this.isRelativeCommand()&&(e.x+=this.current.x,e.y+=this.current.y),e},this.addMarker=function(e,t,n){null!=n&&0<this.angles.length&&null==this.angles[this.angles.length-1]&&(this.angles[this.angles.length-1]=this.points[this.points.length-1].angleTo(n)),this.addMarkerAngle(e,null==t?null:t.angleTo(e))},this.addMarkerAngle=function(e,t){this.points.push(e),this.angles.push(t)},this.getMarkerPoints=function(){return this.points},this.getMarkerAngles=function(){for(var e=0;e<this.angles.length;e++)if(null==this.angles[e])for(var t=e+1;t<this.angles.length;t++)if(null!=this.angles[t]){this.angles[e]=this.angles[t];break}return this.angles}}(t),this.path=function(e){var t=this.PathParser,n=(t.reset(),new M.BoundingBox);for(null!=e&&e.beginPath();!t.isEnd();)switch(t.nextCommand(),t.command){case"M":case"m":var i=t.getAsCurrentPoint();for(t.addMarker(i),n.addPoint(i.x,i.y),null!=e&&e.moveTo(i.x,i.y),t.start=t.current;!t.isCommandOrEnd();){i=t.getAsCurrentPoint();t.addMarker(i,t.start),n.addPoint(i.x,i.y),null!=e&&e.lineTo(i.x,i.y)}break;case"L":case"l":for(;!t.isCommandOrEnd();){var a=t.current,i=t.getAsCurrentPoint();t.addMarker(i,a),n.addPoint(i.x,i.y),null!=e&&e.lineTo(i.x,i.y)}break;case"H":case"h":for(;!t.isCommandOrEnd();){var s=new M.Point((t.isRelativeCommand()?t.current.x:0)+t.getScalar(),t.current.y);t.addMarker(s,t.current),t.current=s,n.addPoint(t.current.x,t.current.y),null!=e&&e.lineTo(t.current.x,t.current.y)}break;case"V":case"v":for(;!t.isCommandOrEnd();){s=new M.Point(t.current.x,(t.isRelativeCommand()?t.current.y:0)+t.getScalar());t.addMarker(s,t.current),t.current=s,n.addPoint(t.current.x,t.current.y),null!=e&&e.lineTo(t.current.x,t.current.y)}break;case"C":case"c":for(;!t.isCommandOrEnd();){var r=t.current,o=t.getPoint(),l=t.getAsControlPoint(),u=t.getAsCurrentPoint();t.addMarker(u,l,o),n.addBezierCurve(r.x,r.y,o.x,o.y,l.x,l.y,u.x,u.y),null!=e&&e.bezierCurveTo(o.x,o.y,l.x,l.y,u.x,u.y)}break;case"S":case"s":for(;!t.isCommandOrEnd();){r=t.current,o=t.getReflectedControlPoint(),l=t.getAsControlPoint(),u=t.getAsCurrentPoint();t.addMarker(u,l,o),n.addBezierCurve(r.x,r.y,o.x,o.y,l.x,l.y,u.x,u.y),null!=e&&e.bezierCurveTo(o.x,o.y,l.x,l.y,u.x,u.y)}break;case"Q":case"q":for(;!t.isCommandOrEnd();){r=t.current,l=t.getAsControlPoint(),u=t.getAsCurrentPoint();t.addMarker(u,l,l),n.addQuadraticCurve(r.x,r.y,l.x,l.y,u.x,u.y),null!=e&&e.quadraticCurveTo(l.x,l.y,u.x,u.y)}break;case"T":case"t":for(;!t.isCommandOrEnd();){r=t.current,l=t.getReflectedControlPoint(),u=(t.control=l,t.getAsCurrentPoint());t.addMarker(u,l,l),n.addQuadraticCurve(r.x,r.y,l.x,l.y,u.x,u.y),null!=e&&e.quadraticCurveTo(l.x,l.y,u.x,u.y)}break;case"A":case"a":for(;!t.isCommandOrEnd();){function c(e,t){return(e[0]*t[1]<e[1]*t[0]?-1:1)*Math.acos(y(e,t))}var r=t.current,h=t.getScalar(),d=t.getScalar(),p=t.getScalar()*(Math.PI/180),g=t.getScalar(),f=t.getScalar(),u=t.getAsCurrentPoint(),m=new M.Point(Math.cos(p)*(r.x-u.x)/2+Math.sin(p)*(r.y-u.y)/2,-Math.sin(p)*(r.x-u.x)/2+Math.cos(p)*(r.y-u.y)/2),v=Math.pow(m.x,2)/Math.pow(h,2)+Math.pow(m.y,2)/Math.pow(d,2),v=(1<v&&(h*=Math.sqrt(v),d*=Math.sqrt(v)),(g==f?-1:1)*Math.sqrt((Math.pow(h,2)*Math.pow(d,2)-Math.pow(h,2)*Math.pow(m.y,2)-Math.pow(d,2)*Math.pow(m.x,2))/(Math.pow(h,2)*Math.pow(m.y,2)+Math.pow(d,2)*Math.pow(m.x,2)))),g=(isNaN(v)&&(v=0),new M.Point(v*h*m.y/d,v*-d*m.x/h)),v=new M.Point((r.x+u.x)/2+Math.cos(p)*g.x-Math.sin(p)*g.y,(r.y+u.y)/2+Math.sin(p)*g.x+Math.cos(p)*g.y),b=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2))},y=function(e,t){return(e[0]*t[0]+e[1]*t[1])/(b(e)*b(t))},_=c([1,0],[(m.x-g.x)/h,(m.y-g.y)/d]),w=[(m.x-g.x)/h,(m.y-g.y)/d],m=[(-m.x-g.x)/h,(-m.y-g.y)/d],g=c(w,m),x=(y(w,m)<=-1&&(g=Math.PI),1-f?1:-1),w=_+(g=1<=y(w,m)?0:g)/2*x,m=new M.Point(v.x+h*Math.cos(w),v.y+d*Math.sin(w));t.addMarkerAngle(m,w-x*Math.PI/2),t.addMarkerAngle(u,w-x*Math.PI),n.addPoint(u.x,u.y),null!=e&&(y=d<h?h:d,m=d<h?1:h/d,w=d<h?d/h:1,e.translate(v.x,v.y),e.rotate(p),e.scale(m,w),e.arc(0,0,y,_,_+g,1-f),e.scale(1/m,1/w),e.rotate(-p),e.translate(-v.x,-v.y))}break;case"Z":case"z":null!=e&&e.closePath(),t.current=t.start}return n},this.getMarkers=function(){for(var e=this.PathParser.getMarkerPoints(),t=this.PathParser.getMarkerAngles(),n=[],i=0;i<e.length;i++)n.push([e[i],t[i]]);return n}},M.Element.path.prototype=new M.Element.PathElementBase,M.Element.pattern=function(e){this.base=M.Element.ElementBase,this.base(e),this.createPattern=function(e,t){var n=this.attribute("width").toPixels("x",!0),i=this.attribute("height").toPixels("y",!0),a=new M.Element.svg,s=(a.attributes.viewBox=new M.Property("viewBox",this.attribute("viewBox").value),a.attributes.width=new M.Property("width",n+"px"),a.attributes.height=new M.Property("height",i+"px"),a.attributes.transform=new M.Property("transform",this.attribute("patternTransform").value),a.children=this.children,document.createElement("canvas")),r=(s.width=n,s.height=i,s.getContext("2d"));this.attribute("x").hasValue()&&this.attribute("y").hasValue()&&r.translate(this.attribute("x").toPixels("x",!0),this.attribute("y").toPixels("y",!0));for(var o=-1;o<=1;o++)for(var l=-1;l<=1;l++)r.save(),a.attributes.x=new M.Property("x",o*s.width),a.attributes.y=new M.Property("y",l*s.height),a.render(r),r.restore();return e.createPattern(s,"repeat")}},M.Element.pattern.prototype=new M.Element.ElementBase,M.Element.marker=function(e){this.base=M.Element.ElementBase,this.base(e),this.baseRender=this.render,this.render=function(e,t,n){e.translate(t.x,t.y),"auto"==this.attribute("orient").valueOrDefault("auto")&&e.rotate(n),"strokeWidth"==this.attribute("markerUnits").valueOrDefault("strokeWidth")&&e.scale(e.lineWidth,e.lineWidth),e.save();var i=new M.Element.svg;i.attributes.viewBox=new M.Property("viewBox",this.attribute("viewBox").value),i.attributes.refX=new M.Property("refX",this.attribute("refX").value),i.attributes.refY=new M.Property("refY",this.attribute("refY").value),i.attributes.width=new M.Property("width",this.attribute("markerWidth").value),i.attributes.height=new M.Property("height",this.attribute("markerHeight").value),i.attributes.fill=new M.Property("fill",this.attribute("fill").valueOrDefault("black")),i.attributes.stroke=new M.Property("stroke",this.attribute("stroke").valueOrDefault("none")),i.children=this.children,i.render(e),e.restore(),"strokeWidth"==this.attribute("markerUnits").valueOrDefault("strokeWidth")&&e.scale(1/e.lineWidth,1/e.lineWidth),"auto"==this.attribute("orient").valueOrDefault("auto")&&e.rotate(-n),e.translate(-t.x,-t.y)}},M.Element.marker.prototype=new M.Element.ElementBase,M.Element.defs=function(e){this.base=M.Element.ElementBase,this.base(e),this.render=function(e){}},M.Element.defs.prototype=new M.Element.ElementBase,M.Element.GradientBase=function(e){this.base=M.Element.ElementBase,this.base(e),this.stops=[];for(var t=0;t<this.children.length;t++){var n=this.children[t];"stop"==n.type&&this.stops.push(n)}this.getGradient=function(){},this.gradientUnits=function(){return this.attribute("gradientUnits").valueOrDefault("objectBoundingBox")},this.attributesToInherit=["gradientUnits"],this.inheritStopContainer=function(e){for(var t=0;t<this.attributesToInherit.length;t++){var n=this.attributesToInherit[t];!this.attribute(n).hasValue()&&e.attribute(n).hasValue()&&(this.attribute(n,!0).value=e.attribute(n).value)}},this.createGradient=function(e,t,n){function i(e){return n.hasValue()?new M.Property("color",e).addOpacity(n).value:e}var a=this,s=(this.getHrefAttribute().hasValue()&&(a=this.getHrefAttribute().getDefinition(),this.inheritStopContainer(a)),this.getGradient(e,t));if(null==s)return i(a.stops[a.stops.length-1].color);for(var r,o=0;o<a.stops.length;o++)s.addColorStop(a.stops[o].offset,i(a.stops[o].color));return this.attribute("gradientTransform").hasValue()?(e=M.ViewPort.viewPorts[0],(t=new M.Element.rect).attributes.x=new M.Property("x",-M.MAX_VIRTUAL_PIXELS/3),t.attributes.y=new M.Property("y",-M.MAX_VIRTUAL_PIXELS/3),t.attributes.width=new M.Property("width",M.MAX_VIRTUAL_PIXELS),t.attributes.height=new M.Property("height",M.MAX_VIRTUAL_PIXELS),(r=new M.Element.g).attributes.transform=new M.Property("transform",this.attribute("gradientTransform").value),r.children=[t],(t=new M.Element.svg).attributes.x=new M.Property("x",0),t.attributes.y=new M.Property("y",0),t.attributes.width=new M.Property("width",e.width),t.attributes.height=new M.Property("height",e.height),t.children=[r],(r=document.createElement("canvas")).width=e.width,r.height=e.height,(e=r.getContext("2d")).fillStyle=s,t.render(e),e.createPattern(r,"no-repeat")):s}},M.Element.GradientBase.prototype=new M.Element.ElementBase,M.Element.linearGradient=function(e){this.base=M.Element.GradientBase,this.base(e),this.attributesToInherit.push("x1"),this.attributesToInherit.push("y1"),this.attributesToInherit.push("x2"),this.attributesToInherit.push("y2"),this.getGradient=function(e,t){var t="objectBoundingBox"==this.gradientUnits()?t.getBoundingBox():null,n=(this.attribute("x1").hasValue()||this.attribute("y1").hasValue()||this.attribute("x2").hasValue()||this.attribute("y2").hasValue()||(this.attribute("x1",!0).value=0,this.attribute("y1",!0).value=0,this.attribute("x2",!0).value=1,this.attribute("y2",!0).value=0),"objectBoundingBox"==this.gradientUnits()?t.x()+t.width()*this.attribute("x1").numValue():this.attribute("x1").toPixels("x")),i="objectBoundingBox"==this.gradientUnits()?t.y()+t.height()*this.attribute("y1").numValue():this.attribute("y1").toPixels("y"),a="objectBoundingBox"==this.gradientUnits()?t.x()+t.width()*this.attribute("x2").numValue():this.attribute("x2").toPixels("x"),t="objectBoundingBox"==this.gradientUnits()?t.y()+t.height()*this.attribute("y2").numValue():this.attribute("y2").toPixels("y");return n==a&&i==t?null:e.createLinearGradient(n,i,a,t)}},M.Element.linearGradient.prototype=new M.Element.GradientBase,M.Element.radialGradient=function(e){this.base=M.Element.GradientBase,this.base(e),this.attributesToInherit.push("cx"),this.attributesToInherit.push("cy"),this.attributesToInherit.push("r"),this.attributesToInherit.push("fx"),this.attributesToInherit.push("fy"),this.getGradient=function(e,t){var t=t.getBoundingBox(),n=(this.attribute("cx").hasValue()||(this.attribute("cx",!0).value="50%"),this.attribute("cy").hasValue()||(this.attribute("cy",!0).value="50%"),this.attribute("r").hasValue()||(this.attribute("r",!0).value="50%"),"objectBoundingBox"==this.gradientUnits()?t.x()+t.width()*this.attribute("cx").numValue():this.attribute("cx").toPixels("x")),i="objectBoundingBox"==this.gradientUnits()?t.y()+t.height()*this.attribute("cy").numValue():this.attribute("cy").toPixels("y"),a=n,s=i,t=(this.attribute("fx").hasValue()&&(a="objectBoundingBox"==this.gradientUnits()?t.x()+t.width()*this.attribute("fx").numValue():this.attribute("fx").toPixels("x")),this.attribute("fy").hasValue()&&(s="objectBoundingBox"==this.gradientUnits()?t.y()+t.height()*this.attribute("fy").numValue():this.attribute("fy").toPixels("y")),"objectBoundingBox"==this.gradientUnits()?(t.width()+t.height())/2*this.attribute("r").numValue():this.attribute("r").toPixels());return e.createRadialGradient(a,s,0,n,i,t)}},M.Element.radialGradient.prototype=new M.Element.GradientBase,M.Element.stop=function(e){this.base=M.Element.ElementBase,this.base(e),this.offset=this.attribute("offset").numValue(),this.offset<0&&(this.offset=0),1<this.offset&&(this.offset=1);e=this.style("stop-color",!0);""===e.value&&(e.value="#000"),this.style("stop-opacity").hasValue()&&(e=e.addOpacity(this.style("stop-opacity"))),this.color=e.value},M.Element.stop.prototype=new M.Element.ElementBase,M.Element.AnimateBase=function(e){this.base=M.Element.ElementBase,this.base(e),M.Animations.push(this),this.duration=0,this.begin=this.attribute("begin").toMilliseconds(),this.maxDuration=this.begin+this.attribute("dur").toMilliseconds(),this.getProperty=function(){var e=this.attribute("attributeType").value,t=this.attribute("attributeName").value;return"CSS"==e?this.parent.style(t,!0):this.parent.attribute(t,!0)},this.initialValue=null,this.initialUnits="",this.removed=!1,this.calcValue=function(){return""},this.update=function(e){if(null==this.initialValue&&(this.initialValue=this.getProperty().value,this.initialUnits=this.getProperty().getUnits()),this.duration>this.maxDuration){if("indefinite"==this.attribute("repeatCount").value||"indefinite"==this.attribute("repeatDur").value)this.duration=0;else if("freeze"!=this.attribute("fill").valueOrDefault("remove")||this.frozen){if("remove"==this.attribute("fill").valueOrDefault("remove")&&!this.removed)return this.removed=!0,this.getProperty().value=this.parent.animationFrozen?this.parent.animationFrozenValue:this.initialValue,!0}else this.frozen=!0,this.parent.animationFrozen=!0,this.parent.animationFrozenValue=this.getProperty().value;return!1}this.duration=this.duration+e;var t,e=!1;return this.begin<this.duration&&(t=this.calcValue(),this.attribute("type").hasValue()&&(t=this.attribute("type").value+"("+t+")"),this.getProperty().value=t,e=!0),e},this.from=this.attribute("from"),this.to=this.attribute("to"),this.values=this.attribute("values"),this.values.hasValue()&&(this.values.value=this.values.value.split(";")),this.progress=function(){var e,t,n,i={progress:(this.duration-this.begin)/(this.maxDuration-this.begin)};return this.values.hasValue()?(e=i.progress*(this.values.value.length-1),t=Math.floor(e),n=Math.ceil(e),i.from=new M.Property("from",parseFloat(this.values.value[t])),i.to=new M.Property("to",parseFloat(this.values.value[n])),i.progress=(e-t)/(n-t)):(i.from=this.from,i.to=this.to),i}},M.Element.AnimateBase.prototype=new M.Element.ElementBase,M.Element.animate=function(e){this.base=M.Element.AnimateBase,this.base(e),this.calcValue=function(){var e=this.progress();return e.from.numValue()+(e.to.numValue()-e.from.numValue())*e.progress+this.initialUnits}},M.Element.animate.prototype=new M.Element.AnimateBase,M.Element.animateColor=function(e){this.base=M.Element.AnimateBase,this.base(e),this.calcValue=function(){var e,t,n=this.progress(),i=new RGBColor(n.from.value),a=new RGBColor(n.to.value);return i.ok&&a.ok?(e=i.r+(a.r-i.r)*n.progress,t=i.g+(a.g-i.g)*n.progress,a=i.b+(a.b-i.b)*n.progress,"rgb("+parseInt(e,10)+","+parseInt(t,10)+","+parseInt(a,10)+")"):this.attribute("from").value}},M.Element.animateColor.prototype=new M.Element.AnimateBase,M.Element.animateTransform=function(e){this.base=M.Element.AnimateBase,this.base(e),this.calcValue=function(){for(var e=this.progress(),t=M.ToNumberArray(e.from.value),n=M.ToNumberArray(e.to.value),i="",a=0;a<t.length;a++)i+=t[a]+(n[a]-t[a])*e.progress+" ";return i}},M.Element.animateTransform.prototype=new M.Element.animate,M.Element.font=function(e){this.base=M.Element.ElementBase,this.base(e),this.horizAdvX=this.attribute("horiz-adv-x").numValue(),this.isRTL=!1,this.isArabic=!1,this.fontFace=null,this.missingGlyph=null,this.glyphs=[];for(var t=0;t<this.children.length;t++){var n=this.children[t];"font-face"==n.type?(this.fontFace=n).style("font-family").hasValue()&&(M.Definitions[n.style("font-family").value]=this):"missing-glyph"==n.type?this.missingGlyph=n:"glyph"==n.type&&(""!=n.arabicForm?(this.isRTL=!0,this.isArabic=!0,void 0===this.glyphs[n.unicode]&&(this.glyphs[n.unicode]=[]),this.glyphs[n.unicode][n.arabicForm]=n):this.glyphs[n.unicode]=n)}},M.Element.font.prototype=new M.Element.ElementBase,M.Element.fontface=function(e){this.base=M.Element.ElementBase,this.base(e),this.ascent=this.attribute("ascent").value,this.descent=this.attribute("descent").value,this.unitsPerEm=this.attribute("units-per-em").numValue()},M.Element.fontface.prototype=new M.Element.ElementBase,M.Element.missingglyph=function(e){this.base=M.Element.path,this.base(e),this.horizAdvX=0},M.Element.missingglyph.prototype=new M.Element.path,M.Element.glyph=function(e){this.base=M.Element.path,this.base(e),this.horizAdvX=this.attribute("horiz-adv-x").numValue(),this.unicode=this.attribute("unicode").value,this.arabicForm=this.attribute("arabic-form").value},M.Element.glyph.prototype=new M.Element.path,M.Element.text=function(e){this.captureTextNodes=!0,this.base=M.Element.RenderedElementBase,this.base(e),this.baseSetContext=this.setContext,this.setContext=function(e){this.baseSetContext(e);var t=this.style("dominant-baseline").toTextBaseline();null!=(t=null==t?this.style("alignment-baseline").toTextBaseline():t)&&(e.textBaseline=t)},this.getBoundingBox=function(){var e=this.attribute("x").toPixels("x"),t=this.attribute("y").toPixels("y"),n=this.parent.style("font-size").numValueOrDefault(M.Font.Parse(M.ctx.font).fontSize);return new M.BoundingBox(e,t-n,e+Math.floor(2*n/3)*this.children[0].getText().length,t)},this.renderChildren=function(e){this.x=this.attribute("x").toPixels("x"),this.y=this.attribute("y").toPixels("y"),this.attribute("dx").hasValue()&&(this.x+=this.attribute("dx").toPixels("x")),this.attribute("dy").hasValue()&&(this.y+=this.attribute("dy").toPixels("y")),this.x+=this.getAnchorDelta(e,this,0);for(var t=0;t<this.children.length;t++)this.renderChild(e,this,t)},this.getAnchorDelta=function(e,t,n){var i=this.style("text-anchor").valueOrDefault("start");if("start"==i)return 0;for(var a=0,s=n;s<t.children.length;s++){var r=t.children[s];if(n<s&&r.attribute("x").hasValue())break;a+=r.measureTextRecursive(e)}return-1*("end"==i?a:a/2)},this.renderChild=function(e,t,n){var i=t.children[n];i.attribute("x").hasValue()?(i.x=i.attribute("x").toPixels("x")+t.getAnchorDelta(e,t,n),i.attribute("dx").hasValue()&&(i.x+=i.attribute("dx").toPixels("x"))):(i.attribute("dx").hasValue()&&(t.x+=i.attribute("dx").toPixels("x")),i.x=t.x),t.x=i.x+i.measureText(e),i.attribute("y").hasValue()?(i.y=i.attribute("y").toPixels("y"),i.attribute("dy").hasValue()&&(i.y+=i.attribute("dy").toPixels("y"))):(i.attribute("dy").hasValue()&&(t.y+=i.attribute("dy").toPixels("y")),i.y=t.y),t.y=i.y,i.render(e);for(n=0;n<i.children.length;n++)t.renderChild(e,i,n)}},M.Element.text.prototype=new M.Element.RenderedElementBase,M.Element.TextElementBase=function(e){this.base=M.Element.RenderedElementBase,this.base(e),this.getGlyph=function(e,t,n){var i,a=t[n],s=null;return s=null==(s=e.isArabic&&(i="isolated",(0==n||" "==t[n-1])&&n<t.length-2&&" "!=t[n+1]&&(i="terminal"),0<n&&" "!=t[n-1]&&n<t.length-2&&" "!=t[n+1]&&(i="medial"),0<n&&" "!=t[n-1]&&(n==t.length-1||" "==t[n+1])&&(i="initial"),void 0===e.glyphs[a]||null!=(s=e.glyphs[a][i])||"glyph"!=e.glyphs[a].type)?s:e.glyphs[a])?e.missingGlyph:s},this.renderChildren=function(e){var t=this.parent.style("font-family").getDefinition();if(null!=t)for(var n=this.parent.style("font-size").numValueOrDefault(M.Font.Parse(M.ctx.font).fontSize),i=this.parent.style("font-style").valueOrDefault(M.Font.Parse(M.ctx.font).fontStyle),a=this.getText(),s=(t.isRTL&&(a=a.split("").reverse().join("")),M.ToNumberArray(this.parent.attribute("dx").value)),r=0;r<a.length;r++){var o=this.getGlyph(t,a,r),l=n/t.fontFace.unitsPerEm,u=(e.translate(this.x,this.y),e.scale(l,-l),e.lineWidth);e.lineWidth=e.lineWidth*t.fontFace.unitsPerEm/n,"italic"==i&&e.transform(1,0,.4,1,0,0),o.render(e),"italic"==i&&e.transform(1,0,-.4,1,0,0),e.lineWidth=u,e.scale(1/l,-1/l),e.translate(-this.x,-this.y),this.x+=n*(o.horizAdvX||t.horizAdvX)/t.fontFace.unitsPerEm,void 0===s[r]||isNaN(s[r])||(this.x+=s[r])}else""!=e.fillStyle&&e.fillText(M.compressSpaces(this.getText()),this.x,this.y),""!=e.strokeStyle&&e.strokeText(M.compressSpaces(this.getText()),this.x,this.y)},this.getText=function(){},this.measureTextRecursive=function(e){for(var t=this.measureText(e),n=0;n<this.children.length;n++)t+=this.children[n].measureTextRecursive(e);return t},this.measureText=function(e){var t=this.parent.style("font-family").getDefinition();if(null!=t){for(var n=this.parent.style("font-size").numValueOrDefault(M.Font.Parse(M.ctx.font).fontSize),i=0,a=this.getText(),s=(t.isRTL&&(a=a.split("").reverse().join("")),M.ToNumberArray(this.parent.attribute("dx").value)),r=0;r<a.length;r++)i+=(this.getGlyph(t,a,r).horizAdvX||t.horizAdvX)*n/t.fontFace.unitsPerEm,void 0===s[r]||isNaN(s[r])||(i+=s[r]);return i}var o=M.compressSpaces(this.getText());if(!e.measureText)return 10*o.length;e.save(),this.setContext(e);o=e.measureText(o).width;return e.restore(),o}},M.Element.TextElementBase.prototype=new M.Element.RenderedElementBase,M.Element.tspan=function(e){this.captureTextNodes=!0,this.base=M.Element.TextElementBase,this.base(e),this.text=M.compressSpaces(e.value||e.text||e.textContent||""),this.getText=function(){return 0<this.children.length?"":this.text}},M.Element.tspan.prototype=new M.Element.TextElementBase,M.Element.tref=function(e){this.base=M.Element.TextElementBase,this.base(e),this.getText=function(){var e=this.getHrefAttribute().getDefinition();if(null!=e)return e.children[0].getText()}},M.Element.tref.prototype=new M.Element.TextElementBase,M.Element.a=function(e){this.base=M.Element.TextElementBase,this.base(e),this.hasText=0<e.childNodes.length;for(var t=0;t<e.childNodes.length;t++)3!=e.childNodes[t].nodeType&&(this.hasText=!1);this.text=this.hasText?e.childNodes[0].value:"",this.getText=function(){return this.text},this.baseRenderChildren=this.renderChildren,this.renderChildren=function(e){var t;this.hasText?(this.baseRenderChildren(e),t=new M.Property("fontSize",M.Font.Parse(M.ctx.font).fontSize),M.Mouse.checkBoundingBox(this,new M.BoundingBox(this.x,this.y-t.toPixels("y"),this.x+this.measureText(e),this.y))):0<this.children.length&&((t=new M.Element.g).children=this.children,t.parent=this,t.render(e))},this.onclick=function(){window.open(this.getHrefAttribute().value)},this.onmousemove=function(){M.ctx.canvas.style.cursor="pointer"}},M.Element.a.prototype=new M.Element.TextElementBase,M.Element.image=function(e){this.base=M.Element.RenderedElementBase,this.base(e);var s,t,n=this.getHrefAttribute().value;""!=n&&(s=n.match(/\.svg$/),M.Images.push(this),this.loaded=!1,s?(this.img=M.ajax(n),this.loaded=!0):(this.img=document.createElement("img"),1==M.opts.useCORS&&(this.img.crossOrigin="Anonymous"),(t=this).img.onload=function(){t.loaded=!0},this.img.onerror=function(){M.log('ERROR: image "'+n+'" not found'),t.loaded=!0},this.img.src=n),this.renderChildren=function(e){var t=this.attribute("x").toPixels("x"),n=this.attribute("y").toPixels("y"),i=this.attribute("width").toPixels("x"),a=this.attribute("height").toPixels("y");0!=i&&0!=a&&(e.save(),s?e.drawSvg(this.img,t,n,i,a):(e.translate(t,n),M.AspectRatio(e,this.attribute("preserveAspectRatio").value,i,this.img.width,a,this.img.height,0,0),e.drawImage(this.img,0,0)),e.restore())},this.getBoundingBox=function(){var e=this.attribute("x").toPixels("x"),t=this.attribute("y").toPixels("y"),n=this.attribute("width").toPixels("x"),i=this.attribute("height").toPixels("y");return new M.BoundingBox(e,t,e+n,t+i)})},M.Element.image.prototype=new M.Element.RenderedElementBase,M.Element.g=function(e){this.base=M.Element.RenderedElementBase,this.base(e),this.getBoundingBox=function(){for(var e=new M.BoundingBox,t=0;t<this.children.length;t++)e.addBoundingBox(this.children[t].getBoundingBox());return e}},M.Element.g.prototype=new M.Element.RenderedElementBase,M.Element.symbol=function(e){this.base=M.Element.RenderedElementBase,this.base(e),this.render=function(e){}},M.Element.symbol.prototype=new M.Element.RenderedElementBase,M.Element.style=function(e){this.base=M.Element.ElementBase,this.base(e);for(var t="",n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].data;t=t.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(^[\s]*\/\/.*)/gm,"");for(var i=(t=M.compressSpaces(t)).split("}"),n=0;n<i.length;n++)if(""!=M.trim(i[n]))for(var a=i[n].split("{"),s=a[0].split(","),r=a[1].split(";"),o=0;o<s.length;o++){var l=M.trim(s[o]);if(""!=l){for(var u={},c=0;c<r.length;c++){var h=r[c].indexOf(":"),d=r[c].substr(0,h),h=r[c].substr(h+1,r[c].length-h);null!=d&&null!=h&&(u[M.trim(d)]=new M.Property(M.trim(d),M.trim(h)))}if(M.Styles[l]=u,M.StylesSpecificity[l]=function(i){function e(e,t){var n=i.match(e);null!=n&&(a[t]+=n.length,i=i.replace(e," "))}var a=[0,0,0];return i=(i=i.replace(/:not\(([^\)]*)\)/g,"     $1 ")).replace(/{[^]*/gm," "),e(w,1),e(x,0),e(C,1),e(P,2),e(k,1),e(E,1),i=(i=i.replace(/[\*\s\+>~]/g," ")).replace(/[#\.]/g," "),e(L,2),a.join("")}(l),"@font-face"==l)for(var p=u["font-family"].value.replace(/"/g,""),g=u.src.value.split(","),f=0;f<g.length;f++)if(0<g[f].indexOf('format("svg")'))for(var m=g[f].indexOf("url"),v=g[f].indexOf(")",m),v=g[f].substr(m+5,v-m-6),b=M.parseXml(M.ajax(v)).getElementsByTagName("font"),y=0;y<b.length;y++){var _=M.CreateElement(b[y]);M.Definitions[p]=_}}}},M.Element.style.prototype=new M.Element.ElementBase,M.Element.use=function(e){this.base=M.Element.RenderedElementBase,this.base(e),this.baseSetContext=this.setContext,this.setContext=function(e){this.baseSetContext(e),this.attribute("x").hasValue()&&e.translate(this.attribute("x").toPixels("x"),0),this.attribute("y").hasValue()&&e.translate(0,this.attribute("y").toPixels("y"))};var i=this.getHrefAttribute().getDefinition();this.path=function(e){null!=i&&i.path(e)},this.getBoundingBox=function(){if(null!=i)return i.getBoundingBox()},this.renderChildren=function(e){var t,n;null!=i&&("symbol"==(t=i).type&&((t=new M.Element.svg).type="svg",t.attributes.viewBox=new M.Property("viewBox",i.attribute("viewBox").value),t.attributes.preserveAspectRatio=new M.Property("preserveAspectRatio",i.attribute("preserveAspectRatio").value),t.attributes.overflow=new M.Property("overflow",i.attribute("overflow").value),t.children=i.children),"svg"==t.type&&(this.attribute("width").hasValue()&&(t.attributes.width=new M.Property("width",this.attribute("width").value)),this.attribute("height").hasValue())&&(t.attributes.height=new M.Property("height",this.attribute("height").value)),n=t.parent,t.parent=null,t.render(e),t.parent=n)}},M.Element.use.prototype=new M.Element.RenderedElementBase,M.Element.mask=function(e){this.base=M.Element.ElementBase,this.base(e),this.apply=function(e,t){var n=this.attribute("x").toPixels("x"),i=this.attribute("y").toPixels("y"),a=this.attribute("width").toPixels("x"),s=this.attribute("height").toPixels("y");if(0==a&&0==s){for(var r=new M.BoundingBox,o=0;o<this.children.length;o++)r.addBoundingBox(this.children[o].getBoundingBox());n=Math.floor(r.x1),i=Math.floor(r.y1),a=Math.floor(r.width()),s=Math.floor(r.height())}var l=t.attribute("mask").value,u=(t.attribute("mask").value="",document.createElement("canvas")),c=(u.width=n+a,u.height=i+s,u.getContext("2d")),h=(this.renderChildren(c),document.createElement("canvas")),d=(h.width=n+a,h.height=i+s,h.getContext("2d"));t.render(d),d.globalCompositeOperation="destination-in",d.fillStyle=c.createPattern(u,"no-repeat"),d.fillRect(0,0,n+a,i+s),e.fillStyle=d.createPattern(h,"no-repeat"),e.fillRect(0,0,n+a,i+s),t.attribute("mask").value=l},this.render=function(e){}},M.Element.mask.prototype=new M.Element.ElementBase,M.Element.clipPath=function(e){this.base=M.Element.ElementBase,this.base(e),this.apply=function(e){var t=CanvasRenderingContext2D.prototype.beginPath,n=(CanvasRenderingContext2D.prototype.beginPath=function(){},CanvasRenderingContext2D.prototype.closePath);CanvasRenderingContext2D.prototype.closePath=function(){},t.call(e);for(var i=0;i<this.children.length;i++){var a,s=this.children[i];void 0!==s.path&&(s.style("transform",!1,!(a=null)).hasValue()&&(a=new M.Transform(s.style("transform",!1,!0).value)).apply(e),s.path(e),CanvasRenderingContext2D.prototype.closePath=n,a)&&a.unapply(e)}n.call(e),e.clip(),CanvasRenderingContext2D.prototype.beginPath=t,CanvasRenderingContext2D.prototype.closePath=n},this.render=function(e){}},M.Element.clipPath.prototype=new M.Element.ElementBase,M.Element.filter=function(e){this.base=M.Element.ElementBase,this.base(e),this.apply=function(e,t){for(var n=t.getBoundingBox(),i=Math.floor(n.x1),a=Math.floor(n.y1),s=Math.floor(n.width()),r=Math.floor(n.height()),n=t.style("filter").value,o=(t.style("filter").value="",0),l=0,u=0;u<this.children.length;u++)var c=this.children[u].extraFilterDistance||0,o=Math.max(o,c),l=Math.max(l,c);var h=document.createElement("canvas"),d=(h.width=s+2*o,h.height=r+2*l,h.getContext("2d"));d.translate(-i+o,-a+l),t.render(d);for(u=0;u<this.children.length;u++)"function"==typeof this.children[u].apply&&this.children[u].apply(d,0,0,s+2*o,r+2*l);e.drawImage(h,0,0,s+2*o,r+2*l,i-o,a-l,s+2*o,r+2*l),t.style("filter",!0).value=n},this.render=function(e){}},M.Element.filter.prototype=new M.Element.ElementBase,M.Element.feMorphology=function(e){this.base=M.Element.ElementBase,this.base(e),this.apply=function(e,t,n,i,a){}},M.Element.feMorphology.prototype=new M.Element.ElementBase,M.Element.feComposite=function(e){this.base=M.Element.ElementBase,this.base(e),this.apply=function(e,t,n,i,a){}},M.Element.feComposite.prototype=new M.Element.ElementBase,M.Element.feColorMatrix=function(e){this.base=M.Element.ElementBase,this.base(e);var n=M.ToNumberArray(this.attribute("values").value);switch(this.attribute("type").valueOrDefault("matrix")){case"saturate":var t=n[0],n=[.213+.787*t,.715-.715*t,.072-.072*t,0,0,.213-.213*t,.715+.285*t,.072-.072*t,0,0,.213-.213*t,.715-.715*t,.072+.928*t,0,0,0,0,0,1,0,0,0,0,0,1];break;case"hueRotate":function i(e,t,n){return e+Math.cos(a)*t+Math.sin(a)*n}var a=n[0]*Math.PI/180;n=[i(.213,.787,-.213),i(.715,-.715,-.715),i(.072,-.072,.928),0,0,i(.213,-.213,.143),i(.715,.285,.14),i(.072,-.072,-.283),0,0,i(.213,-.213,-.787),i(.715,-.715,.715),i(.072,.928,.072),0,0,0,0,0,1,0,0,0,0,0,1];break;case"luminanceToAlpha":n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.2125,.7154,.0721,0,0,0,0,0,0,1]}function c(e,t,n,i,a,s){return e[n*i*4+4*t+s]}function h(e,t,n,i,a,s,r){e[n*i*4+4*t+s]=r}function d(e,t){e=n[e];return e*(e<0?t-255:t)}this.apply=function(e,t,n,i,a){for(var s=e.getImageData(0,0,i,a),n=0;n<a;n++)for(t=0;t<i;t++){var r=c(s.data,t,n,i,0,0),o=c(s.data,t,n,i,0,1),l=c(s.data,t,n,i,0,2),u=c(s.data,t,n,i,0,3);h(s.data,t,n,i,0,0,d(0,r)+d(1,o)+d(2,l)+d(3,u)+d(4,1)),h(s.data,t,n,i,0,1,d(5,r)+d(6,o)+d(7,l)+d(8,u)+d(9,1)),h(s.data,t,n,i,0,2,d(10,r)+d(11,o)+d(12,l)+d(13,u)+d(14,1)),h(s.data,t,n,i,0,3,d(15,r)+d(16,o)+d(17,l)+d(18,u)+d(19,1))}e.clearRect(0,0,i,a),e.putImageData(s,0,0)}},M.Element.feColorMatrix.prototype=new M.Element.ElementBase,M.Element.feGaussianBlur=function(e){this.base=M.Element.ElementBase,this.base(e),this.blurRadius=Math.floor(this.attribute("stdDeviation").numValue()),this.extraFilterDistance=this.blurRadius,this.apply=function(e,t,n,i,a){void 0===stackBlurCanvasRGBA?M.log("ERROR: StackBlur.js must be included for blur to work"):(e.canvas.id=M.UniqueId(),e.canvas.style.display="none",document.body.appendChild(e.canvas),stackBlurCanvasRGBA(e.canvas.id,t,n,i,a,this.blurRadius),document.body.removeChild(e.canvas))}},M.Element.feGaussianBlur.prototype=new M.Element.ElementBase,M.Element.title=function(e){},M.Element.title.prototype=new M.Element.ElementBase,M.Element.desc=function(e){},M.Element.desc.prototype=new M.Element.ElementBase,M.Element.MISSING=function(e){M.log("ERROR: Element '"+e.nodeName+"' not yet implemented.")},M.Element.MISSING.prototype=new M.Element.ElementBase,M.CreateElement=function(e){var t=(t=e.nodeName.replace(/^[^:]+:/,"")).replace(/\-/g,""),n=null;return(n=new(void 0!==M.Element[t]?M.Element[t]:M.Element.MISSING)(e)).type=e.nodeName,n},M.load=function(e,t){M.loadXml(e,M.ajax(t))},M.loadXml=function(e,t){M.loadXmlDoc(e,M.parseXml(t))},M.loadXmlDoc=function(s,r){M.init(s);function t(e){for(var t=s.canvas;t;)e.x-=t.offsetLeft,e.y-=t.offsetTop,t=t.offsetParent;return window.scrollX&&(e.x+=window.scrollX),window.scrollY&&(e.y+=window.scrollY),e}function n(){M.ViewPort.Clear(),s.canvas.parentNode&&M.ViewPort.SetCurrent(s.canvas.parentNode.clientWidth,s.canvas.parentNode.clientHeight),1!=M.opts.ignoreDimensions&&(o.style("width").hasValue()&&(s.canvas.width=o.style("width").toPixels("x"),s.canvas.style.width=s.canvas.width+"px"),o.style("height").hasValue())&&(s.canvas.height=o.style("height").toPixels("y"),s.canvas.style.height=s.canvas.height+"px");var e,t,n,i=s.canvas.clientWidth||s.canvas.width,a=s.canvas.clientHeight||s.canvas.height;1==M.opts.ignoreDimensions&&o.style("width").hasValue()&&o.style("height").hasValue()&&(i=o.style("width").toPixels("x"),a=o.style("height").toPixels("y")),M.ViewPort.SetCurrent(i,a),null!=M.opts.offsetX&&(o.attribute("x",!0).value=M.opts.offsetX),null!=M.opts.offsetY&&(o.attribute("y",!0).value=M.opts.offsetY),null==M.opts.scaleWidth&&null==M.opts.scaleHeight||(t=e=null,n=M.ToNumberArray(o.attribute("viewBox").value),null!=M.opts.scaleWidth&&(o.attribute("width").hasValue()?e=o.attribute("width").toPixels("x")/M.opts.scaleWidth:isNaN(n[2])||(e=n[2]/M.opts.scaleWidth)),null!=M.opts.scaleHeight&&(o.attribute("height").hasValue()?t=o.attribute("height").toPixels("y")/M.opts.scaleHeight:isNaN(n[3])||(t=n[3]/M.opts.scaleHeight)),null==e&&(e=t),null==t&&(t=e),o.attribute("width",!0).value=M.opts.scaleWidth,o.attribute("height",!0).value=M.opts.scaleHeight,o.style("transform",!0,!0).value+=" scale("+1/e+","+1/t+")"),1!=M.opts.ignoreClear&&s.clearRect(0,0,i,a),o.render(s),l&&(l=!1,"function"==typeof M.opts.renderCallback)&&M.opts.renderCallback(r)}1!=M.opts.ignoreMouse&&(s.canvas.onclick=function(e){e=t(new M.Point((null!=e?e:event).clientX,(null!=e?e:event).clientY));M.Mouse.onclick(e.x,e.y)},s.canvas.onmousemove=function(e){e=t(new M.Point((null!=e?e:event).clientX,(null!=e?e:event).clientY));M.Mouse.onmousemove(e.x,e.y)});var o=M.CreateElement(r.documentElement),l=(o.root=!0,o.addStylesFromStyleDefinition(),!0),i=!0;M.ImagesLoaded()&&(i=!1,n()),M.intervalID=setInterval(function(){var e=!1;if(i&&M.ImagesLoaded()&&(e=!(i=!1)),1!=M.opts.ignoreMouse&&(e|=M.Mouse.hasEvents()),1!=M.opts.ignoreAnimation)for(var t=0;t<M.Animations.length;t++)e|=M.Animations[t].update(1e3/M.FRAMERATE);(e="function"==typeof M.opts.forceRedraw&&1==M.opts.forceRedraw()?!0:e)&&(n(),M.Mouse.runEvents())},1e3/M.FRAMERATE)},M.stop=function(){M.intervalID&&clearInterval(M.intervalID)},M.Mouse=new function(){this.events=[],this.hasEvents=function(){return 0!=this.events.length},this.onclick=function(e,t){this.events.push({type:"onclick",x:e,y:t,run:function(e){e.onclick&&e.onclick()}})},this.onmousemove=function(e,t){this.events.push({type:"onmousemove",x:e,y:t,run:function(e){e.onmousemove&&e.onmousemove()}})},this.eventElements=[],this.checkPath=function(e,t){for(var n=0;n<this.events.length;n++){var i=this.events[n];t.isPointInPath&&t.isPointInPath(i.x,i.y)&&(this.eventElements[n]=e)}},this.checkBoundingBox=function(e,t){for(var n=0;n<this.events.length;n++){var i=this.events[n];t.isPointInBox(i.x,i.y)&&(this.eventElements[n]=e)}},this.runEvents=function(){M.ctx.canvas.style.cursor="";for(var e=0;e<this.events.length;e++)for(var t=this.events[e],n=this.eventElements[e];n;)t.run(n),n=n.parent;this.events=[],this.eventElements=[]}},M}(n||{}),e=(1==e.childNodes.length&&"OBJECT"==e.childNodes[0].nodeName||(e.svg=n),e.getContext("2d"));void 0!==t.documentElement?n.loadXmlDoc(e,t):"<"==t.substr(0,1)?n.loadXml(e,t):n.load(e,t)}},void 0!==Element.prototype.matches?u=function(e,t){return e.matches(t)}:void 0!==Element.prototype.webkitMatchesSelector?u=function(e,t){return e.webkitMatchesSelector(t)}:void 0!==Element.prototype.mozMatchesSelector?u=function(e,t){return e.mozMatchesSelector(t)}:void 0!==Element.prototype.msMatchesSelector?u=function(e,t){return e.msMatchesSelector(t)}:void 0!==Element.prototype.oMatchesSelector?u=function(e,t){return e.oMatchesSelector(t)}:void 0===(u="function"!=typeof jQuery&&"function"!=typeof Zepto?u:function(e,t){return $(e).is(t)})&&(u=Sizzle.matchesSelector);var u,w=/(\[[^\]]+\])/g,x=/(#[^\s\+>~\.\[:]+)/g,C=/(\.[^\s\+>~\.\[:]+)/g,P=/(::[^\s\+>~\.\[:]+|:first-line|:first-letter|:before|:after)/gi,k=/(:[\w-]+\([^\)]*\))/gi,E=/(:[^\s\+>~\.\[:]+)/g,L=/([^\s\+>~\.\[:]+)/g}(),"undefined"!=typeof CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.drawSvg=function(e,t,n,i,a){canvg(this.canvas,e,{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:t,offsetY:n,scaleWidth:i,scaleHeight:a})});var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function premultiplyAlpha(e){for(var t=e.data,n=e.width*e.height*4,i=0;i<n;i+=4){var a=t[i+3]/255;t[i]*=a,t[i+1]*=a,t[i+2]*=a}}function unpremultiplyAlpha(e){for(var t=e.data,n=e.width*e.height*4,i=0;i<n;i+=4){var a=t[i+3];0!=a&&(t[i]*=a=255/a,t[i+1]*=a,t[i+2]*=a)}}function stackBlurImage(e,t,n,i){var e=document.getElementById(e),a=e.naturalWidth,s=e.naturalHeight,r=document.getElementById(t),r=(r.style.width=a+"px",r.style.height=s+"px",r.width=a,r.height=s,r.getContext("2d"));r.clearRect(0,0,a,s),r.drawImage(e,0,0),isNaN(n)||n<1||(i?stackBlurCanvasRGBA:stackBlurCanvasRGB)(t,0,0,a,s,n)}function stackBlurCanvasRGBA(t,V,$,n,i,e){if(!(isNaN(e)||e<1)){e|=0;var a,t=document.getElementById(t).getContext("2d");try{try{a=t.getImageData(V,$,n,i)}catch(e){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),a=t.getImageData(V,$,n,i)}catch(e){throw alert("Cannot access local image"),new Error("unable to access local image data: "+e)}}}catch(e){throw alert("Cannot access image"),new Error("unable to access image data: "+e)}premultiplyAlpha(a);for(var s,r,N,o,l,u,c,h,d,p,g,f,m,v,b,y,_,w,x,M,C,P=a.data,D=e+e+1,O=n-1,G=i-1,k=e+1,E=k*(k+1)/2,L=new BlurStack,R=L,A=1;A<D;A++){var z,R=R.next=new BlurStack;A==k&&(z=R)}R.next=L;for(var S=null,B=null,W=o=0,q=mul_table[e],I=shg_table[e],T=0;T<i;T++){for(m=v=b=y=l=u=c=h=0,d=k*(_=P[o]),p=k*(w=P[o+1]),g=k*(x=P[o+2]),f=k*(M=P[o+3]),l+=E*_,u+=E*w,c+=E*x,h+=E*M,R=L,A=0;A<k;A++)R.r=_,R.g=w,R.b=x,R.a=M,R=R.next;for(A=1;A<k;A++)l+=(R.r=_=P[r=o+((O<A?O:A)<<2)])*(C=k-A),u+=(R.g=w=P[r+1])*C,c+=(R.b=x=P[r+2])*C,h+=(R.a=M=P[r+3])*C,m+=_,v+=w,b+=x,y+=M,R=R.next;for(S=L,B=z,s=0;s<n;s++)P[o]=l*q>>I,P[o+1]=u*q>>I,P[o+2]=c*q>>I,P[o+3]=h*q>>I,l-=d,u-=p,c-=g,h-=f,d-=S.r,p-=S.g,g-=S.b,f-=S.a,r=W+((r=s+e+1)<O?r:O)<<2,l+=m+=S.r=P[r],u+=v+=S.g=P[r+1],c+=b+=S.b=P[r+2],h+=y+=S.a=P[r+3],S=S.next,d+=_=B.r,p+=w=B.g,g+=x=B.b,f+=M=B.a,m-=_,v-=w,b-=x,y-=M,B=B.next,o+=4;W+=n}for(s=0;s<n;s++){for(v=b=y=m=u=c=h=l=0,d=k*(_=P[o=s<<2]),p=k*(w=P[o+1]),g=k*(x=P[o+2]),f=k*(M=P[o+3]),l+=E*_,u+=E*w,c+=E*x,h+=E*M,R=L,A=0;A<k;A++)R.r=_,R.g=w,R.b=x,R.a=M,R=R.next;for(N=n,A=1;A<=e;A++)l+=(R.r=_=P[o=N+s<<2])*(C=k-A),u+=(R.g=w=P[o+1])*C,c+=(R.b=x=P[o+2])*C,h+=(R.a=M=P[o+3])*C,m+=_,v+=w,b+=x,y+=M,R=R.next,A<G&&(N+=n);for(o=s,S=L,B=z,T=0;T<i;T++)P[r=o<<2]=l*q>>I,P[r+1]=u*q>>I,P[r+2]=c*q>>I,P[r+3]=h*q>>I,l-=d,u-=p,c-=g,h-=f,d-=S.r,p-=S.g,g-=S.b,f-=S.a,r=s+((r=T+k)<G?r:G)*n<<2,l+=m+=S.r=P[r],u+=v+=S.g=P[r+1],c+=b+=S.b=P[r+2],h+=y+=S.a=P[r+3],S=S.next,d+=_=B.r,p+=w=B.g,g+=x=B.b,f+=M=B.a,m-=_,v-=w,b-=x,y-=M,B=B.next,o+=n}unpremultiplyAlpha(a),t.putImageData(a,V,$)}}function stackBlurCanvasRGB(t,n,i,a,s,e){if(!(isNaN(e)||e<1)){e|=0;var r,t=document.getElementById(t).getContext("2d");try{try{r=t.getImageData(n,i,a,s)}catch(e){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),r=t.getImageData(n,i,a,s)}catch(e){throw alert("Cannot access local image"),new Error("unable to access local image data: "+e)}}}catch(e){throw alert("Cannot access image"),new Error("unable to access image data: "+e)}for(var o,l,u,c,h,d,p,g,f,m,v,b,y,_,w,x,M,C=r.data,V=e+e+1,P=a-1,$=s-1,k=e+1,E=k*(k+1)/2,L=new BlurStack,R=L,A=1;A<V;A++){var N,R=R.next=new BlurStack;A==k&&(N=R)}R.next=L;for(var S=null,B=null,D=c=0,q=mul_table[e],I=shg_table[e],T=0;T<s;T++){for(v=b=y=h=d=p=0,g=k*(_=C[c]),f=k*(w=C[c+1]),m=k*(x=C[c+2]),h+=E*_,d+=E*w,p+=E*x,R=L,A=0;A<k;A++)R.r=_,R.g=w,R.b=x,R=R.next;for(A=1;A<k;A++)h+=(R.r=_=C[l=c+((P<A?P:A)<<2)])*(M=k-A),d+=(R.g=w=C[l+1])*M,p+=(R.b=x=C[l+2])*M,v+=_,b+=w,y+=x,R=R.next;for(S=L,B=N,o=0;o<a;o++)C[c]=h*q>>I,C[c+1]=d*q>>I,C[c+2]=p*q>>I,h-=g,d-=f,p-=m,g-=S.r,f-=S.g,m-=S.b,l=D+((l=o+e+1)<P?l:P)<<2,h+=v+=S.r=C[l],d+=b+=S.g=C[l+1],p+=y+=S.b=C[l+2],S=S.next,g+=_=B.r,f+=w=B.g,m+=x=B.b,v-=_,b-=w,y-=x,B=B.next,c+=4;D+=a}for(o=0;o<a;o++){for(b=y=v=d=p=h=0,g=k*(_=C[c=o<<2]),f=k*(w=C[c+1]),m=k*(x=C[c+2]),h+=E*_,d+=E*w,p+=E*x,R=L,A=0;A<k;A++)R.r=_,R.g=w,R.b=x,R=R.next;for(u=a,A=1;A<=e;A++)h+=(R.r=_=C[c=u+o<<2])*(M=k-A),d+=(R.g=w=C[c+1])*M,p+=(R.b=x=C[c+2])*M,v+=_,b+=w,y+=x,R=R.next,A<$&&(u+=a);for(c=o,S=L,B=N,T=0;T<s;T++)C[l=c<<2]=h*q>>I,C[l+1]=d*q>>I,C[l+2]=p*q>>I,h-=g,d-=f,p-=m,g-=S.r,f-=S.g,m-=S.b,l=o+((l=T+k)<$?l:$)*a<<2,h+=v+=S.r=C[l],d+=b+=S.g=C[l+1],p+=y+=S.b=C[l+2],S=S.next,g+=_=B.r,f+=w=B.g,m+=x=B.b,v-=_,b-=w,y-=x,B=B.next,c+=a}t.putImageData(r,n,i)}}function BlurStack(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}!function(e){"use strict";var c,h=e.Uint8Array,e=e.HTMLCanvasElement,t=e&&e.prototype,r=/\s*;\s*base64\s*(?:;|$)/i,o="toDataURL";h&&(c=new h([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])),!e||t.toBlob&&t.toBlobHD||(t.toBlob||(t.toBlob=function(e,t){var n,i,a,s;t=t||"image/png",this.mozGetAsFile?e(this.mozGetAsFile("canvas",t)):this.msToBlob&&/^\s*image\/png\s*(?:$|;)/i.test(t)?e(this.msToBlob()):(a=Array.prototype.slice.call(arguments,1),n=(a=this[o].apply(this,a)).indexOf(","),i=a.substring(n+1),a=r.test(a.substring(0,n)),Blob.fake?((s=new Blob).encoding=a?"base64":"URI",s.data=i,s.size=i.length):h&&(s=a?new Blob([function(e){for(var t,n,i=e.length,a=new h(i/4*3|0),s=0,r=0,o=[0,0],l=0,u=0;i--;)n=e.charCodeAt(s++),255!==(t=c[n-43])&&void 0!==t&&(o[1]=o[0],o[0]=n,u=u<<6|t,4===++l)&&(a[r++]=u>>>16,61!==o[1]&&(a[r++]=u>>>8),61!==o[0]&&(a[r++]=u),l=0);return a}(i)],{type:t}):new Blob([decodeURIComponent(i)],{type:t})),e(s))}),!t.toBlobHD&&t.toDataURLHD?t.toBlobHD=function(){o="toDataURLHD";var e=this.toBlob();return o="toDataURL",e}:t.toBlobHD=t.toBlob)}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this);var saveAs=saveAs||function(o){"use strict";var l,u,c,h,d,p,t,g,f,i,e;if(!(void 0===o||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent)))return e=o.document,l=function(){return o.URL||o.webkitURL||o},u=e.createElementNS("http://www.w3.org/1999/xhtml","a"),c="download"in u,h=/constructor/i.test(o.HTMLElement)||o.safari,d=/CriOS\/[\d]+/.test(navigator.userAgent),p=function(e){(o.setImmediate||o.setTimeout)(function(){throw e},0)},t=4e4,g=function(e){setTimeout(function(){"string"==typeof e?l().revokeObjectURL(e):e.remove()},t)},f=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},e=(i=function(e,n,t){t||(e=f(e));var i,a,s=this,t="application/octet-stream"===e.type,r=function(){for(var e=s,t="writestart progress write writeend".split(" "),n=void 0,i=(t=[].concat(t)).length;i--;){var a=e["on"+t[i]];if("function"==typeof a)try{a.call(e,n||e)}catch(e){p(e)}}};s.readyState=s.INIT,c?(i=l().createObjectURL(e),setTimeout(function(){var e,t;u.href=i,u.download=n,e=u,t=new MouseEvent("click"),e.dispatchEvent(t),r(),g(i),s.readyState=s.DONE})):(d||t&&h)&&o.FileReader?((a=new FileReader).onloadend=function(){var e=d?a.result:a.result.replace(/^data:[^;]*;/,"data:attachment/file;");o.open(e,"_blank")||(o.location.href=e),s.readyState=s.DONE,r()},a.readAsDataURL(e),s.readyState=s.INIT):(i=i||l().createObjectURL(e),!t&&o.open(i,"_blank")||(o.location.href=i),s.readyState=s.DONE,r(),g(i))}).prototype,"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=f(e)),navigator.msSaveOrOpenBlob(e,t)}:(e.abort=function(){},e.readyState=e.INIT=0,e.WRITING=1,e.DONE=2,e.error=e.onwritestart=e.onprogress=e.onwrite=e.onabort=e.onerror=e.onwriteend=null,function(e,t,n){return new i(e,t||e.name||"download",n)})}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);function svgToPNG(e,t){null==t&&(t="structure.png");var n=window.URL||window.webkitURL||window,e=(e=$("<div>").append($("[id="+e+"] svg:eq(0)").clone()).html()).replace('xmlns="http://www.w3.org/2000/svg" xmlns:NS1="" NS1:xmlns:xlink="http://www.w3.org/1999/xlink"',""),e=new Blob([e],{type:"image/svg+xml"}),n=n.createObjectURL(e);$("body").append('<canvas display="none" id="tmpcanvas"></canvas>'),canvg("tmpcanvas",n,{renderCallback:function(){var e=document.getElementById("tmpcanvas");e.toBlob(function(e){saveAs(e,t)}),e.parentNode.removeChild(e)}})}function qmeanLocalColour(e,t){return.4<e?null==t?"rgb("+Math.round(255*(1-e)*(1/.6))+",80,"+Math.round(255*(e-.4)*(1/.6))+")":"rgba("+Math.round(255*(1-e)*(1/.6))+",80,"+Math.round(255*(e-.4)*(1/.6))+","+t+")":null==t?"rgb(255,80,0)":"rgba(255,80,0,"+t+")"}function drawQMEANLocal(e,f,m,v,t,b,y=200,n=void 0,_){var i,w,x=b?"qmb":"qm",M=chainMapping.structures[e],C="lq-chart"+(m=m?"-"+m:"");if(!n&&(n=[C+"-thumb","lq-chart"+m],1<Object.keys(M).length))for(let e=0;e<Object.keys(M).length;e++)n.push(C+"-"+Object.keys(M)[e]);for(i of n){var a=document.getElementById(i);if(a){if(!t&&null!==a.querySelector("svg"))return;for(;a.firstChild;)a.removeChild(a.firstChild)}else{$("body").append(`<div id="${i}" style="display:none"></div>`);let e=i;i.includes("-thumb")&&(e=e.replace("-thumb","")),document.querySelector(`a[href="#${e}"]`)||$("body").append(`<a href="#${e}" rel="lq${m}" class="fancybox"/>`)}}for(w of n){var P=w.includes("-thumb");let a,s=0,r=0,o=0,l,u,e=!1;if(P){if($("#"+w).attr("title","Click to enlarge"),l=$("#"+w).closest(":visible").width(),u=$("#"+w).closest(":visible").height(),void 0===l||void 0===u)return;(u=0===u?Math.min(y,.5*l):u)>=y?(a=12,s=45,r=30,o=40,e=!0):(v&&(s=30,r=16),a=Math.max(15,u/10))}else a=20,s=45,r=30,o=40,l=_?_.width:.7*$(window).width()+s,u=_?_.height-o-r:.7*$(window).height()+o+r;var k=Raphael(w,l,u);let c=99999,h=0,n=0,i=0,d=999,p=0;var E=Object.keys(M);for(let t=0;t<E.length;t++)if(P||w===C||w.endsWith("-"+E[t]))for(let e=0;e<M[E[t]].length;e++)M[E[t]][e]&&M[E[t]][e][x]&&(d=Math.min(d,M[E[t]][e][x]),p=Math.max(p,M[E[t]][e][x]),c=Math.min(M[E[t]][e].resno,c),h=Math.max(M[E[t]][e].resno,h),i+=1,n+=M[E[t]][e][x]);var L=p<=1;let g=1;d=L?Math.min(.3,d):(g=100,Math.min(70,d)),null==f&&(f=n/i),$("#avgLocalQMEAN,#avgLocalScore_"+m).html(isNaN(f)?"-":f.toFixed(2));var R=u-o-r,A=(l-s)/(h-c+1);if(k.rect(0,0,l,u).attr({fill:"#FFF",stroke:"#FFF"}),P&&!e)k.rect(s,r,l-s,R).attr({stroke:"#DDD"}),v&&(k.text(l/2,8,"Local Quality Estimate").attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,u/24)}),k.text(6,u/2+r/2,"Predicted Local").attr({"text-anchor":"middle",fill:"#666","font-size":Math.max(8,u/26)}).rotate(270,6,u/2+r/2),k.text(18,u/2+r/2,"Similarity to Target").attr({"text-anchor":"middle",fill:"#666","font-size":Math.max(8,u/26)}).rotate(270,18,u/2+r/2));else{k.rect(s,r,l-s,R).attr({stroke:"#DDD"});let t=14,e="Local Quality Estimate",n=(b&&(e+=" (QMEANBrane) "),!P&&1<E.length&&(w===C?e+=" - All Chains":e+=" - Chain "+w.substring(w.lastIndexOf("-")+1)),k.text(l/2,10,e).attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,u/26)}),P?(k.text(6,u/2,"Predicted Local").attr({"text-anchor":"middle",fill:"#666","font-size":a}).rotate(270,6,u/2),k.text(18,u/2,"Similarity to Target").attr({"text-anchor":"middle",fill:"#666","font-size":a}).rotate(270,18,u/2),t=.8*a):k.text(10,u/2,"Predicted Local Similarity to Target").attr({dy:10,"text-anchor":"middle",fill:"#666","font-size":a}).rotate(270,10,u/2),k.text(s+(l-s)/2,u-8,"Residue Number").attr({"text-anchor":"middle",fill:"#666","font-size":a}),null);for(let e=g;e>=d;e-=L?.1:10){k.path("M"+s+" "+(R/(g-d)*(g-e)+r)+"L"+(s-5)+" "+(R/(g-d)*(g-e)+r)).attr({stroke:"#CCC","stroke-width":1});var S=R/(g-d)*(g-e)+r;(!S||n+t<S)&&(k.text(s-12,S,e.toFixed(L?1:0)).attr({fill:"#444","font-size":t}),n=S)}var B,q,I=Math.floor((h-c)/8);I-=I%10,I=Math.max(10,I);let i=null;for(let e=c;e<h;e++)e%I==0&&(B=s+(e-c)/(h-c)*(l-s),i&&i>B||(q=k.text(B,u-o+12,e).attr({fill:"#444","font-size":t}),i=B+q.getBBox().width))}var T=["#999999","#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7"];let t=0;for(let i=0;i<E.length;i++)if(P||w===C||w.endsWith("-"+E[i])){let n=null;var V=P&&1<E.length||!P&&1<E.length&&w===C,N=R/(g-Math.min(d,f))*(g-f)+r;for(let t=0;t<M[E[i]].length;t++)if(M[E[i]][t]&&null!=M[E[i]][t][x]){var D,O=M[E[i]][t][x],G=s+A*(M[E[i]][t].resno-c);let e=N-R/(g-d)*(O-f);V?(e=Math.min(e,R+r),null==n?n=`M${G} `+e:n+=`L${G} `+e,n+=`L${G+A} `+e):(bar=f<O?k.rect(G,e,A,R/(g-d)*(O-f)):(D=R/(g-d)*(f-O),D=Math.min(D,R-N+r),k.rect(G,N,A,D)),G=qmeanLocalColour(L?O:O/100),bar.attr({stroke:G,"stroke-width":.7,fill:G,"fill-opacity":.4}))}1<E.length&&(P||w===C)&&((n=k.path(n)).attr({stroke:T[t],"stroke-width":P?1:1.5}),P||$("#"+w).append(`${0===i?"<br>Key: ":""} <span style="margin-right:4px; color:${T[t]}">Chain ${E[i]};</span>`)),t=++t%T.length}}}function drawQMEANGlobal(a,e,t,f,n){var s=$("#qn-chart"+(t?"-"+t:"")+"-thumb,#qn-chart"+(t?"-"+t:""));if(a){var r="qmeanGlobalTbl"+(t||"");if(n||!(0<$("#"+r+" tr").length)){s.empty(),$("#"+r+" tr").remove(),a.QMEAN4&&(a.qmean4_norm_score=a.qmean4_norm,delete a.qmean4_norm,a.qmean4_z_score=a.QMEAN4,delete a.QMEAN4,a.cbeta_z_score=a.cbeta,delete a.cbeta,a.interaction_z_score=a.all_atom,delete a.all_atom,a.packing_z_score=a.solvation,delete a.solvation,a.torsion_z_score=a.torsion,delete a.torsion),a.qmean4&&(a.qmean4_norm_score=parseFloat(a.qmean4.norm),a.qmean4_z_score=parseFloat(a.qmean4.zscore),delete a.qmean4,a.cbeta_z_score=parseFloat(a.cbeta.zscore),delete a.cbeta,a.interaction_z_score=parseFloat(a.all_atom.zscore),delete a.all_atom,a.packing_z_score=parseFloat(a.solvation.zscore),delete a.solvation,a.torsion_z_score=parseFloat(a.torsion.zscore),delete a.torsion,delete a.acc_agreement,delete a.ss_agreement,delete a.qmean6);var o=[["qmean4_z_score","QMEAN"],["cbeta_z_score","C"],["interaction_z_score","All Atom"],["packing_z_score","solvation"],["torsion_z_score","torsion"]];let t="";for(let e=0;e<o.length;e++)null!=a[o[e][0]]&&(t+='<tr><td width="1">'+o[e][1]+'</td><td width="100%" style="padding:0px 2px 0px 2px;"><div id="'+r+"_"+o[e][0]+'">&nbsp;</div></td><td width="1" nowrap="nowrap" style="text-align:right">'+a[o[e][0]].toFixed(2)+"</td></tr>");$("#"+r).append(t);let n=$("#"+r+"_"+o[0][0]).innerWidth(),i=$("#"+r+"_"+o[0][0]).parent().innerHeight();(n<1||i<1)&&(n=290,i=20);for(let e=0;e<o.length;e++)$("#"+r+"_"+o[e][0]).html("");var l=n/8;for(let e=0;e<o.length;e++)if(null!=a[o[e][0]]){var u,c=Raphael(r+"_"+o[e][0],n,i),h=(c.rect(0,0,n,i).attr({fill:"0-rgb(245,61,61)-#fff:75-rgb(77,77,255)"}),i/4);for(let e=1;e<8;e++)c.path("M"+l*e+" 0L"+l*e+" "+h).attr({stroke:"#555"}),c.path("M"+l*e+" "+(i-h)+"L"+l*e+" "+i).attr({stroke:"#555"});a&&(u=a[o[e][0]],u=Math.min(u,1.95),u=Math.max(u,-5.95),c.path("M"+(l*u+6*l)+" 0L"+(l*u+6*l)+" "+i).attr({stroke:"#222","stroke-width":3}))}let d=a.qmean4_norm_score,p=Math.min(600,e),g=!0;s.each(function(e,t){let n,i,a,s=0,r=0,o=0;g?($(this).attr("title","Click to enlarge"),340<(n=$(this).closest(":visible").width())?(a=12,s=45,r=30,o=40,n-=s,i=400/620*n-o+r):(i=.5*n,f&&(s=15,r=30),a=Math.max(15,i/10))):(a=20,s=45,r=30,o=40,n=617+s,i=398+o+r);var l=Raphael($(this).attr("id"),n,i),u=i-o-r,c=p/600*(n-s)+s,h=u-u*(d/1.5)+r;l.rect(0,0,n,i).attr({fill:"#FFF",stroke:"#FFF"}),"undefined"==typeof localQMEANNormImage?l.image("/static/images/qmean_norm.png",s,r,n-s,u):l.image(localQMEANNormImage,s,r,n-s,u),l.rect(s,r,n-s,u).attr({stroke:"#DDD"}),l.text(c,h,String.fromCharCode(9733)).attr({"text-anchor":"middle",fill:"#F44","font-size":a});if(g)f&&(l.text((n+s)/2,8,"Comparison with Non-redundant").attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,n/32)}),l.text((n+s)/2,22,"Set of PDB Structures").attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,n/32)}),l.text(6,i/2+r/2,"Normalized QMEAN4").attr({"text-anchor":"middle",fill:"#666","font-size":Math.max(8,n/32)}).rotate(270,6,i/2+r/2)),l.rect(s+1,i-Math.max(16,n/16),n-s-2,Math.max(16,n/16)).attr({fill:"#FFF","stroke-width":0}),l.text(n/2,i-8,"Protein Size (Residues)").attr({"text-anchor":"middle",fill:"#444","font-size":Math.max(8,n/32)});else{l.text((n+s)/2,10,"Comparison with Non-redundant Set of PDB Structures").attr({"text-anchor":"middle",fill:"#444","font-size":a}),l.text(10,i/2,"Normalized QMEAN4 Score").attr({"text-anchor":"middle",fill:"#666","font-size":a}).rotate(270,10,i/2),l.text(s+(n-s)/2,i-12,"Protein Size (Residues)").attr({"text-anchor":"middle",fill:"#666","font-size":a});for(let e=100;e<600;e+=100)l.text(s+e*(n-s)/600,i-o+8,e).attr({fill:"#444","font-size":14});for(let e=1.5;0<=e;e-=.5)l.text(s-12,u*(e/1.5)+r,(1.5-e).toFixed(1)).attr({fill:"#444","font-size":14})}g=!1})}}}"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});
